     1                                  ; -----------------------------------------------------------------------------
     2                                  ; \file  start.asm
     3                                  ; \note  (c) 2025 by Jens Kallup - paule32
     4                                  ;        all rights reserved.
     5                                  ;
     6                                  ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                                  ; -----------------------------------------------------------------------------
     8                                  %include 'basexx.inc'
     1                              <1> ;---------------------------------------------------
     2                              <1> ; \file  bitsXX.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ;---------------------------------------------------
     8                              <1> default rel
     9                              <1> 
    10                              <1> %define IMAGEBASE    0x0000000140000000
    11                              <1> %define FILEALIGN    0x200      ; 512
    12                              <1> %define SECTALIGN    0x1000
    13                              <1> 
    14                              <1> %define IMAGE_BASE   IMAGEBASE
    15                              <1> 
     9                                  %include 'windows.inc'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  windows.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> 
     9                              <1> ; -----------------------------------------------------------------------------
    10                              <1> ; CPU machine ...
    11                              <1> ; -----------------------------------------------------------------------------
    12                              <1> %define IMAGE_FILE_MACHINE_AMD64        0x8664  ; x64
    13                              <1> %define IMAGE_FILE_MACHINE_I386         0x14c   ; Intel 386 or later
    14                              <1> %define IMAGE_FILE_MACHINE_IA64         0x200   ; Intel Itanium processor family
    15                              <1> 
    16                              <1> ; -----------------------------------------------------------------------------
    17                              <1> ; COFF + PE32 header ...
    18                              <1> ; -----------------------------------------------------------------------------
    19                              <1> %define IMAGE_FILE_RELOCS_STRIPPED      0x0001
    20                              <1> %define IMAGE_FILE_EXECUTABLE_IMAGE     0x0002
    21                              <1> %define IMAGE_FILE_LOCAL_SYMS_STRIPPED  0x0008
    22                              <1> %define IMAGE_FILE_AGGRESSIVE_WS_TRIM   0x0010
    23                              <1> %define IMAGE_FILE_LARGE_ADDRESS_AWARE  0x0020
    24                              <1> %define IMAGE_FILE_32BIT_MACHINE        0x0100
    25                              <1> %define IMAGE_FILE_DEBUG_STRIPPED       0x0200
    26                              <1> %define IMAGE_FILE_DLL                  0x2000
    27                              <1> 
    28                              <1> %define IMAGE_IS_FILE_EXE   IMAGE_FILE_EXECUTABLE_IMAGE    |                            IMAGE_FILE_LARGE_ADDRESS_AWARE
    30                              <1> ; -----------------------------------------------------------------------------
    31                              <1> %define IMAGE_IS_FILE_DLL   IMAGE_FILE_DLL                 |                            IMAGE_FILE_LARGE_ADDRESS_AWARE
    33                              <1> 
    34                              <1> ; -----------------------------------------------------------------------------
    35                              <1> ; DLL Characteristics
    36                              <1> ; -----------------------------------------------------------------------------
    37                              <1> %define IMAGE_DLLCHARACTERISTICS_NX_COMPAT  0x0100  ; Image is NX compatible.
    38                              <1> %define IMAGE_DLLCHARACTERISTICS_NO_SEH     0x0400  ; no SEH
    39                              <1> 
    40                              <1> ; -----------------------------------------------------------------------------
    41                              <1> ; win32 constants
    42                              <1> ; -----------------------------------------------------------------------------
    43                              <1> %define SW_SHADOW            32       ; 32-Byte Shadow Space pro CALL
    44                              <1> 
    45                              <1> %define WS_OVERLAPPEDWINDOW  0x00CF0000
    46                              <1> %define CW_USEDEFAULT        0x80000000
    47                              <1> %define SW_SHOWDEFAULT       10
    48                              <1> 
    49                              <1> %define IDC_ARROW            32512
    50                              <1> 
    51                              <1> %define COLOR_WINDOW         5
    52                              <1> 
    53                              <1> %define FOREGROUND_BLUE      0x0001
    54                              <1> %define FOREGROUND_GREEN     0x0002
    55                              <1> %define FOREGROUND_RED       0x0004
    56                              <1> %define FOREGROUND_INTENSITY 0x0008
    57                              <1> 
    58                              <1> ; -----------------------------------------------------------------------------
    59                              <1> ; Window Messages ...
    60                              <1> ; -----------------------------------------------------------------------------
    61                              <1> %define WM_CLOSE            0x0010
    62                              <1> %define WM_COMMAND          0x0111
    63                              <1> %define WM_ERASEBKGND       0x0014
    64                              <1> %define WM_SYSCOMMAND       0x0112
    65                              <1> 
    66                              <1> ; -----------------------------------------------------------------------------
    67                              <1> ; window style constant's ...
    68                              <1> ; -----------------------------------------------------------------------------
    69                              <1> %define SWP_FRAMECHANGED    0x0020
    70                              <1> %define SWP_NOACTIVATE      0x0010
    71                              <1> %define SWP_NOMOVE          0x0002
    72                              <1> %define SWP_NOSIZE          0x0001
    73                              <1> %define SWP_NOZORDER        0x0004
    74                              <1> %define SWP_SHOWWINDOW      0x0040
    75                              <1> 
    76                              <1> %define GWL_STYLE           -16
    77                              <1> 
    78                              <1> ; -----------------------------------------------------------------------------
    79                              <1> ; Konstanten
    80                              <1> ; -----------------------------------------------------------------------------
    81                              <1> %define WS_CAPTION           0x00C00000
    82                              <1> %define WS_MAXIMIZEBOX       0x00010000
    83                              <1> %define WS_MINIMIZEBOX       0x00020000
    84                              <1> %define WS_OVERLAPPED        0x00000000
    85                              <1> %define WS_OVERLAPPEDWINDOW  ( WS_OVERLAPPED                               | WS_CAPTION                                  | WS_SYSMENU                                  | WS_THICKFRAME                               | WS_MINIMIZEBOX                              | WS_MAXIMIZEBOX )
    91                              <1> %define WS_SIZEBOX           0x00040000    ; = WS_THICKFRAME
    92                              <1> %define WS_SYSMENU           0x00080000
    93                              <1> 
    94                              <1> %define SW_SHOWDEFAULT       10
    95                              <1> %define WS_THICKFRAME        0x00040000
    96                              <1> 
    97                              <1> %define CW_USEDEFAULT        0x80000000
    98                              <1> %define CS_HREDRAW           0x0002
    99                              <1> %define CS_VREDRAW           0x0001
   100                              <1> 
   101                              <1> ; -----------------------------------------------------------------------------
   102                              <1> ; menu flag constant's ...
   103                              <1> ; -----------------------------------------------------------------------------
   104                              <1> %define MF_BYCOMMAND         0x00000000
   105                              <1> %define MF_GRAYED            0x00000001
   106                              <1> 
   107                              <1> ; -----------------------------------------------------------------------------
   108                              <1> ; window color constant's ...
   109                              <1> ; -----------------------------------------------------------------------------
   110                              <1> %define COLOR_WINDOW         5
   111                              <1> %define GCLP_HBRBACKGROUND  -10
   112                              <1> 
   113                              <1> ; -----------------------------------------------------------------------------
   114                              <1> ; system context constant's (system menu of windows) ...
   115                              <1> ; -----------------------------------------------------------------------------
   116                              <1> %define SC_CLOSE             0xF060
   117                              <1> %define SC_MAXIMIZE          0xF030
   118                              <1> %define SC_MINIMIZE          0xF020
   119                              <1> %define SC_RESTORE           0xF120
   120                              <1> %define SC_SIZE              0xF000
   121                              <1> 
   122                              <1> ; -----------------------------------------------------------------------------
   123                              <1> ; cursor arrow id's ...
   124                              <1> ; -----------------------------------------------------------------------------
   125                              <1> %define IDC_ARROW            32512
   126                              <1> 
   127                              <1> ; -----------------------------------------------------------------------------
   128                              <1> ; Message Box's ...
   129                              <1> ; -----------------------------------------------------------------------------
   130                              <1> %define MB_OK         0x00000000
   131                              <1> %define MB_ICONERROR  0x00000010
   132                              <1> 
   133                              <1> ; -----------------------------------------------------------------------------
   134                              <1> ; text console handle's for stdin, stdout, and stderr ...
   135                              <1> ; -----------------------------------------------------------------------------
   136                              <1> %define STD_INPUT_HANDLE  -10
   137                              <1> %define STD_OUTPUT_HANDLE -11
   138                              <1> %define STD_ERROR_HANDLE  -12
   139                              <1> 
   140                              <1> ; Console mode bits (wincon.h)
   141                              <1> %define ENABLE_PROCESSED_INPUT  0x0001
   142                              <1> %define ENABLE_LINE_INPUT       0x0002
   143                              <1> %define ENABLE_ECHO_INPUT       0x0004
   144                              <1> %define ENABLE_WINDOW_INPUT     0x0008     ; optional für Window-Events (nicht nötig für KEY_EVENT)
   145                              <1> %define ENABLE_PROCESSED_INPUT  0x0001
   146                              <1> %define ENABLE_QUICK_EDIT_MODE  0x0040
   147                              <1> %define ENABLE_EXTENDED_FLAGS   0x0080
   148                              <1> 
   149                              <1> ; INPUT_RECORD.EventType
   150                              <1> %define KEY_EVENT               0x0001
   151                              <1> 
   152                              <1> ; -----------------------------------------------------------------------------
   153                              <1> ; code page constant's ...
   154                              <1> ; -----------------------------------------------------------------------------
   155                              <1> %define CP_UTF8 65001
   156                              <1> 
   157                              <1> ; -----------------------------------------------------------------------------
   158                              <1> ; constant's for the monitor ...
   159                              <1> ; -----------------------------------------------------------------------------
   160                              <1> %define MONITOR_DEFAULTTONEAREST 2
   161                              <1> 
   162                              <1> %define DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE_V2  -4   ; WinUser.h: ((DPI_AWARENESS_CONTEXT)-4)
   163                              <1> 
   164                              <1> ; Console-Mode-Flags (wincon.h)
   165                              <1> %define ENABLE_VIRTUAL_TERMINAL_PROCESSING  0x0004
   166                              <1> %define DISABLE_NEWLINE_AUTO_RETURN         0x0008    ; optional
   167                              <1> %define ENABLE_VIRTUAL_TERMINAL_INPUT       0x0200
   168                              <1> 
   169                              <1> ; -----------------------------------------------------------------------------
   170                              <1> ; DOS ANSI foreground color's   0..15
   171                              <1> ; -----------------------------------------------------------------------------
   172                              <1> %define ATTR_FG_BLACK           30
   173                              <1> %define ATTR_FG_DARK_RED        31
   174                              <1> %define ATTR_FG_DARK_GREEN      32
   175                              <1> %define ATTR_FG_DARK_YELLOW     33
   176                              <1> %define ATTR_FG_DARK_BLUE       34
   177                              <1> %define ATTR_FG_DARK_PURPLE     35
   178                              <1> %define ATTR_FG_DARK_CYAN       36
   179                              <1> %define ATTR_FG_LIGHT_GRAY      37
   180                              <1> ; -----------------------------------------------------------------------------
   181                              <1> %define ATTR_FG_DARK_GRAY       90
   182                              <1> %define ATTR_FG_LIGHT_RED       91
   183                              <1> %define ATTR_FG_LIGHT_GREEN     92
   184                              <1> %define ATTR_FG_LIGHT_YELLOW    93
   185                              <1> %define ATTR_FG_LIGHT_BLUE      94
   186                              <1> %define ATTR_FG_LIGHT_PURPLE    95
   187                              <1> %define ATTR_FG_LIGHT_CYAN      96
   188                              <1> %define ATTR_FG_WHITE           97
   189                              <1> ; -----------------------------------------------------------------------------
   190                              <1> ; DOS ANSI background color's   0..15
   191                              <1> ; -----------------------------------------------------------------------------
   192                              <1> %define ATTR_BG_BLACK           40
   193                              <1> %define ATTR_BG_DARK_RED        41
   194                              <1> %define ATTR_BG_DARK_GREEN      42
   195                              <1> %define ATTR_BG_DARK_YELLOW     43
   196                              <1> %define ATTR_BG_DARK_BLUE       44
   197                              <1> %define ATTR_BG_DARK_PURPLE     45
   198                              <1> %define ATTR_BG_DARK_CYAN       46
   199                              <1> %define ATTR_BG_LIGHT_GRAY      47
   200                              <1> ; -----------------------------------------------------------------------------
   201                              <1> %define ATTR_BG_DARK_GRAY       100
   202                              <1> %define ATTR_BG_LIGHT_RED       101
   203                              <1> %define ATTR_BG_LIGHT_GREEN     102
   204                              <1> %define ATTR_BG_LIGHT_YELLOW    103
   205                              <1> %define ATTR_BG_LIGHT_BLUE      104
   206                              <1> %define ATTR_BG_LIGHT_PURPLE    105
   207                              <1> %define ATTR_BG_LIGHT_CYAN      106
   208                              <1> %define ATTR_BG_WHITE           107
   209                              <1> 
   210                              <1> %define ATTR_DEFAULT        ATTR_BG_BLACK | ATTR_FG_GRAY   ; Hellgrau auf Schwarz
   211                              <1> 
   212                              <1> ; -----------------------------------------------------------------------------
   213                              <1> ; format flags (often used for debug messages) ...
   214                              <1> ; -----------------------------------------------------------------------------
   215                              <1> %define FORMAT_MESSAGE_ALLOCATE_BUFFER 0x00000100
   216                              <1> %define FORMAT_MESSAGE_IGNORE_INSERTS  0x00000200
   217                              <1> %define FORMAT_MESSAGE_FROM_SYSTEM     0x00001000
   218                              <1> 
   219                              <1> %define FM_FLAGS     FORMAT_MESSAGE_ALLOCATE_BUFFER |     FORMAT_MESSAGE_FROM_SYSTEM     |     FORMAT_MESSAGE_IGNORE_INSERTS
   223                              <1> 
   224                              <1> ; -----------------------------------------------------------------------------
   225                              <1> ; language support ...
   226                              <1> ; -----------------------------------------------------------------------------
   227                              <1> %define LANG_NEUTRAL    0
   228                              <1> %define SUBLANG_DEFAULT 1
   229                              <1> 
   230                              <1> ; für NASM als Zahl nutzen:
   231                              <1> LANGID_DEFAULT  equ (SUBLANG_DEFAULT << 10) | LANG_NEUTRAL
   232                              <1> 
   233                              <1> ; -----------------------------------------------------------------------------
   234                              <1> ; misc
   235                              <1> ; -----------------------------------------------------------------------------
   236                              <1> %define INFINITE                0xFFFFFFFF
   237                              <1> %define WAIT_OBJECT_0           0
    10                                  %include 'usefunc.inc'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  usefunc.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> 
     9                              <1> ; -----------------------------------------------------------------------------
    10                              <1> ; user32.dll functions ...
    11                              <1> ; -----------------------------------------------------------------------------
    12                              <1> %define USER32_FUNCS                    CreateWindowExW,                                                        DefWindowProcW,                     DispatchMessageW,                   DrawMenuBar,                                                            EnableMenuItem,                     FillRect,                                                               GetClassLongPtrW,                   GetClientRect,                      GetMessageW,                        GetMonitorInfoW,                    GetSysColorBrush,                   GetSystemMenu,                                                          GetWindowLongPtrA,                  GetWindowRect,                                                          LoadCursorW,                                                            MessageBoxA,                        MessageBoxW,                                                            MonitorFromWindow,                  MoveWindow,                                                             Register...
    53                              <1> 
    54                              <1> ; -----------------------------------------------------------------------------
    55                              <1> ; kernel32.dll functions ...
    56                              <1> ; -----------------------------------------------------------------------------
    57                              <1> %define KERNEL32_FUNCS                  lstrlenA,                                                               AllocConsole,                       ExitProcess,                                                            FormatMessageW,                                                         FillConsoleOutputAttribute,         FillConsoleOutputCharacterW,                                            GetConsoleMode,                     GetConsoleScreenBufferInfo,         GetConsoleWindow,                                                       GetCurrentConsoleFont,                                                  GetLargestConsoleWindowSize,        GetLastError,                       GetModuleHandleW,                   GetProcAddress,                     GetStdHandle,                                                           LoadLibraryA,                       LocalFree,                                                              ReadConsoleA,                       ReadConsoleInputW,                  ReadCons...
   104                              <1> 
   105                              <1> ; -----------------------------------------------------------------------------
   106                              <1> ; msvcrt.dll functions ...
   107                              <1> ; -----------------------------------------------------------------------------
   108                              <1> %define MSVCRT_FUNCS                    fgets,                              scanf,                              sprintf,                            printf, puts
    11                                  
    12                                  %include 'macros.inc'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  macros.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> 
     9                              <1> ; -----------------------------------------------------------------------------
    10                              <1> ; \brief some pre-defines, to make maintain easier ...
    11                              <1> ; -----------------------------------------------------------------------------
    12                              <1> %define ERROR_Win32API 'this macro can only be use with win32api (Windows).'
    13                              <1> 
    14                              <1> ; -----------------------------------------------------------------------------
    15                              <1> ; \brief DOS error codes for int 0x21 - 3Dh
    16                              <1> ; -----------------------------------------------------------------------------
    17                              <1> %define ERROR_INVALID_FUNCTION      0x01
    18                              <1> %define ERROR_FILE_NOT_FOUND        0x02
    19                              <1> %define ERROR_PATH_NOT_FOUND        0x03
    20                              <1> %define ERROR_TOO_MANY_OPEN_FILES   0x04
    21                              <1> %define ERROR_ACCESS_DENIED         0x05
    22                              <1> %define ERROR_INVALID_HANDLE        0x06
    23                              <1> %define ERROR_ARENA_TRASHED         0x07
    24                              <1> %define ERROR_NOT_ENOUGH_MEMORY     0x08
    25                              <1> %define ERROR_INVALID_ACCESS        0x0C
    26                              <1> %define ERROR_INVALID_DRIVE         0x0F
    27                              <1> %define ERROR_CURRENT_DIRECTORY     0x10
    28                              <1> %define ERROR_NOT_SAME_DEVICE       0x11
    29                              <1> %define ERROR_NO_MORE_FILES         0x12
    30                              <1> %define ERROR_SEEK                  0x1D
    31                              <1> %define ERROR_NOT_DOS_DISK          0x1E
    32                              <1> 
    33                              <1> ; -----------------------------------------------------------------------------
    34                              <1> ; \brief DOS file open modes ...
    35                              <1> ; -----------------------------------------------------------------------------
    36                              <1> %define DOS_READ_ONLY   0x00    ; read  only
    37                              <1> %define DOS_WRITE_ONLY  0x01    ; write only
    38                              <1> %define DOS_READWRITE   0x02    ; read/write
    39                              <1> 
    40                              <1> ; -----------------------------------------------------------------------------
    41                              <1> ; \brief DOS file seek constants ...
    42                              <1> ; -----------------------------------------------------------------------------
    43                              <1> %define SEEK_BEGIN      0x00    ; begin of file
    44                              <1> %define SEEK_SET        0x01    ; current position
    45                              <1> %define SEEK_END        0x02    ; file end
    46                              <1> 
    47                              <1> ; -----------------------------------------------------------------------------
    48                              <1> ; \brief DOS console settings ...
    49                              <1> ; -----------------------------------------------------------------------------
    50                              <1> %define ATTR_DOS_ERROR              0x0E | 0x10     ; yeloow on blue bakcground
    51                              <1> 
    52                              <1> %define MAX_ARGV        32      ; maximum count of command line arguments
    53                              <1> 
    54                              <1> %ifndef PTR16
    55                              <1> %define PTR16(sym) (sym-code16_start+0x100)
    56                              <1> %endif
    57                              <1> 
    58                              <1> %ifndef PTR64
    59                              <1> %define PTR64(sym) (IMAGE_BASE + RVA_DATA(sym))
    60                              <1> %endif
    61                              <1> 
    62                              <1> ; -----------------------------------------------------------------------------
    63                              <1> ; \brief perform a system call (in this case a DOS int 0x21 call)
    64                              <1> ; -----------------------------------------------------------------------------
    65                              <1> %macro SysCall 0
    66                              <1> %if DOS_SHELL == 1
    67                              <1>     int 0x21        ; DOS interrupt 0x21
    68                              <1> %endif
    69                              <1> %endmacro
    70                              <1> %macro VideoCall 0
    71                              <1> %if DOS_SHELL == 1
    72                              <1>     int 0x10
    73                              <1> %else
    74                              <1>     %error 'only DOS supports interrupts.'
    75                              <1> %endif
    76                              <1> %endmacro
    77                              <1> 
    78                              <1> ; -----------------------------------------------------------------------------
    79                              <1> ; add win64 abi shadow ...
    80                              <1> ; -----------------------------------------------------------------------------
    81                              <1> %macro AddShadow 0-1
    82                              <1> %if %0 == 1
    83                              <1>     sub     rsp, %1
    84                              <1> %else
    85                              <1>     sub     rsp, SW_SHADOW
    86                              <1> %endif
    87                              <1> %endmacro
    88                              <1> 
    89                              <1> ; -----------------------------------------------------------------------------
    90                              <1> ; delete added win64 abi shadow ...
    91                              <1> ; -----------------------------------------------------------------------------
    92                              <1> %macro DelShadow 0-1
    93                              <1> %if %0 == 1
    94                              <1>     add     rsp, %1
    95                              <1> %else
    96                              <1>     add     rsp, SW_SHADOW
    97                              <1> %endif
    98                              <1> %endmacro
    99                              <1> 
   100                              <1> ; -----------------------------------------------------------------------------
   101                              <1> ; MAKE_INT <Label>, <Func1>, <Func2>, ...
   102                              <1> ; -----------------------------------------------------------------------------
   103                              <1> %macro MAKE_INT 2-*
   104                              <1> %1:
   105                              <1> %assign __n %0-1
   106                              <1> %rep __n
   107                              <1>     dq RVA_IDATA(HN_win32_%2)
   108                              <1>     %rotate 1
   109                              <1> %endrep
   110                              <1>     dq 0
   111                              <1> %endmacro
   112                              <1> 
   113                              <1> ; -----------------------------------------------------------------------------
   114                              <1> ; MAKE_IAT <Label>, <Func1>, <Func2>, ...
   115                              <1> ; -----------------------------------------------------------------------------
   116                              <1> %macro MAKE_IAT 2-*
   117                              <1> iat_win32_%1:
   118                              <1> %assign __n %0-1
   119                              <1> %rep __n
   120                              <1> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <1>     %rotate 1
   122                              <1> %endrep
   123                              <1>     dq 0
   124                              <1> %endmacro
   125                              <1> 
   126                              <1> ; -----------------------------------------------------------------------------
   127                              <1> ; HNSTR <Func1>, <Func2>, ...
   128                              <1> ; -----------------------------------------------------------------------------
   129                              <1> %macro HNSTR 1-*
   130                              <1> %assign __n %0
   131                              <1> %rep __n
   132                              <1> HN_win32_%1: dw 0
   133                              <1>     db %str(%1), 0
   134                              <1> %rotate 1
   135                              <1> %endrep
   136                              <1> %endmacro
   137                              <1> 
   138                              <1> ; -----------------------------------------------------------------------------
   139                              <1> ; MAKE_IMPORT <dir_label>, <mod1>, <mod2>, ...
   140                              <1> ; erzeugt:
   141                              <1> ; dir_label:
   142                              <1> ;   dd RVA_IDATA(INT_<mod>), 0,0, RVA_IDATA(dll_<mod>), RVA_IDATA(iat_<mod>) ...
   143                              <1> ;   dd 0,0,0,0,0
   144                              <1> ; dir_label_end:
   145                              <1> ; -----------------------------------------------------------------------------
   146                              <1> %macro MAKE_IMPORT 1-*
   147                              <1>     %define __DIR %1
   148                              <1>     %1:
   149                              <1>     %assign __n %0-1
   150                              <1>     %rep __n
   151                              <1>         dd RVA_IDATA(INT_win32_%2)
   152                              <1>         dd 0,0
   153                              <1>         dd RVA_IDATA(dll_win32_%2)
   154                              <1>         dd RVA_IDATA(iat_win32_%2)
   155                              <1>         %rotate 1
   156                              <1>     %endrep
   157                              <1>         dd 0,0,0,0,0
   158                              <1>     __DIR %+ _end:
   159                              <1>     %undef __DIR
   160                              <1> %endmacro
   161                              <1> 
   162                              <1> ; -----------------------------------------------------------------------------
   163                              <1> ; mini helper ...
   164                              <1> ; -----------------------------------------------------------------------------
   165                              <1> %macro WIN64_PROLOG 0
   166                              <1>     mov rbp, rsp
   167                              <1>     and rsp, -16
   168                              <1>     AddShadow 32         ; Shadow Space
   169                              <1> %endmacro
   170                              <1> 
   171                              <1> %macro CALL_IAT 1        ; CALL_IAT ExitProcess / RegisterClassExW / ...
   172                              <1>     AddShadow
   173                              <1>     mov     rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   174                              <1>     call    [rax]
   175                              <1>     DelShadow
   176                              <1> %endmacro
   177                              <1> 
   178                              <1> ; -----------------------------------------------------------------------------
   179                              <1> ; zero register's
   180                              <1> ; -----------------------------------------------------------------------------
   181                              <1> %macro Zero 1
   182                              <1>     xor %1, %1
   183                              <1> %endmacro
   184                              <1> 
   185                              <1> ; -----------------------------------------------------------------------------
   186                              <1> ; UTF-16LE aus ASCII (<=0x7F) schnell schreiben
   187                              <1> ; -----------------------------------------------------------------------------
   188                              <1> %ifndef WSTR_DEBUG
   189                              <1>     %define WSTR_DEBUG 0
   190                              <1> %endif
   191                              <1> 
   192                              <1> ; -----------------------------------------------------------------------------
   193                              <1> ; WSTR <name>, <items...>
   194                              <1> ; items: Strings ("..."), Zahlen (123, 0x41) oder Ausdrücke/Labels
   195                              <1> ; erzeugt:
   196                              <1> ;   _cW_<name>:              dw ... , 0
   197                              <1> ;   _cW_<name>_end:
   198                              <1> ;   _cW_<name>_length_bytes  equ (_cW_<name>_end - _cW_<name> - 2) ; ohne Terminator
   199                              <1> ;   _cW_<name>_length_words  equ (_cW_<name>_length_bytes/2)
   200                              <1> ; -----------------------------------------------------------------------------
   201                              <1> %macro WSTR 2+
   202                              <1>     %push WSTR
   203                              <1> 
   204                              <1>     ; Namen sichern, damit %rotate keine Probleme macht
   205                              <1>     %define _WSTR_LBL   _cW_%1
   206                              <1>     %define _WSTR_END   _cW_%1_end
   207                              <1>     %define _WSTR_LENB  _cW_%1_length_bytes
   208                              <1>     %define _WSTR_LENW  _cW_%1_length_words
   209                              <1> 
   210                              <1> _WSTR_LBL:
   211                              <1>     ; restliche Argumente abarbeiten
   212                              <1>     %assign %$nargs %0-1
   213                              <1>     %rotate 1
   214                              <1> 
   215                              <1>     %rep %$nargs
   216                              <1>         %ifstr %1
   217                              <1>             %strlen %$n %1
   218                              <1>             %assign %$i 0
   219                              <1>             %rep %$n
   220                              <1>                 %substr %$c %1 %$i+1,1
   221                              <1>                 dw %$c                      ; eine 16-bit Code Unit 0x00xx
   222                              <1>                 %assign %$i %$i+1
   223                              <1>             %endrep
   224                              <1>         %elifnum %1
   225                              <1>             dw %1                           ; Zahl/Konstante
   226                              <1>         %else
   227                              <1>             dw %1                           ; Label/Equate/Expression
   228                              <1>         %endif
   229                              <1>         %rotate 1
   230                              <1>     %endrep
   231                              <1> 
   232                              <1>     dw 0                                    ; Null-Terminator (1 Word)
   233                              <1> 
   234                              <1> _WSTR_END:
   235                              <1> _WSTR_LENB  equ (_WSTR_END - _WSTR_LBL - 2) ; Länge in BYTES (ohne Terminator)
   236                              <1> _WSTR_LENW  equ (_WSTR_LENB/2)              ; Länge in WORDS
   237                              <1> 
   238                              <1>     ; Aufräumen
   239                              <1>     %undef _WSTR_LBL
   240                              <1>     %undef _WSTR_END
   241                              <1>     %undef _WSTR_LENB
   242                              <1>     %undef _WSTR_LENW
   243                              <1>     %pop
   244                              <1> %endmacro
   245                              <1> ; -----------------------------------------------------------------------------
   246                              <1> ; WSTRU <name>, <items...>
   247                              <1> ; items:
   248                              <1> ;   - "ASCII/Latin-1-Strings"  -> jedes Zeichen als 16-bit Code Unit 0x00xx
   249                              <1> ;   - Zahlen/Expressions        -> als Unicode-Codepoint interpretiert:
   250                              <1> ;                                 <=0xFFFF (außer Surrogatbereich) -> 1 Word
   251                              <1> ;                                 >0xFFFF -> Surrogatpaar (2 Words)
   252                              <1> ; erzeugt:
   253                              <1> ;   _cW_<name>:              dw ..., 0
   254                              <1> ;   _cW_<name>_end:
   255                              <1> ;   _cW_<name>_length_bytes  equ (_cW_<name>_end - _cW_<name> - 2) ; ohne Terminator
   256                              <1> ;   _cW_<name>_length_words  equ (_cW_<name>_length_bytes/2)
   257                              <1> ; -----------------------------------------------------------------------------
   258                              <1> ; --- Helper: einen Unicode-Codepoint als UTF-16 ausgeben ---
   259                              <1> ; -----------------------------------------------------------------------------
   260                              <1> %macro __WSTR_EMIT_CP 1
   261                              <1>     %assign __cp (%1)
   262                              <1> 
   263                              <1>     %if __cp < 0
   264                              <1>         %error "WSTR: negativer Codepoint"
   265                              <1>     %elif __cp <= 0xFFFF
   266                              <1>         ; verbiete explizite Surrogat-Codepoints
   267                              <1>         %if __cp >= 0xD800 && __cp <= 0xDFFF
   268                              <1>             %error "WSTR: Codepoint im Surrogatbereich ist ungueltig"
   269                              <1>         %else
   270                              <1>             dw __cp
   271                              <1>         %endif
   272                              <1>     %elif __cp <= 0x10FFFF
   273                              <1>         %assign __tmp (__cp - 0x10000)
   274                              <1>         %assign __hi  (0xD800 + (__tmp >> 10))
   275                              <1>         %assign __lo  (0xDC00 + (__tmp & 0x3FF))
   276                              <1>         dw __hi, __lo
   277                              <1>     %else
   278                              <1>         %error "WSTR: Codepoint > U+10FFFF"
   279                              <1>     %endif
   280                              <1> %endmacro
   281                              <1> 
   282                              <1> ; --- Hauptmakro ---
   283                              <1> %macro WSTRU 2+
   284                              <1>     %push WSTRU
   285                              <1> 
   286                              <1>     %define _WSTR_LBL   _cW_%1
   287                              <1>     %define _WSTR_END   _cW_%1_end
   288                              <1>     %define _WSTR_LENB  _cW_%1_length_bytes
   289                              <1>     %define _WSTR_LENW  _cW_%1_length_words
   290                              <1> 
   291                              <1> _WSTR_LBL:
   292                              <1>     %assign %$nargs %0-1
   293                              <1>     %rotate 1
   294                              <1> 
   295                              <1>     %rep %$nargs
   296                              <1>         %ifstr %1
   297                              <1>             ; String: byteweise -> 0x00xx
   298                              <1>             %strlen %$n %1
   299                              <1>             %assign %$i 0
   300                              <1>             %rep %$n
   301                              <1>                 %substr %$c %1 %$i+1,1
   302                              <1>                 dw %$c
   303                              <1>                 %assign %$i %$i+1
   304                              <1>             %endrep
   305                              <1>         %elifnum %1
   306                              <1>             ; Zahl/Expression als Unicode-Scalar
   307                              <1>             __WSTR_EMIT_CP %1
   308                              <1>         %else
   309                              <1>             ; Label/Expression, zur Sicherheit ebenfalls als Codepoint behandeln
   310                              <1>             __WSTR_EMIT_CP %1
   311                              <1>         %endif
   312                              <1>         %rotate 1
   313                              <1>     %endrep
   314                              <1> 
   315                              <1>     dw 0
   316                              <1> 
   317                              <1> _WSTR_END:
   318                              <1> _WSTR_LENB  equ (_WSTR_END - _WSTR_LBL - 2)
   319                              <1> _WSTR_LENW  equ (_WSTR_LENB/2)
   320                              <1> 
   321                              <1>     %undef _WSTR_LBL
   322                              <1>     %undef _WSTR_END
   323                              <1>     %undef _WSTR_LENB
   324                              <1>     %undef _WSTR_LENW
   325                              <1>     %pop
   326                              <1> %endmacro
   327                              <1> 
   328                              <1> ; -----------------------------------------------------------------------------
   329                              <1> ; WSTRUL  <name>, <args...>   -> definiert <name> und <name>_len
   330                              <1> ; (in Codeunits, ohne Null)
   331                              <1> ; -----------------------------------------------------------------------------
   332                              <1> %macro WSTR_AND_LEN 2-*
   333                              <1>     %push WSTRUL
   334                              <1>     %define %$name %1
   335                              <1> %1:
   336                              <1>     WSTRU %2
   337                              <1> %$name %+ _end:
   338                              <1>     %xdefine %$name %+ _len ( ((%$name %+ _end) - (%$name))/2 - 1 )
   339                              <1>     %pop
   340                              <1> %endmacro
   341                              <1> 
   342                              <1> ; -----------------------------------------------------------------------------
   343                              <1> ; Nach JEDEM vorhandenen Stringlabel einfach:
   344                              <1> ;   <label>_end:   (direkt nach dem String)
   345                              <1> ; und dann:
   346                              <1> ; -----------------------------------------------------------------------------
   347                              <1> %macro WSTR_LENGTH 1
   348                              <1>     %xdefine %1_len ( ((%1_end) - (%1))/2 - 1 )
   349                              <1> %endmacro
   350                              <1> 
   351                              <1> %macro AWSTR 1
   352                              <1> %push
   353                              <1> %strlen __n %1
   354                              <1> %assign __i 0
   355                              <1> %rep __n
   356                              <1>     %substr __c %1 __i+1,1
   357                              <1>     dw __c
   358                              <1>     %assign __i __i+1
   359                              <1> %endrep
   360                              <1>     dw 0
   361                              <1> %pop
   362                              <1> %endmacro
   363                              <1> 
   364                              <1> ; -----------------------------------------------------------------------------
   365                              <1> ; \brief String-Definition mit auto *_length (ohne 0-Byte)
   366                              <1> ; \desc  section .data
   367                              <1> ;        ZSTR cap2A, "Hallo", 13, 10
   368                              <1> ;
   369                              <1> ;        ergibt automatisch:
   370                              <1> ;        cap2A          db "Hallo",13,10,0
   371                              <1> ;        cap2A_end:
   372                              <1> ;        %define cap2A_length (cap2A_end - cap2A - 1)
   373                              <1> ; -----------------------------------------------------------------------------
   374                              <1> %macro ASTR 2+                    ; ASTR <name>, <bytes...>
   375                              <1> _cA_%1:       db %2, 0
   376                              <1> _cA_%1_end:
   377                              <1> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
   378                              <1> %endmacro
   379                              <1> 
   380                              <1> ; -----------------------------------------------------------------------------
   381                              <1> ; \brief set the string label from %2 to register %1 ...
   382                              <1> ; -----------------------------------------------------------------------------
   383                              <1> %macro GETEXT 2
   384                              <1>     mov     %1, IMAGE_BASE
   385                              <1>     add     %1, RVA_DATA(_cW_%2)
   386                              <1> %endmacro
   387                              <1> 
   388                              <1> ; ------------------------------------------------------------
   389                              <1> ; ---- RVA-Helfer: bleibt wie bei dir ----
   390                              <1> ; %define RVA_DATA(L)   (DATA_VA  + ((L) - data_start))
   391                              <1> ; ------------------------------------------------------------
   392                              <1> ; Optional: einfacher Alias ohne Klammern/EXPR:
   393                              <1> ; ------------------------------------------------------------
   394                              <1> %imacro DATA_ABS 1
   395                              <1>     IMAGE_BASE + RVA_DATA(%1)
   396                              <1> %endmacro
   397                              <1> ; ------------------------------------------------------------
   398                              <1> ; Helfer: absolute VA einer Data-Variable bauen
   399                              <1> ; ------------------------------------------------------------
   400                              <1> %macro DATA_PTR 1
   401                              <1>     (IMAGE_BASE + RVA_DATA(%1))
   402                              <1> %endmacro
   403                              <1> ; ---------------------------------------------------------------------------
   404                              <1> ;; SETDATA <name>, <src> [, <size>]
   405                              <1> ;  - Schreibt <src> an Datenlabel <name>
   406                              <1> ;  - Wenn <size> fehlt, wird die Größe aus <src>-Register abgeleitet
   407                              <1> ;    (al/ax/eax/rax → 8/16/32/64 Bit). Bei Immediate bitte <size> angeben.
   408                              <1> ;  - <size> darf BYTE/WORD/DWORD/QWORD oder 8/16/32/64 sein.
   409                              <1> ; ---------------------------------------------------------------------------
   410                              <1> ;; Beispiele:
   411                              <1> ; last_error: dd 0
   412                              <1> ; orig_attr:  dw 0
   413                              <1> ; flag8:      db 0
   414                              <1> ; ---------------------------------------------------------------------------
   415                              <1> ;; schreiben (Registergröße bestimmt Breite)
   416                              <1> ; mov   eax, 0xDEADBEEF
   417                              <1> ; SETDATA last_error, eax          ; dword write
   418                              <1> ; ---------------------------------------------------------------------------
   419                              <1> ;; schreiben (Immediate -> Größe angeben)
   420                              <1> ; SETDATA orig_attr, 0x000F, WORD  ; word write
   421                              <1> ; SETDATA flag8,     1,      BYTE  ; byte write
   422                              <1> ; ---------------------------------------------------------------------------
   423                              <1> ;; lesen (Registergröße passt)
   424                              <1> ; GETDATA eax, last_error          ; dword read → eax
   425                              <1> ; ---------------------------------------------------------------------------
   426                              <1> ;; lesen (Größe erzwingen)
   427                              <1> ; GETDATA ax,  orig_attr, WORD     ; word read → ax
   428                              <1> ; GETDATA al,  flag8,     BYTE     ; byte read → al
   429                              <1> ; ---------------------------------------------------------------------------
   430                              <1> %macro SETDATA 2-3
   431                              <1>     push    rdx
   432                              <1>     mov     rdx, IMAGE_BASE
   433                              <1>     add     rdx, RVA_DATA(%1)
   434                              <1>     %if %0 = 2
   435                              <1>         mov     [%2], rdx
   436                              <1>         pop     rdx
   437                              <1>     %else
   438                              <1>         pop     rdx
   439                              <1>       %ifidni %3, BYTE
   440                              <1>         mov     byte  [rdx], %2
   441                              <1>       %elifidni %3, WORD
   442                              <1>         mov     word  [rdx], %2
   443                              <1>       %elifidni %3, DWORD
   444                              <1>         mov     dword [rdx], %2
   445                              <1>       %elifidni %3, QWORD
   446                              <1>         mov     qword [rdx], %2
   447                              <1>       %elif %3 = 8
   448                              <1>         mov     byte  [rdx], %2
   449                              <1>       %elif %3 = 16
   450                              <1>         mov     word  [rdx], %2
   451                              <1>       %elif %3 = 32
   452                              <1>         mov     dword [rdx], %2
   453                              <1>       %elif %3 = 64
   454                              <1>         mov     qword [rdx], %2
   455                              <1>       %else
   456                              <1>         %error "SETDATA: 3rd arg must be BYTE/WORD/DWORD/QWORD or 8/16/32/64"
   457                              <1>       %endif
   458                              <1>     %endif
   459                              <1> %endmacro
   460                              <1> 
   461                              <1> ; ------------------------------------------------------------
   462                              <1> ; GETDATA <dst>, <name> [, <size>]
   463                              <1> ;  - Liest aus Datenlabel <name> in Register <dst>
   464                              <1> ;  - Wenn <size> fehlt, muss <dst> die passende Größe haben
   465                              <1> ;    (al/ax/eax/rax). Sonst <size> angeben (BYTE/WORD/DWORD/QWORD oder 8/16/32/64).
   466                              <1> ; ------------------------------------------------------------
   467                              <1> %macro GETDATA 2-3
   468                              <1>     mov     %1, IMAGE_BASE
   469                              <1>     add     %1, RVA_DATA(%2)
   470                              <1>     %if %0 = 2
   471                              <1>         ;mov     %1, [rdx]
   472                              <1>     %else
   473                              <1>       %ifidni %3, BYTE
   474                              <1>         mov     %1, byte  [rdx]
   475                              <1>       %elifidni %3, WORD
   476                              <1>         mov     %1, word  [rdx]
   477                              <1>       %elifidni %3, DWORD
   478                              <1>         mov     %1, dword [rdx]
   479                              <1>       %elifidni %3, QWORD
   480                              <1>         mov     %1, qword [rdx]
   481                              <1>       %elif %3 = 8
   482                              <1>         mov     %1, byte  [rdx]
   483                              <1>       %elif %3 = 16
   484                              <1>         mov     %1, word  [rdx]
   485                              <1>       %elif %3 = 32
   486                              <1>         mov     %1, dword [rdx]
   487                              <1>       %elif %3 = 64
   488                              <1>         mov     %1, qword [rdx]
   489                              <1>       %else
   490                              <1>         %error "GETDATA: 3rd arg must be BYTE/WORD/DWORD/QWORD or 8/16/32/64"
   491                              <1>       %endif
   492                              <1>     %endif
   493                              <1> %endmacro
   494                              <1> 
   495                              <1> %macro Return 0-1
   496                              <1> %if %0 == 1
   497                              <1>     mov eax, %1
   498                              <1> %else
   499                              <1>     ret
   500                              <1> %endif
   501                              <1> %endmacro
   502                              <1> 
   503                              <1> ; -----------------------------------------------------------------------------
   504                              <1> ; condition jump's after function call -> test eax, eax
   505                              <1> ; -----------------------------------------------------------------------------
   506                              <1> %macro CHECK_NZ 1-2
   507                              <1> %if %0 == 2
   508                              <1>     test eax, eax
   509                              <1>     jnz %1
   510                              <1>     jmp %2
   511                              <1> %else
   512                              <1>     test eax, eax
   513                              <1>     jnz %1
   514                              <1> %endif
   515                              <1> %endmacro
   516                              <1> 
   517                              <1> ; -----------------------------------------------------------------------------
   518                              <1> %macro CHECK_NE 1-2
   519                              <1> %if %0 == 2
   520                              <1>     test eax, eax
   521                              <1>     jne %1
   522                              <1>     jmp %2
   523                              <1> %else
   524                              <1>     test eax, eax
   525                              <1>     jne %1
   526                              <1> %endif
   527                              <1> %endmacro
   528                              <1> 
   529                              <1> ; -----------------------------------------------------------------------------
   530                              <1> %macro CHECK_E 1-2
   531                              <1> %if %0 == 2
   532                              <1>     test eax, eax
   533                              <1>     je  %1
   534                              <1>     jmp %2
   535                              <1> %else
   536                              <1>     test eax, eax
   537                              <1>     je  %1
   538                              <1> %endif
   539                              <1> %endmacro
   540                              <1> 
   541                              <1> ; -----------------------------------------------------------------------------
   542                              <1> ; \brief prolog of a assembler routine + 32 Windows 64 Bit shadow
   543                              <1> ; \param optional shadow at start -> int
   544                              <1> ; -----------------------------------------------------------------------------
   545                              <1> %macro FUNC_ENTER 0-1
   546                              <1> %if %0 == 1
   547                              <1>     AddShadow %1
   548                              <1> %else
   549                              <1>     AddShadow
   550                              <1> %endif
   551                              <1>     push    rbp
   552                              <1>     mov     rbp, rsp
   553                              <1> %endmacro
   554                              <1> 
   555                              <1> ; -----------------------------------------------------------------------------
   556                              <1> ; \brief epilog of a assembler routine - 32 Windows 64 Bit shadow
   557                              <1> ; \param optional shadow at end -> int
   558                              <1> ; -----------------------------------------------------------------------------
   559                              <1> %macro FUNC_LEAVE 0-1
   560                              <1> %if %0 == 1
   561                              <1>     DelShadow %1
   562                              <1> %else
   563                              <1>     DelShadow
   564                              <1> %endif
   565                              <1>     pop     rbp
   566                              <1>     ret
   567                              <1> %endmacro
   568                              <1> 
   569                              <1> ; -----------------------------------------------------------------------------
   570                              <1> ; \brief allocate/open a text console window under Windows 11 desktop.
   571                              <1> ; \param ok  -> label
   572                              <1> ; \param err -> label
   573                              <1> ; \since 1.0
   574                              <1> ;
   575                              <1> ; \return bool - 0 no Error; else Error
   576                              <1> ; -----------------------------------------------------------------------------
   577                              <1> %macro call_AllocConsole 2
   578                              <1> %if DOS_SHELL == 1
   579                              <1>     %error ERROR_Win32API
   580                              <1> %else
   581                              <1>     CALL_IAT AllocConsole
   582                              <1>     %if %0 == 2
   583                              <1>         CHECK_NZ %1, %2
   584                              <1>     %endif
   585                              <1> %endif
   586                              <1> %endmacro
   587                              <1> 
   588                              <1> ; -----------------------------------------------------------------------------
   589                              <1> ; \brief call the Windows 10 win32api function ExitProcess, to close the thread
   590                              <1> ; -----------------------------------------------------------------------------
   591                              <1> %macro call_ExitProcess 0-1
   592                              <1> %if DOS_SHELL == 1
   593                              <1>     %error ERROR_Win32API
   594                              <1> %else
   595                              <1>     %if %0 == 1
   596                              <1>         mov rax, %1
   597                              <1>     %else
   598                              <1>         mov rax, 0
   599                              <1>     %endif
   600                              <1>     CALL_IAT ExitProcess
   601                              <1> %endif
   602                              <1> %endmacro
   603                              <1> 
   604                              <1> ; -----------------------------------------------------------------------------
   605                              <1> ; \brief helper function to save source code space for win32api FormatMessageW.
   606                              <1> ; -----------------------------------------------------------------------------
   607                              <1> %macro call_FormatMessageW 0
   608                              <1>     CALL_IAT FormatMessageW
   609                              <1> %endmacro
   610                              <1> 
   611                              <1> ; -----------------------------------------------------------------------------
   612                              <1> ; \brief
   613                              <1> ; -----------------------------------------------------------------------------
   614                              <1> ;macro call_GetConsoleScreenBufferInfo
   615                              <1> ;endmacro
   616                              <1> 
   617                              <1> ; -----------------------------------------------------------------------------
   618                              <1> ; \brief  this macro call the win32api function GetLastError.
   619                              <1> ; \param  nothing
   620                              <1> ; \return ExitCode - int
   621                              <1> ; -----------------------------------------------------------------------------
   622                              <1> %macro call_GetLastError 0
   623                              <1> %if DOS_SHELL == 1
   624                              <1>     %error ERROR_Win32API
   625                              <1> %else
   626                              <1>     CALL_IAT GetLastError
   627                              <1>     test rax, rax
   628                              <1>     jnz  %%ok
   629                              <1>     AddShadow
   630                              <1>     call HandleLastError
   631                              <1>     DelShadow
   632                              <1> %%ok:
   633                              <1> ;ShowMessageW ShowLastW,capW
   634                              <1> %endif
   635                              <1> %endmacro
   636                              <1> 
   637                              <1> ; -----------------------------------------------------------------------------
   638                              <1> ; \brief  get the standard output device.
   639                              <1> ; \param  ok     -> label
   640                              <1> ; \param  error  -> label
   641                              <1> ; \param  handle -> int
   642                              <1> ; \see    AllocConsole
   643                              <1> ; \since  1.0
   644                              <1> ; \return ?
   645                              <1> ; -----------------------------------------------------------------------------
   646                              <1> %macro call_GetStdHandle 3
   647                              <1> %if DOS_SHELL == 1
   648                              <1>     %error ERROR_Win32API
   649                              <1> %else
   650                              <1>     mov ecx, %3
   651                              <1>     CALL_IAT GetStdHandle
   652                              <1>     cmp   rax, -1     ; INVALID_HANDLE_VALUE ?
   653                              <1>     je    %%error     ; yes -> error
   654                              <1>     test  rax, rax    ; 0 ?
   655                              <1>     jz    %%error     ; yes -> error
   656                              <1>     ;
   657                              <1>     mov   r12, rax    ; valid handle in rax
   658                              <1>     jmp   %%ok
   659                              <1> %%error:
   660                              <1>     call HandleLastError
   661                              <1>     jmp  %2
   662                              <1> %%ok:
   663                              <1>     jmp  %1
   664                              <1> %endif
   665                              <1> %endmacro
   666                              <1> 
   667                              <1> %macro call_LoadCursorW 0
   668                              <1> %if DOS_SHELL == 1
   669                              <1>     %error ERROR_Win32API
   670                              <1> %else
   671                              <1>     CALL_IAT LoadCursorW
   672                              <1>     ;ShowMessageW ShowHelloW,capW
   673                              <1>     ;call_GetLastError
   674                              <1> %endif
   675                              <1> %endmacro
   676                              <1> 
   677                              <1> %macro call_LocalFree 0
   678                              <1> %if DOS_SHELL == 1
   679                              <1>     %error ERROR_Win32API
   680                              <1> %else
   681                              <1>     CALL_IAT MessageBoxW
   682                              <1> %endif
   683                              <1> %endmacro
   684                              <1> 
   685                              <1> ; -----------------------------------------------------------------------------
   686                              <1> ; \brief helper macro to shorten code, and call the win32api MessageBox W
   687                              <1> ; -----------------------------------------------------------------------------
   688                              <1> %macro call_MessageBoxW 0
   689                              <1>     CALL_IAT MessageBoxW
   690                              <1> %endmacro
   691                              <1> 
   692                              <1> ; -----------------------------------------------------------------------------
   693                              <1> ; \brief helper macro to shorten code, and call the win32api function wsprintfW
   694                              <1> ; -----------------------------------------------------------------------------
   695                              <1> %macro call_wsprintfW 0
   696                              <1>     CALL_IAT wsprintfW
   697                              <1> %endmacro
   698                              <1> 
   699                              <1> %macro call_WriteConsoleA 0
   700                              <1> %if DOS_SHELL == 1
   701                              <1>     %error ERROR_Win32API
   702                              <1> %else
   703                              <1>     CALL_IAT WriteConsoleA
   704                              <1> %endif
   705                              <1> %endmacro
   706                              <1> 
   707                              <1> ; -----------------------------------------------------------------------------
   708                              <1> ; \brief Write - display text on the Windows Console.
   709                              <1> ; \param 1 -> label -> on error
   710                              <1> ; \param 2 -> label -> text to display
   711                              <1> ; \param 3 -> label -> output handle; default is: STD_OUTPUT_HANDLE
   712                              <1> ; \see   AllocConsole
   713                              <1> ; \since 1.0
   714                              <1> ; -----------------------------------------------------------------------------
   715                              <1> %macro call_User_Write 2-3
   716                              <1> %if DOS_SHELL == 1
   717                              <1>     %error ERROR_Win32API
   718                              <1> %else
   719                              <1> %if %0 == 2
   720                              <1>     call_GetStdHandle %%ok, %1, STD_OUTPUT_HANDLE
   721                              <1> %else
   722                              <1>     call_GetStdHandle %%ok, %1, %3
   723                              <1> %endif
   724                              <1> %%ok:
   725                              <1>     ; --- WriteConsoleA(hOut, fmtHello, hello_len, NULL, NULL) ---
   726                              <1>     mov     rcx, r12                       ; 1. Arg: HANDLE hConsoleOutput
   727                              <1>     mov     rdx, IMAGE_BASE
   728                              <1>     add     rdx, RVA_DATA(%2)              ; 2. Arg: LPCVOID lpBuffer
   729                              <1>     mov     r8d, %2_length                 ; 3. Arg: DWORD nNumberOfCharsToWrite
   730                              <1>     xor     r9d, r9d                       ; lpNumberOfCharsWritten = NULL
   731                              <1>     AddShadow 32 + 8
   732                              <1>     mov     qword [rsp+32], 0              ; 5. Arg: LPVOID lpReserved = NULL
   733                              <1>     call_WriteConsoleA
   734                              <1>     DelShadow 32 + 8
   735                              <1> %endif
   736                              <1> %endmacro
   737                              <1> 
   738                              <1> ; -----------------------------------------------------------------------------
   739                              <1> ; \brief read a string line in console window ...
   740                              <1> ; -----------------------------------------------------------------------------
   741                              <1> %macro call_User_ReadLn 1
   742                              <1>     call user_Console_ReadLn
   743                              <1> %endmacro
   744                              <1> 
   745                              <1> ; -----------------------------------------------------------------------------
   746                              <1> %macro DefWindowProcW 0
   747                              <1>     mov     rax, IMAGE_BASE + RVA_IDATA(IAT_win32_DefWindowProcW)
   748                              <1> %endmacro
   749                              <1> 
   750                              <1> %macro IAT_CreateWindowExW 0
   751                              <1> %if DOS_SHELL == 1
   752                              <1>     %error ERROR_Win32API
   753                              <1> %else
   754                              <1>     mov     rax, IMAGE_BASE
   755                              <1>     add     rax, RVA_IDATA(IAT_win32_CreateWindowExW)
   756                              <1>     call    [rax]
   757                              <1> %endif
   758                              <1> %endmacro
   759                              <1> ; -----------------------------------------------------------------------------
   760                              <1> 
   761                              <1> ; -----------------------------------------------------------------------------
   762                              <1> ; \brief  DispatchMessageW
   763                              <1> ; \since  1.0
   764                              <1> ; -----------------------------------------------------------------------------
   765                              <1> %macro DispatchMessageW 0
   766                              <1> %if DOS_SHELL == 1
   767                              <1>     %error ERROR_Win32API
   768                              <1> %else
   769                              <1>     mov     rcx, rsi
   770                              <1>     CALL_IAT DispatchMessageW
   771                              <1> %endif
   772                              <1> %endmacro
   773                              <1> 
   774                              <1> ; -----------------------------------------------------------------------------
   775                              <1> ; \brief  ExitProcess terminate the given application thread.
   776                              <1> ; \since  1.0
   777                              <1> ; \param  exitcode -> integer
   778                              <1> ; \return exitcode -> rax
   779                              <1> ; -----------------------------------------------------------------------------
   780                              <1> %macro ExitProcess 0-1 0
   781                              <1> %if DOS_SHELL == 1
   782                              <1>     %error ERROR_Win32API
   783                              <1> %else
   784                              <1>     nop
   785                              <1>     ;AddShadow (32 + 16)           ; Shadow Space + 16 B Align
   786                              <1>     mov     ecx,%1
   787                              <1>     CALL_IAT ExitProcess
   788                              <1>     ; no return
   789                              <1>     ;DelShadow (32 + 16)
   790                              <1> %endif
   791                              <1> %endmacro
   792                              <1> 
   793                              <1> ; -----------------------------------------------------------------------------
   794                              <1> ; \brief  GetLastError catches the last error that was occured during win32api
   795                              <1> ;         function call.
   796                              <1> ; \since  1.0
   797                              <1> ; \param  nothing
   798                              <1> ; \return ?
   799                              <1> ; -----------------------------------------------------------------------------
   800                              <1> %macro GETLASTERROR 2
   801                              <1>     test    eax, eax
   802                              <1>     %1      %2
   803                              <1> %endmacro
   804                              <1> 
   805                              <1> %macro GetLastError 0
   806                              <1> %if DOS_SHELL == 1
   807                              <1>     %error ERROR_Win32API
   808                              <1> %else
   809                              <1>     CALL_IAT GetLastError
   810                              <1> %endif
   811                              <1> %endmacro
   812                              <1> 
   813                              <1> ; -----------------------------------------------------------------------------
   814                              <1> ; \brief  GetMessageW
   815                              <1> ; -----------------------------------------------------------------------------
   816                              <1> %macro GetMessageW 0
   817                              <1> %if DOS_SHELL == 1
   818                              <1>     %error ERROR_Win32API
   819                              <1> %else
   820                              <1>     mov  rcx, rsi
   821                              <1>     Zero edx
   822                              <1>     Zero r8d
   823                              <1>     Zero r9d
   824                              <1>     CALL_IAT GetMessageW
   825                              <1> %endif
   826                              <1> %endmacro
   827                              <1> 
   828                              <1> ; -----------------------------------------------------------------------------
   829                              <1> ; \brief  LoadCursorW
   830                              <1> ; \since  1.0
   831                              <1> ; \param  id - integer: resource id
   832                              <1> ; -----------------------------------------------------------------------------
   833                              <1> %macro LoadCursorW 1
   834                              <1> %if DOS_SHELL == 1
   835                              <1>     %error ERROR_Win32API
   836                              <1> %else
   837                              <1>     Zero ecx
   838                              <1>     mov  edx, %1
   839                              <1>     CALL_IAT LoadCursorW
   840                              <1> %endif
   841                              <1> %endmacro
   842                              <1> 
   843                              <1> ; -----------------------------------------------------------------------------
   844                              <1> ; \brief  MESSAGE is a style shortner for better read expierences ...
   845                              <1> ; -----------------------------------------------------------------------------
   846                              <1> %macro MESSAGE 2
   847                              <1>     cmp     edx, %1
   848                              <1>     je      .%2
   849                              <1> %endmacro
   850                              <1> 
   851                              <1> ; -----------------------------------------------------------------------------
   852                              <1> ; \brief ShowMessageW display a wide string message on the desktop screen per
   853                              <1> ;        the wn32api.
   854                              <1> ; \since 1.0
   855                              <1> ; \see   ShowMessageA
   856                              <1> ;
   857                              <1> ; \param text_str  -> landet in rdx
   858                              <1> ; \param title_str -> landet in r8
   859                              <1> ;
   860                              <1> ; \param mb_flags  -> optional ( r9d ), default: 0 (MB_OK)
   861                              <1> ; -----------------------------------------------------------------------------
   862                              <1> %macro ShowMessageW 2-3
   863                              <1> %if DOS_SHELL == 1
   864                              <1>     %error ERROR_Win32API
   865                              <1> %else
   866                              <1>     Zero    ecx             ; hWnd = NULL
   867                              <1>     mov     rdx, PTR64(%1)  ; lpText
   868                              <1>     mov     r8,  PTR64(%2)  ; lpCaption    
   869                              <1> %if %0 == 2                 ; %0 = argument count
   870                              <1>     xor     r9d, r9d        ; uType = MB_OK
   871                              <1> %else
   872                              <1>     mov     r9d, %3         ; uType = argument exists
   873                              <1> %endif
   874                              <1>     CALL_IAT MessageBoxW
   875                              <1> %endif
   876                              <1> %endmacro
   877                              <1> 
   878                              <1> ; -----------------------------------------------------------------------------
   879                              <1> ; \brief ShowMessageA display a ansi string message on the desktop screen per
   880                              <1> ;        the wn32api.
   881                              <1> ; \since 1.0
   882                              <1> ; \see   ShowMessageW
   883                              <1> ;
   884                              <1> ; \param text_str  -> landet in rdx
   885                              <1> ; \param title_str -> landet in r8
   886                              <1> ;
   887                              <1> ; \param mb_flags  -> optional ( r9d ), default: 0 (MB_OK)
   888                              <1> ; -----------------------------------------------------------------------------
   889                              <1> %macro ShowMessageA 2-3
   890                              <1> %if DOS_SHELL == 1
   891                              <1>     %error ERROR_Win32API
   892                              <1> %else
   893                              <1>     Zero    ecx
   894                              <1>     mov     rdx, IMAGE_BASE + RVA_DATA(_cA_%1)  ; "MessageBoxW failed"
   895                              <1>     mov     r8,  IMAGE_BASE + RVA_DATA(_cA_%2)  ; "User32"
   896                              <1> %if %0 == 2                                     ; %0 = argument count
   897                              <1>     xor     r9d, r9d                            ; uType = MB_OK
   898                              <1> %else
   899                              <1>     mov     r9d, %3                             ; uType = argument exists
   900                              <1> %endif
   901                              <1>     CALL_IAT MessageBoxA
   902                              <1> %endif
   903                              <1> %endmacro
   904                              <1> 
   905                              <1> ; -----------------------------------------------------------------------------
   906                              <1> ; \brief  ShowWindow shows the window witht the hwnd id in r13.
   907                              <1> ; \since  1.0
   908                              <1> ; \param  hwnd -> HWND handle window
   909                              <1> ; \param  (optional) flag -> integer: default = SW_SHOWDEFAULT
   910                              <1> ; -----------------------------------------------------------------------------
   911                              <1> %macro ShowWindow 1-2
   912                              <1> %if DOS_SHELL == 1
   913                              <1>     %error ERROR_Win32API
   914                              <1> %else
   915                              <1>     nop
   916                              <1>     ;AddShadow (32 + 16)           ; Shadow Space + 16 B Align
   917                              <1>     mov     rcx, %1
   918                              <1> %if %0 == 2
   919                              <1>     mov     edx, %2
   920                              <1> %else
   921                              <1>     mov     edx, SW_SHOWDEFAULT
   922                              <1> %endif
   923                              <1>     CALL_IAT ShowWindow
   924                              <1>     ;DelShadow (32 + 16)
   925                              <1> %endif
   926                              <1> %endmacro
   927                              <1> 
   928                              <1> ; -----------------------------------------------------------------------------
   929                              <1> ; \brief display a message box on top of the Windows 11 desktop.
   930                              <1> ; \param text   -> str
   931                              <1> ; \param title  -> str
   932                              <1> ; \param button -> int
   933                              <1> ; -----------------------------------------------------------------------------
   934                              <1> %macro call_ShowMessageW 5
   935                              <1>     ShowMessageW %3, %4, %5
   936                              <1>     CHECK_NZ %1, %2
   937                              <1> %endmacro
   938                              <1> 
   939                              <1> ; -----------------------------------------------------------------------------
   940                              <1> ; \brief  TranslateMessage
   941                              <1> ; \since  1.0
   942                              <1> ; -----------------------------------------------------------------------------
   943                              <1> %macro TranslateMessage 0
   944                              <1> %if DOS_SHELL == 1
   945                              <1>     %error ERROR_Win32API
   946                              <1> %else
   947                              <1>     mov     rcx, rsi
   948                              <1>     CALL_IAT TranslateMessage
   949                              <1> %endif
   950                              <1> %endmacro
   951                              <1> 
   952                              <1> ; -----------------------------------------------------------------------------
   953                              <1> ; \brief  UpdateWindow refresh the window properties and draw.
   954                              <1> ; \since  1.0
   955                              <1> ;
   956                              <1> ; \see    Invalidate
   957                              <1> ; \see    Repaint
   958                              <1> ;
   959                              <1> ; \param  hwnd -> HWND handle of window to update
   960                              <1> ; -----------------------------------------------------------------------------
   961                              <1> %macro UpdateWindow 1
   962                              <1> %if DOS_SHELL == 1
   963                              <1>     %error ERROR_Win32API
   964                              <1> %else
   965                              <1>     mov     rcx, %1
   966                              <1>     CALL_IAT UpdateWindow
   967                              <1> %endif
   968                              <1> %endmacro
   969                              <1> 
   970                              <1> ; -----------------------------------------------------------------------------
   971                              <1> ; \brief set the length of a given ASCII string to register ...
   972                              <1> ; -----------------------------------------------------------------------------
   973                              <1> %macro SETLEN 2
   974                              <1>     mov      %1, %2_length
   975                              <1> %endmacro
   976                              <1> 
   977                              <1> ; -----------------------------------------------------------------------------
   978                              <1> ; \brief write ASCII text on the text Windows console ...
   979                              <1> ; -----------------------------------------------------------------------------
   980                              <1> %macro WRITE_CON_A 1-2
   981                              <1> %if DOS_SHELL == 1
   982                              <1>     %if %0 == 2
   983                              <1>         PUTS_COLOR %1, %2
   984                              <1>     %else
   985                              <1>         PUTS_COLOR %1, 0x07
   986                              <1>     %endif
   987                              <1> %else
   988                              <1>     ; prepare
   989                              <1>     xor      eax, eax
   990                              <1>     mov      rcx, PTR64(_cA_%1)
   991                              <1>     call     GET_STR_LEN
   992                              <1>     mov      r14, rax
   993                              <1>     GET_CON_O_HANDLE r12
   994                              <1>     mov      rcx, r12
   995                              <1>     mov      rdx, PTR64(_cA_%1)
   996                              <1>     mov      r8 , r14
   997                              <1>     xor      r9d, r9d
   998                              <1>     mov      qword [rsp+32], 0
   999                              <1>     CALL_IAT WriteConsoleA
  1000                              <1> %endif
  1001                              <1> %endmacro
  1002                              <1> 
  1003                              <1> ; -----------------------------------------------------------------------------
  1004                              <1> ; \brief read utf-8 text on the text Windows console ...
  1005                              <1> ; \param dst -> buffer for the "readln" text
  1006                              <1> ; -----------------------------------------------------------------------------
  1007                              <1> %macro READL_CON_A 0-1
  1008                              <1> %if DOS_SHELL == 1
  1009                              <1>     %if  %0 == 1
  1010                              <1>         mov  dx, PTR16(_cA_%1)
  1011                              <1>         call DOSReadLn
  1012                              <1>     %else
  1013                              <1>         mov  dx, PTR16(_cA_dos_buffer)
  1014                              <1>         call DOSReadLn
  1015                              <1>     %endif
  1016                              <1> %else
  1017                              <1>     ; prepare
  1018                              <1>     GET_CON_I_HANDLE  r13
  1019                              <1>     ; ReadConsoleA(hIn, inbuf, maxChars, &read, NULL)
  1020                              <1>     mov      rcx, r13
  1021                              <1>     mov      rdx, PTR64(_cA_%1)
  1022                              <1>     mov      r8d, 127           ; maxChars (Reserviere 1 Byte für NUL)
  1023                              <1>     mov      r9 , PTR64(written)
  1024                              <1>     xor      rax, rax           ; lpReserved = NULL (über Shadow Space)
  1025                              <1>     mov      [rsp+32], rax
  1026                              <1>     CALL_IAT ReadConsoleA
  1027                              <1> %endif
  1028                              <1> %endmacro
  1029                              <1> 
  1030                              <1> ; -----------------------------------------------------------------------------
  1031                              <1> ; \brief integer to string
  1032                              <1> ;
  1033                              <1> ; \param number -> register (number to convert)
  1034                              <1> ; \param buffer -> destination buffer
  1035                              <1> ; -----------------------------------------------------------------------------
  1036                              <1> %macro INT2STR 2
  1037                              <1>     mov     edx, %2                             ; number to convert
  1038                              <1>     mov     rcx, IMAGE_BASE + RVA_DATA(_cA_%1)  ; destination buffer
  1039                              <1>     call    u32_to_dec                          ; buffer -> "12345",0 ; RAX = 5
  1040                              <1> %endmacro
  1041                              <1> 
  1042                              <1> ; -----------------------------------------------------------------------------
  1043                              <1> ; \brief concatenate two strings (%2, %3) to a given string destionation (%1).
  1044                              <1> ; \param dst  -> string buffer
  1045                              <1> ; \param src1 -> string 0-terminated
  1046                              <1> ; \param src2 -> string 0-terminated
  1047                              <1> ; -----------------------------------------------------------------------------
  1048                              <1> %macro STRCPY_ANSI 3
  1049                              <1>     mov     rcx, IMAGE_BASE + RVA_DATA(_cA_%1)
  1050                              <1>     mov     rdx, IMAGE_BASE + RVA_DATA(_cA_%2)
  1051                              <1>     mov     r8 , IMAGE_BASE + RVA_DATA(_cA_%3)
  1052                              <1>     call    concat_ansi
  1053                              <1> %endmacro
  1054                              <1> %macro STRCAT_ANSI 2-*
  1055                              <1>     %xdefine __DSTSYM (_cA_%1 + 4)
  1056                              <1> 
  1057                              <1>     %rotate 1                     ; ab hier ist %1 der erste src
  1058                              <1>     %rep %0-1
  1059                              <1>         ; --- Ende von dst finden: RDI zeigt nach REPNZ SCASB auf Byte NACH '\0'
  1060                              <1>         mov     rdi, IMAGE_BASE
  1061                              <1>         add     rdi, RVA_DATA(__DSTSYM)
  1062                              <1>         xor     eax, eax          ; AL = 0
  1063                              <1>         mov     rcx, -1
  1064                              <1>         repne   scasb
  1065                              <1>         lea     rcx, [rdi - 1]    ; RCX -> Position des '\0' (Schreibposition)
  1066                              <1> 
  1067                              <1>         ; einen Source anhängen: (s1 = aktueller, s2 = leer)
  1068                              <1>         mov     rdx, PTR64(_cA_%1)
  1069                              <1>         mov     r8 , PTR64(_cA_empty)
  1070                              <1>         call    concat_ansi
  1071                              <1> 
  1072                              <1>         %rotate 1                 ; nächster src
  1073                              <1>     %endrep
  1074                              <1> %endmacro
  1075                              <1> 
  1076                              <1> ; -----------------------------------------------------------------------------
  1077                              <1> ; \brief get the output handle of allocated/open console ...
  1078                              <1> ; \param register to store output handle
  1079                              <1> ; -----------------------------------------------------------------------------
  1080                              <1> %macro GET_CON_O_HANDLE 1
  1081                              <1> %if DOS_SHELL == 1
  1082                              <1>     %error ERROR_Win32API
  1083                              <1> %else
  1084                              <1>     mov      ecx, STD_OUTPUT_HANDLE
  1085                              <1>     CALL_IAT GetStdHandle
  1086                              <1>     mov      %1, rax         ; hOut
  1087                              <1> %endif
  1088                              <1> %endmacro
  1089                              <1> ; -----------------------------------------------------------------------------
  1090                              <1> ; \brief get the input handle of allocated/open console ...
  1091                              <1> ; \param register to store input handle
  1092                              <1> ; -----------------------------------------------------------------------------
  1093                              <1> %macro GET_CON_I_HANDLE 1
  1094                              <1> %if DOS_SHELL == 1
  1095                              <1>     %error ERROR_Win32API
  1096                              <1> %else
  1097                              <1>     mov      ecx, STD_INPUT_HANDLE
  1098                              <1>     CALL_IAT GetStdHandle
  1099                              <1>     mov      %1, rax         ; hIn
  1100                              <1> %endif
  1101                              <1> %endmacro
  1102                              <1> 
  1103                              <1> %macro SCREEN_CLEAR 0
  1104                              <1> %if DOS_SHELL == 1
  1105                              <1>     call dos_screen_clear
  1106                              <1> %else
  1107                              <1>     GET_CON_O_HANDLE r12
  1108                              <1>     STRCPY_ANSI buffer_B, consoleColor_3, empty
  1109                              <1>     WRITE_CON_A buffer_B
  1110                              <1> %endif
  1111                              <1> %endmacro
  1112                              <1> 
  1113                              <1> ; -----------------------------------------------------------------------------
  1114                              <1> ; \brief set the cursor position in dos console ...
  1115                              <1> ; \param xpos - <imm>
  1116                              <1> ; \param ypos - <imm>
  1117                              <1> ; -----------------------------------------------------------------------------
  1118                              <1> %macro SET_CURSOR 2
  1119                              <1> %if %0 == 0
  1120                              <1>     %error 2 argument missing
  1121                              <1> %endif
  1122                              <1> %if DOS_SHELL == 1
  1123                              <1>     mov  dl, %1         ; column
  1124                              <1>     mov  dh, %2         ; row
  1125                              <1>     call dos_set_cursor
  1126                              <1> %else
  1127                              <1> %endif
  1128                              <1> %endmacro
  1129                              <1> 
  1130                              <1> ; -----------------------------------------------------------------------------
  1131                              <1> ; \brief get the cursor position in dos console ...
  1132                              <1> ; -----------------------------------------------------------------------------
  1133                              <1> %macro GET_CURSOR 0
  1134                              <1> %if DOS_SHELL == 1
  1135                              <1>     call dos_get_cursor
  1136                              <1> %else
  1137                              <1>     %error 'todo: windows'
  1138                              <1> %endif
  1139                              <1> %endmacro
  1140                              <1> 
  1141                              <1> ; -----------------------------------------------------------------------------
  1142                              <1> ; \brief set the color for console window text
  1143                              <1> ; \param 1. background -> int 0..255
  1144                              <1> ; \param 2. foreground -> int 0..255
  1145                              <1> ;
  1146                              <1> ; \desc  color values > 127 == blink chars
  1147                              <1> ; -----------------------------------------------------------------------------
  1148                              <1> %macro SET_COLOR_TO 2
  1149                              <1> %if %0 == 2
  1150                              <1>     STRCPY_ANSI buffer_B, consoleColor_1, empty
  1151                              <1>     STRCAT_ANSI buffer_B,                                     console_color_%1, buffer_semi,                console_color_%2, consoleColor_2
  1154                              <1>     WRITE_CON_A buffer_B
  1155                              <1> %endif
  1156                              <1> %endmacro
  1157                              <1> 
  1158                              <1> ; -----------------------------------------------------------------------------
  1159                              <1> ; \brief 
  1160                              <1> ; -----------------------------------------------------------------------------
  1161                              <1> %macro ARG_CURSOR 2
  1162                              <1> %if DOS_SHELL == 1
  1163                              <1>     GET_ARG  %1             ; save command line argument 1
  1164                              <1>     mov  bl, %2             ; color
  1165                              <1>     call PutStrColor        ; DOS screen
  1166                              <1> %endif
  1167                              <1> %endmacro
  1168                              <1> 
  1169                              <1> ; -----------------------------------------------------------------------------
  1170                              <1> ; \brief macro to put a colored string to the DOS console ...
  1171                              <1> ; -----------------------------------------------------------------------------
  1172                              <1> %macro PUTS_COLOR 2
  1173                              <1> %if DOS_SHELL == 1
  1174                              <1>     GET_CURSOR              ; move cursor to col:row
  1175                              <1>     %ifstr %1
  1176                              <1>         section .data
  1177                              <1>         %%msg: db %1, 0
  1178                              <1>         section .text
  1179                              <1>         mov  bl, %2                 ; color
  1180                              <1>         mov  si, PTR16(%%msg)       ; text 0-terminated
  1181                              <1>         call PutStrColor            ; DOS screen
  1182                              <1>     %else
  1183                              <1>         %ifidni %1, DI
  1184                              <1>             section .text
  1185                              <1>             mov  bl, %2
  1186                              <1>             call PutStrColor        ; DOS screen
  1187                              <1>         %elifidni %1, SI            ; text is already in SI
  1188                              <1>             section .text
  1189                              <1>             mov  bl, %2             ; color
  1190                              <1>             call PutStrColor        ; DOS screen
  1191                              <1>         %else
  1192                              <1>             %assign __count 0
  1193                              <1>             %assign __varg  0
  1194                              <1>             %assign __stop  0
  1195                              <1>             %rep MAX_ARGV
  1196                              <1>                 %if __stop == 0
  1197                              <1>                     %assign __count (__count + 1)
  1198                              <1>                     %ifidni %1, ARGV_%+__count
  1199                              <1>                         %assign __varg __count
  1200                              <1>                         %assign __stop 1
  1201                              <1>                     %endif
  1202                              <1>                 %endif
  1203                              <1>             %endrep
  1204                              <1>             %if __varg > 0
  1205                              <1>                 section .text
  1206                              <1>                 mov  si, PTR16(_cA_cmd_buf)
  1207                              <1>                 mov  bl, __varg
  1208                              <1>                 call getCommandLine_Arg
  1209                              <1>                 call PutStrColor        ; DOS screen
  1210                              <1>             %else
  1211                              <1>                 section .text
  1212                              <1>                 mov  bl, %2             ; color
  1213                              <1>                 mov  si, PTR16(_cA_%1)  ; text 0-terminated
  1214                              <1>                 call PutStrColor        ; DOS screen
  1215                              <1>             %endif
  1216                              <1>             %undef __varg
  1217                              <1>         %endif
  1218                              <1>     %endif
  1219                              <1> %else
  1220                              <1>     %error 'this macro is only for DOS programming.'
  1221                              <1> %endif
  1222                              <1> %endmacro
  1223                              <1> 
  1224                              <1> ; -----------------------------------------------------------------------------
  1225                              <1> ; \brief  get the length of given label string
  1226                              <1> ; \param  1. label name/addr
  1227                              <1> ; \return CX = length of string
  1228                              <1> ; -----------------------------------------------------------------------------
  1229                              <1> %macro STRLEN 1
  1230                              <1> %if %0 == 1
  1231                              <1>     mov  si, PTR16(_cA_%1)
  1232                              <1>     call DOSStrLen
  1233                              <1>     mov  ax, cx             ; AX = length
  1234                              <1>     add  cx, 1              ; CX = length + 1
  1235                              <1> %else
  1236                              <1>     %error 'exactly one argument expected.'
  1237                              <1> %endif
  1238                              <1> %endmacro
  1239                              <1> 
  1240                              <1> ; -----------------------------------------------------------------------------
  1241                              <1> ; \brief  helper macro save code resources.
  1242                              <1> ; \desc   return to DOS with exit code
  1243                              <1> ; \param  1. exit code value (0..255).
  1244                              <1> ; \return nothing
  1245                              <1> ; -----------------------------------------------------------------------------
  1246                              <1> %macro DOS_Exit 1
  1247                              <1> %if DOS_SHELL == 1
  1248                              <1>     %ifidni   %1, ax
  1249                              <1>         %error 'AX not allowed here.'
  1250                              <1>     %elifidni %1, bx
  1251                              <1>         mov ax, 0x4C00
  1252                              <1>         or  ax, bx
  1253                              <1>         SysCall
  1254                              <1>     %elifidni %1, CX
  1255                              <1>         mov ax, 0x4C00
  1256                              <1>         or  ax, cx
  1257                              <1>         SysCall
  1258                              <1>     %elifidni %1, dx
  1259                              <1>         mov ax, 0x4C00
  1260                              <1>         or  ax, dx
  1261                              <1>         SysCall
  1262                              <1>     %elifnum  %1
  1263                              <1>         mov  ax, 0x4C00 | %1
  1264                              <1>         SysCall
  1265                              <1>     %else
  1266                              <1>         %error 'BX, CX, DX or <NUM> expected.'
  1267                              <1>     %endif
  1268                              <1> %endif
  1269                              <1> %endmacro
  1270                              <1> 
  1271                              <1> ; -----------------------------------------------------------------------------
  1272                              <1> ; \brief  print a CRLF on DOS console
  1273                              <1> ; \param  nothing
  1274                              <1> ; \return nothing
  1275                              <1> ; -----------------------------------------------------------------------------
  1276                              <1> %macro DOS_crlf 0
  1277                              <1>     call DOSrncrlf
  1278                              <1> %endmacro
  1279                              <1> 
  1280                              <1> ; -----------------------------------------------------------------------------
  1281                              <1> ; \brief write a string in DX to DOS console without "lf", and no "cr" ...
  1282                              <1> ; \param 1. DX - src label
  1283                              <1> ; \see   DOS_WriteLn
  1284                              <1> ; -----------------------------------------------------------------------------
  1285                              <1> %macro DOS_Write 1
  1286                              <1>     lea  dx, [PTR16(_cA_%1)]
  1287                              <1>     call DOS_ConsoleWrite
  1288                              <1> %endmacro
  1289                              <1> 
  1290                              <1> ; -----------------------------------------------------------------------------
  1291                              <1> ; \brief write a string in DX to DOS console with "lf", and "cr" ...
  1292                              <1> ; \param 1. DX - src label
  1293                              <1> ; \see   DOS_Write
  1294                              <1> ; -----------------------------------------------------------------------------
  1295                              <1> %macro DOS_WriteLn 1
  1296                              <1>     DOS_Write %1
  1297                              <1>     DOS_crlf
  1298                              <1> %endmacro
  1299                              <1> 
  1300                              <1> ; -----------------------------------------------------------------------------
  1301                              <1> ; \brief allocate memory for/in the DOS console ...
  1302                              <1> ; \param 1. count paragraphs
  1303                              <1> ; \note  calculate with: 4096 / 16 = 256 (4096 is a example !)
  1304                              <1> ; -----------------------------------------------------------------------------
  1305                              <1> %macro DOS_AllocMem 1
  1306                              <1> %if DOS_SHELL == 1
  1307                              <1>     mov  ax, 4800h      ; AH = 48h -> Allocate Memory Block
  1308                              <1>     mov  bx, %1         ; Paragraph-Anzahl
  1309                              <1>     SysCall
  1310                              <1>     
  1311                              <1>     sbb  ax, ax
  1312                              <1>     cmp  ax, 0
  1313                              <1>     je   %%.successful
  1314                              <1>     
  1315                              <1>     cmp  ax, 0xFF
  1316                              <1>     je   %%.fail        ; CF = 1 -> error, AX = error code
  1317                              <1>     
  1318                              <1>     jmp  %%.fail
  1319                              <1>     
  1320                              <1>     %%.successful:
  1321                              <1>     ; AX = Segment des Blocks
  1322                              <1>     mov  es, ax
  1323                              <1>     xor  di, di
  1324                              <1>     
  1325                              <1>     ; Block mit 0x00 füllen
  1326                              <1>     mov  cx, 4096
  1327                              <1>     mov  al, 0x00
  1328                              <1>     rep  stosb          ; write to ES:DI
  1329                              <1>     
  1330                              <1>     ; demo read access: AL = ES:[1234]
  1331                              <1>     ;mov  di, 1234
  1332                              <1>     ;mov  al, [es:di]
  1333                              <1>     
  1334                              <1>     jmp   %%.next
  1335                              <1>     
  1336                              <1>     %%.fail:
  1337                              <1>     DOS_WriteLn msg_alloc_error
  1338                              <1>     DOS_Exit    1
  1339                              <1>     
  1340                              <1>     %%.next:
  1341                              <1> %endif
  1342                              <1> %endmacro
  1343                              <1> 
  1344                              <1> %macro DOS_FreeMem 0
  1345                              <1> %if DOS_SHELL == 1
  1346                              <1>     mov es, ax
  1347                              <1>     mov ah, 0x49
  1348                              <1>     SysCall
  1349                              <1> %else
  1350                              <1>     %error 'todo: windows'
  1351                              <1> %endif
  1352                              <1> %endmacro
  1353                              <1> 
  1354                              <1> ; -----------------------------------------------------------------------------
  1355                              <1> ; \brief COMPARE <reg>, <imm>, <label>
  1356                              <1> ; \param 1. <reg>
  1357                              <1> ; \param 2. <imm>
  1358                              <1> ; \param 3. <label>
  1359                              <1> ; \note  example: COMPARE al, 0x0a, printed
  1360                              <1> ;        result:  cmp <reg>, <imm>  /  je <label>
  1361                              <1> ; -----------------------------------------------------------------------------
  1362                              <1> %macro COMPARE 3
  1363                              <1>     cmp %1, %2
  1364                              <1>     je  %3
  1365                              <1> %endmacro
  1366                              <1> 
  1367                              <1> ; -----------------------------------------------------------------------------
  1368                              <1> ; \brief  get the n-th command line, success: jump to %2 ...
  1369                              <1> ; \param  1. <imm>
  1370                              <1> ; \return SI = text (=argument)
  1371                              <1> ; \note   example: GET_ARG 2
  1372                              <1> ;         result:  <text> in SI
  1373                              <1> ; -----------------------------------------------------------------------------
  1374                              <1> %macro GET_ARG 1-2
  1375                              <1> %if DOS_SHELL == 1
  1376                              <1>     lea  si, [PTR16(_cA_cmd_buf)]
  1377                              <1>     mov  bl, %1
  1378                              <1>     call getCommandLine_Arg
  1379                              <1>     %if %0 == 2
  1380                              <1>         jnc  %2
  1381                              <1>     %endif
  1382                              <1> %else
  1383                              <1>     %error 'todo: windows'
  1384                              <1> %endif
  1385                              <1> %endmacro
  1386                              <1> 
  1387                              <1> ; -----------------------------------------------------------------------------
  1388                              <1> ; \brief save the n-th command line argument to the <label>
  1389                              <1> ; \param 1. <imm> -> n-th argument number
  1390                              <1> ; \param 2. <label>
  1391                              <1> ; \note  example: SET_ARG <imm>, <label>
  1392                              <1> ; -----------------------------------------------------------------------------
  1393                              <1> %macro SET_ARG 1-2
  1394                              <1> %if DOS_SHELL == 1
  1395                              <1>     %if %0 == 1
  1396                              <1>         GET_ARG  %1
  1397                              <1>         STR_COPY _cA_cmd_arg_%1
  1398                              <1>     %else
  1399                              <1>         GET_ARG  %1
  1400                              <1>         STR_COPY _cA_%2
  1401                              <1>     %endif
  1402                              <1> %else
  1403                              <1>     %error 'todo: windows'
  1404                              <1> %endif
  1405                              <1> %endmacro
  1406                              <1> 
  1407                              <1> ; -----------------------------------------------------------------------------
  1408                              <1> ; \brief copy a string from source index SI to DI <label>
  1409                              <1> ; \param 1. <label>
  1410                              <1> ; \note  example: STR_COPY <label>
  1411                              <1> ; -----------------------------------------------------------------------------
  1412                              <1> %macro STR_COPY 1
  1413                              <1> %if DOS_SHELL == 1
  1414                              <1>     lea  di, [%1]       ; ES wird in string_copy gesetzt
  1415                              <1>     call string_copy    ; kommt zurück mit SI = Zielstart
  1416                              <1> %else
  1417                              <1>     %error 'todo: windows'
  1418                              <1> %endif
  1419                              <1> %endmacro
  1420                              <1> 
  1421                              <1> ; -----------------------------------------------------------------------------
  1422                              <1> ; \brief short'ner to get the command line arguments given by the user input.
  1423                              <1> ; \brief initialize a console application ...
  1424                              <1> ; \param nothing
  1425                              <1> ; -----------------------------------------------------------------------------
  1426                              <1> %macro INIT_COMMAND_LINE 0
  1427                              <1> %if DOS_SHELL == 1
  1428                              <1>     call dos_get_command_line
  1429                              <1> %else
  1430                              <1>     %error 'todo: windows'
  1431                              <1> %endif
  1432                              <1> %endmacro
  1433                              <1> 
  1434                              <1> ; -----------------------------------------------------------------------------
  1435                              <1> ; \brief call the DOS console initialize routine ...
  1436                              <1> ; -----------------------------------------------------------------------------
  1437                              <1> %macro INIT_CONSOLE 0
  1438                              <1> %if DOS_SHELL == 1
  1439                              <1>     call dos_init_console
  1440                              <1>     SCREEN_CLEAR
  1441                              <1> %else
  1442                              <1>     call init_app
  1443                              <1>     call init_console
  1444                              <1> %endif
  1445                              <1> %endmacro
  1446                              <1> 
  1447                              <1> ; -----------------------------------------------------------------------------
  1448                              <1> ; \brief generischer Handler für einen Fehlercode ...
  1449                              <1> ; -----------------------------------------------------------------------------
  1450                              <1> %macro DEF_ERROR 2
  1451                              <1> _h%1:
  1452                              <1>     PUTS_COLOR %2, ATTR_DOS_ERROR
  1453                              <1>     mov   cx, %1
  1454                              <1>     jmp   _open_exit
  1455                              <1> %endmacro
  1456                              <1> 
  1457                              <1> ; -----------------------------------------------------------------------------
  1458                              <1> ; \brief DOS seek to <origin> in file <handle> ...
  1459                              <1> ; \param 1. <file handle>
  1460                              <1> ; \param 2. <origin> 0 - begin of file, 1 - current position, 2 - end of file
  1461                              <1> ; -----------------------------------------------------------------------------
  1462                              <1> %macro DOS_Seek 2
  1463                              <1> %if DOS_SHELL == 1
  1464                              <1>     mov  bx, [PTR16(_cA_%1)]
  1465                              <1>     xor  cx, cx
  1466                              <1>     xor  dx, dx
  1467                              <1>     mov  ah, 0x42               ; move to ...
  1468                              <1>     mov  al, %2
  1469                              <1>     SysCall
  1470                              <1> %else
  1471                              <1>     %error 'todo: windows'
  1472                              <1> %endif
  1473                              <1> %endmacro
  1474                              <1> 
  1475                              <1> ; -----------------------------------------------------------------------------
  1476                              <1> ; \brief DOS open existing <file name>
  1477                              <1> ; \param 1. <file name>
  1478                              <1> ; \param 2. <open mode> - DOS_READ_ONLY, DOW_WRITE_ONLY, DOS_READWRITE
  1479                              <1> ; -----------------------------------------------------------------------------
  1480                              <1> %macro DOS_Open 2
  1481                              <1> %if DOS_SHELL == 1
  1482                              <1>     mov  dx, PTR16(_cA_%1)
  1483                              <1>     mov  ah, 0x3D               ; open existing file
  1484                              <1>     mov  al, %2                 ; read-only
  1485                              <1>     SysCall
  1486                              <1> %else
  1487                              <1>     %error 'todo: windows'
  1488                              <1> %endif
  1489                              <1> %endmacro
  1490                              <1> 
  1491                              <1> %macro DOS_Close 2
  1492                              <1> %if DOS_SHELL == 1
  1493                              <1>     mov  bx, [PTR16(_cA_%1)]
  1494                              <1>     or   bx, bx
  1495                              <1>     jz   %2
  1496                              <1>     mov  ah, 3Eh
  1497                              <1>     SysCall
  1498                              <1> %else
  1499                              <1>     %error 'todo: windows'
  1500                              <1> %endif
  1501                              <1> %endmacro
  1502                              <1> 
  1503                              <1> ; -----------------------------------------------------------------------------
  1504                              <1> ; ERR_HANDLER <err1>[, <err2>, ...]
  1505                              <1> ; erzeugt für jedes Argument:
  1506                              <1> ; _cA_errn<arg>:
  1507                              <1> ;     PUTS_COLOR open_error_<arg>, ATTR_DOS_ERROR
  1508                              <1> ;     mov cx, <arg>
  1509                              <1> ;     jmp _open_exit
  1510                              <1> ; -----------------------------------------------------------------------------
  1511                              <1> ; Hilfsmakro: Nibble (0..15) -> Hex-Zeichen 0..F
  1512                              <1> %macro _HEXDIG 2
  1513                              <1>   %if %1 < 10
  1514                              <1>     %define %2 %1
  1515                              <1>   %elif %1 = 10
  1516                              <1>     %define %2 A
  1517                              <1>   %elif %1 = 11
  1518                              <1>     %define %2 B
  1519                              <1>   %elif %1 = 12
  1520                              <1>     %define %2 C
  1521                              <1>   %elif %1 = 13
  1522                              <1>     %define %2 D
  1523                              <1>   %elif %1 = 14
  1524                              <1>     %define %2 E
  1525                              <1>   %elif %1 = 15
  1526                              <1>     %define %2 F
  1527                              <1>   %else
  1528                              <1>     %error "_HEXDIG: Nibble ausserhalb 0..15"
  1529                              <1>   %endif
  1530                              <1> %endmacro
  1531                              <1> ; -----------------------------------------------------------------------------
  1532                              <1> ; expr -> zwei Hex-Zeichen OUT_H/OUT_L (ohne 0x/h), 8-bit
  1533                              <1> ; -----------------------------------------------------------------------------
  1534                              <1> %macro _HEX2 3
  1535                              <1>   %assign __v %1
  1536                              <1>   %assign __v __v & 0FFh
  1537                              <1>   %assign __hi (__v >> 4) & 0Fh
  1538                              <1>   %assign __lo  __v       & 0Fh
  1539                              <1>   _HEXDIG __hi, %2
  1540                              <1>   _HEXDIG __lo, %3
  1541                              <1>   %undef __v
  1542                              <1>   %undef __hi
  1543                              <1>   %undef __lo
  1544                              <1> %endmacro
  1545                              <1> ; -----------------------------------------------------------------------------
  1546                              <1> ; ERR_HANDLER <err1>[, <err2>, ...]
  1547                              <1> ; Baut Labels / Namen mit zwei Hex-Ziffern (00..FF), ohne 0x/h.
  1548                              <1> ; -----------------------------------------------------------------------------
  1549                              <1> %macro ERR_HANDLER 1-*
  1550                              <1> %rep %0
  1551                              <1>     ; Ausdruck auswerten (dezimal/hex ok) und auf 8 Bit begrenzen
  1552                              <1>     %assign __v %1
  1553                              <1>     %assign __v __v & 0FFh
  1554                              <1> 
  1555                              <1>     ; zwei Hex-Ziffern bilden
  1556                              <1>     %assign __hi (__v >> 4) & 0Fh
  1557                              <1>     %assign __lo  __v       & 0Fh
  1558                              <1>     _HEXDIG __hi, __H
  1559                              <1>     _HEXDIG __lo, __L
  1560                              <1> 
  1561                              <1> _cA_errh%+__H%+__L:
  1562                              <1>     PUTS_COLOR open_error_%+__H%+__L, ATTR_DOS_ERROR
  1563                              <1>     mov cx, %1
  1564                              <1>     jmp _open_exit
  1565                              <1>     
  1566                              <1>     ; Aufräumen der temporären Namen dieser Iteration
  1567                              <1>     %undef __H
  1568                              <1>     %undef __L
  1569                              <1>     %undef __hi
  1570                              <1>     %undef __lo
  1571                              <1>     %undef __v
  1572                              <1>     
  1573                              <1>     %rotate 1
  1574                              <1> %endrep
  1575                              <1> %endmacro
  1576                              <1> ; -----------------------------------------------------------------------------
  1577                              <1> ; Für jeden Code: Label _cA_errhXX + Body
  1578                              <1> ;
  1579                              <1> ; ---------- Tabelle (Datenbereich) ----------
  1580                              <1> ; ERZEUGT: 
  1581                              <1> ;   _cA_error_dispatch:
  1582                              <1> ;       dw <code>, _cA_errhXX
  1583                              <1> ;       ...
  1584                              <1> ;       dw 00h, _cA_errhnd
  1585                              <1> ; -----------------------------------------------------------------------------
  1586                              <1> %macro ERR_ITEMS 1-*
  1587                              <1> _cA_error_dispatch:
  1588                              <1>   %rep %0
  1589                              <1>     _HEX2 %1, __H, __L
  1590                              <1>     dw %1, _cA_errh%+__H%+__L
  1591                              <1>     %undef __H
  1592                              <1>     %undef __L
  1593                              <1>     %rotate 1
  1594                              <1>   %endrep
  1595                              <1>   dw 00h, _cA_errhnd
  1596                              <1> %endmacro
  1597                              <1> 
  1598                              <1> ; -----------------------------------------------------------------------------
  1599                              <1> ; \brief check a character at the given position in given label string...
  1600                              <1> ; CMP_CHR <label>, <num-position>, <char to check>, <jump label if equal>
  1601                              <1> ; CMP_CHR argvn, 2, '3', is_three
  1602                              <1> ; -----------------------------------------------------------------------------
  1603                              <1> %macro CMP_CHR 4
  1604                              <1>     %ifstr %1
  1605                              <1>         section .data
  1606                              <1>         %%msg: db %1, 0
  1607                              <1>         section .text
  1608                              <1>         lea si, [PTR16(%%msg)]       ; text 0-terminated
  1609                              <1>     %else
  1610                              <1>     section .text
  1611                              <1>         %assign __count 0
  1612                              <1>         %assign __varg  0
  1613                              <1>         %assign __stop  0
  1614                              <1>         %rep MAX_ARGV
  1615                              <1>             %if __stop == 0
  1616                              <1>                 %assign __count (__count + 1)
  1617                              <1>                 %ifidni %1, ARGV_%+__count
  1618                              <1>                     %assign __varg __count
  1619                              <1>                     %assign __stop 1
  1620                              <1>                 %endif
  1621                              <1>             %endif
  1622                              <1>         %endrep
  1623                              <1>         %if __varg > 0
  1624                              <1>             mov  si, PTR16(_cA_cmd_buf)
  1625                              <1>             mov  bl, __varg
  1626                              <1>             call getCommandLine_Arg
  1627                              <1>         %else
  1628                              <1>             lea si, [PTR16(_cA_%1)]
  1629                              <1>         %endif
  1630                              <1>         %undef __stop
  1631                              <1>         %undef __varg
  1632                              <1>     %endif
  1633                              <1>         xor  cl, cl
  1634                              <1>         push si
  1635                              <1>     %%loop:
  1636                              <1>         lodsb
  1637                              <1>         inc cl
  1638                              <1>         cmp cl, %2
  1639                              <1>         je  %%next
  1640                              <1>         jmp %%loop
  1641                              <1>     %%next:
  1642                              <1>         pop si
  1643                              <1>         cmp al, %3
  1644                              <1>         je  %4
  1645                              <1> %endmacro
  1646                              <1> 
  1647                              <1> ; -----------------------------------------------------------------------------
  1648                              <1> ; \brief compare 2 string's ...
  1649                              <1> ; -----------------------------------------------------------------------------
  1650                              <1> %macro CMP_STR 3
  1651                              <1>     %ifnum %1                           ; argument 1 is a number ?
  1652                              <1>         %error 'numbers can not be handled as string.'
  1653                              <1>     %elifstr %1                         ; argument 1 is a string ?
  1654                              <1>         section .data
  1655                              <1>         %%part1: db %1, 0
  1656                              <1>         section .text
  1657                              <1>         lea  si, [PTR16(%%part1)]       ; dst
  1658                              <1>         %ifstr %2                       ; argument 2 is a string ?
  1659                              <1>             section .data
  1660                              <1>             %%part2: db %2, 0
  1661                              <1>             section .text
  1662                              <1>             lea di, [PTR16(%%part2)]    ; src
  1663                              <1>             call string_compare
  1664                              <1>             cmp al, 0
  1665                              <1>             je  %3
  1666                              <1>         %elifnum %2                     ; argument 2 is a number ?
  1667                              <1>             %error 'numbers can not be handled as string.'
  1668                              <1>         %else
  1669                              <1>             %error 'todo'
  1670                              <1>         %endif
  1671                              <1>     %else
  1672                              <1>     section .text
  1673                              <1>         %assign __count 0
  1674                              <1>         %assign __varg  0
  1675                              <1>         %assign __stop  0
  1676                              <1>         %rep MAX_ARGV
  1677                              <1>             %if __stop == 0
  1678                              <1>                 %assign __count (__count + 1)
  1679                              <1>                 %ifidni %1, ARGV_%+__count
  1680                              <1>                     %assign __varg __count
  1681                              <1>                     %assign __stop 1
  1682                              <1>                 %endif
  1683                              <1>             %endif
  1684                              <1>         %endrep
  1685                              <1>         %if __varg > 0
  1686                              <1>             mov  si, PTR16(_cA_cmd_buf)
  1687                              <1>             mov  bl, __varg
  1688                              <1>             call getCommandLine_Arg
  1689                              <1>         %else
  1690                              <1>             lea si, [PTR16(_cA_%1)]
  1691                              <1>         %endif
  1692                              <1>         %imdef __stop
  1693                              <1>         %undef __varg
  1694                              <1>     %endif
  1695                              <1> %endmacro
    13                                  
    14                                  ; -----------------------------------------------------------------------------
    15                                  ; DOS and PE-Header
    16                                  ; -----------------------------------------------------------------------------
    17                                  %include 'doshdr.inc'
     1                              <1> ;---------------------------------------------------
     2                              <1> ; \file  doshdr.asm
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ;---------------------------------------------------
     8                              <1> ; DOS-Header
     9                              <1> ;---------------------------------------------------
    10                              <1> org 0
    11                              <1> bits 16
    12                              <1> section .text
    13                              <1> ; ---- Header-Layout-Marker
    14                              <1> dos_start:
    15 00000000 4D5A                <1>     db 'M','Z'                          ; e_magic
    16 00000002 4C01                <1>     dw ( stub_end - $$) % 512           ; e_cblp
    17 00000004 0C00                <1>     dw ((stub_end - $$) + 511) / 512    ; e_cp
    18 00000006 0000                <1>     dw 0                                ; e_crlc (keine Relocs)
    19 00000008 0400                <1>     dw ((stub_entry  - $$) +  15) / 16  ; e_cparhdr (Headergröße in Paragraphen)
    20 0000000A 0000                <1>     dw 0                                ; e_minalloc
    21 0000000C 0010                <1>     dw 0x1000                           ; e_maxalloc (so viel wie möglich)
    22 0000000E 0000                <1>     dw 0                                ; e_ss
    23 00000010 FEFF                <1>     dw 0xFFFE                           ; e_sp (kleiner Stack)
    24 00000012 0000                <1>     dw 0                                ; e_csum
    25 00000014 0000                <1>     dw 0                                ; e_ip  (Code startet bei 0 im Image)
    26 00000016 0000                <1>     dw 0                                ; e_cs
    27 00000018 4000                <1>     dw mz_reloc - $$                    ; e_lfarlc (Reloc-Tabelle: leer)
    28                              <1>     ;dw 0x0040                          ; e_lfarlc  <-- fest im Header
    29 0000001A 0000                <1>     dw 0                                ; e_ovno
    30 0000001C 0000<rep 4h>        <1>     times     4  dw 0                   ; e_res[4]
    31 00000024 6A1C5720            <1>     dw    7274, 8279                    ; e_oemid, e_oeminfo
    32 00000028 0000<rep Ah>        <1>     times    10  dw 0                   ; e_res2[10]
    33 0000003C [50170000]          <1>     dd pe_header                        ; e_lfanew -> Offset des PE-Headers
    34                              <1>     
    35                              <1> end_dos_header equ ($ - dos_start)
    36                              <1> 
    37                              <1> ; Reloc-Tabelle (leer), aber im Headerbereich!
    38                              <1> mz_reloc:                               ; == 0x40
    39                              <1> 
    40                              <1> ;---------------------------------------------------
    41                              <1> ; DOS 16 bit stub
    42                              <1> ;---------------------------------------------------
    43                              <1> align 16                                ; <-- sicherstellen, dass mz_image auf Absatzgrenze startet
    44                              <1> mz_image:
    45                              <1> 
    46                              <1> ; ---- 16-bit Stub-Entry bei e_cs:e_ip = 0:0 (ab mz_image)
    47                              <1> stub_entry:
    48 00000040 <bin 170Ch>         <1> incbin 'kernel.bin'
    49                              <1> 
    50                              <1> ;---------------------------------------------------
    51                              <1> ; Windows 3.1 16 bit stub
    52                              <1> ;---------------------------------------------------
    53                              <1> ;align 16
    54                              <1> ;%include 'win16NEhdr.inc'
    55                              <1> 
    56                              <1> stub_end:
    18                                  %include 'winhdr.inc'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  winhdr.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> ; PE-Header (PE32+) + Optional Header + Section Table
     9                              <1> ; -----------------------------------------------------------------------------
    10                              <1> %define DOS_SHELL 0
    11                              <1> bits 64
    12                              <1> org 0
    13 0000174C 90<rep 4h>          <1> align 8
    14                              <1> pe_header:
    15 00001750 50450000            <1>     db 'P','E',0,0                 ; "PE\0\0"
    16                              <1> 
    17                              <1>     ; COFF
    18 00001754 6486                <1>     dw IMAGE_FILE_MACHINE_AMD64    ; AMD64
    19 00001756 0400                <1>     dw 4                           ; Sections: .text, .idata, .data, .bss
    20 00001758 000000000000000000- <1>     dd 0,0,0
    20 00001761 000000              <1>
    21 00001764 F000                <1>     dw 0x00F0                      ; SizeOfOptionalHeader (PE32+)
    22 00001766 2300                <1>     dw 0x0023                      ; EXECUTABLE|LAA  (Relocs stripped)
    23                              <1> 
    24                              <1> %include 'precalc.asm'
     1                              <2> ; -----------------------------------------------------------------------------
     2                              <2> ; \file  precalcasm
     3                              <2> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <2> ;        all rights reserved.
     5                              <2> ;
     6                              <2> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <2> ; -----------------------------------------------------------------------------
     8                              <2> ; pre-calculatuins
     9                              <2> ; -----------------------------------------------------------------------------
    10                              <2> %define ALIGN_UP(x,a)  (((x) + (a) - 1) / (a) * (a))
    11                              <2> 
    12                              <2> ; ---- Header/erste Section ----
    13                              <2> %define SIZEOF_HEADERS ALIGN_UP(headers_end - $$, FILEALIGN)
    14                              <2> 
    15                              <2> %define TEXT_VA        ALIGN_UP(headers_end - $$, SECTALIGN)
    16                              <2> %define TEXT_RAW_PTR   SIZEOF_HEADERS
    17                              <2> %define TEXT_VSIZE     (text_end - text_start)
    18                              <2> %define TEXT_RAW_SIZE  ALIGN_UP(TEXT_VSIZE, FILEALIGN)
    19                              <2> %define TEXT_VSIZE_AL  ALIGN_UP(TEXT_VSIZE, SECTALIGN)
    20                              <2> 
    21                              <2> ; ---- .idata ----
    22                              <2> %define IDATA_VA       ALIGN_UP(TEXT_VA + TEXT_VSIZE_AL, SECTALIGN)
    23                              <2> %define IDATA_VSIZE    (idata_end - idata_start)
    24                              <2> %define IDATA_VSIZE_AL ALIGN_UP(IDATA_VSIZE, SECTALIGN)
    25                              <2> 
    26                              <2> %define IDATA_RAW_PTR  ALIGN_UP(TEXT_RAW_PTR + TEXT_RAW_SIZE, FILEALIGN)
    27                              <2> %define IDATA_RAW_SIZE ALIGN_UP(IDATA_VSIZE, FILEALIGN)
    28                              <2> 
    29                              <2> ; ---- .data ----
    30                              <2> %define DATA_VA        ALIGN_UP(IDATA_VA + IDATA_VSIZE_AL, SECTALIGN)
    31                              <2> %define DATA_VSIZE     (data_end - data_start)
    32                              <2> %define DATA_VSIZE_AL  ALIGN_UP(DATA_VSIZE, SECTALIGN)
    33                              <2> 
    34                              <2> %define DATA_RAW_PTR   ALIGN_UP(IDATA_RAW_PTR + IDATA_RAW_SIZE, FILEALIGN)
    35                              <2> %define DATA_RAW_SIZE  ALIGN_UP(DATA_VSIZE, FILEALIGN)
    36                              <2> 
    37                              <2> ; ---- .bss (keine Raw-Daten!) ----
    38                              <2> %define BSS_VA         ALIGN_UP(DATA_VA + DATA_VSIZE_AL, SECTALIGN)
    39                              <2> %define BSS_VSIZE      (bss_end - bss_start)
    40                              <2> %define BSS_VSIZE_AL   ALIGN_UP(BSS_VSIZE, SECTALIGN)
    41                              <2> 
    42                              <2> %define BSS_RAW_PTR    0
    43                              <2> %define BSS_RAW_SIZE   0
    44                              <2> 
    45                              <2> ; ---- Image-Größe ----
    46                              <2> %define SIZEOF_IMAGE   ALIGN_UP(BSS_VA + BSS_VSIZE_AL, SECTALIGN)
    47                              <2> 
    48                              <2> ; ---- RVA-Helfer ----
    49                              <2> %define RVA_TEXT(L)   (TEXT_VA  + ((L) - text_start))
    50                              <2> %define RVA_IDATA(L)  (IDATA_VA + ((L) - idata_start))
    51                              <2> %define RVA_DATA(L)   (DATA_VA  + ((L) - data_start))
    52                              <2> %define RVA_BSS(L)    (BSS_VA   + ((L) - bss_start))
    25                              <1> 
    26                              <1> ; --------- Optional Header (PE32+)
    27 00001768 0B02                <1>     dw 0x020B                      ; Magic
    28 0000176A 0000                <1>     db 0,0                         ; LinkerVersion
    29 0000176C 000E0000            <1>     dd TEXT_RAW_SIZE               ; SizeOfCode
    30 00001770 000C0000            <1>     dd IDATA_RAW_SIZE + DATA_RAW_SIZE  ; SizeOfInitializedData
    31 00001774 05030000            <1>     dd BSS_VSIZE                   ; SizeOfUninitializedData (nur .bss, virtuell)
    32 00001778 00200000            <1>     dd RVA_TEXT(text_start)        ; EntryPoint
    33 0000177C 00200000            <1>     dd TEXT_VA                     ; BaseOfCode
    34 00001780 0000004001000000    <1>     dq IMAGE_BASE                  ; ImageBase
    35 00001788 00100000            <1>     dd SECTALIGN                   ; SectionAlignment
    36 0000178C 00020000            <1>     dd FILEALIGN                   ; FileAlignment
    37 00001790 06000000            <1>     dw 6,0                         ; OS Version
    38 00001794 9D07A407            <1>     dw 1949,1956                   ; Image Version
    39 00001798 06000000            <1>     dw 6,0                         ; Subsystem Version
    40 0000179C 00000000            <1>     dd 0
    41 000017A0 00600000            <1>     dd SIZEOF_IMAGE                ; SizeOfImage
    42 000017A4 001A0000            <1>     dd SIZEOF_HEADERS              ; SizeOfHeaders
    43 000017A8 00000000            <1>     dd 0                           ; Checksum
    44 000017AC 0200                <1>     dw 2                           ; Subsystem = Windows GUI
    45 000017AE 0001                <1>     dw IMAGE_DLLCHARACTERISTICS_NX_COMPAT ; DllCharacteristics: NXCompat (no ASLR)
    46 000017B0 000010000000000000- <1>     dq 0x100000, 0x1000            ; Stack Reserve/Commit
    46 000017B9 10000000000000      <1>
    47 000017C0 000010000000000000- <1>     dq 0x100000, 0x1000            ; Heap  Reserve/Commit
    47 000017C9 10000000000000      <1>
    48 000017D0 00000000            <1>     dd 0
    49 000017D4 10000000            <1>     dd 16
    50                              <1> 
    51                              <1>     ; Data Directories
    52 000017D8 0000000000000000    <1>     dd 0,0                         ; 0 Export
    53 000017E0 0030000050000000    <1>     dd RVA_IDATA(import_dir), (import_dir_end - import_dir) ; 1 Import
    54 000017E8 0000000000000000    <1>     dd 0,0                         ; 2 Resource
    55 000017F0 0000000000000000    <1>     dd 0,0                         ; 3 Exception
    56 000017F8 0000000000000000    <1>     dd 0,0                         ; 4 Security
    57 00001800 0000000000000000    <1>     dd 0,0                         ; 5 Base Reloc
    58 00001808 0000000000000000    <1>     dd 0,0                         ; 6 Debug
    59 00001810 0000000000000000    <1>     dd 0,0                         ; 7 Architecture
    60 00001818 0000000000000000    <1>     dd 0,0                         ; 8 Global Ptr
    61 00001820 0000000000000000    <1>     dd 0,0                         ; 9 TLS
    62 00001828 0000000000000000    <1>     dd 0,0                         ; 10 Load Config
    63 00001830 0000000000000000    <1>     dd 0,0                         ; 11 Bound Import
    64 00001838 8032000030020000    <1>     dd RVA_IDATA(iat_start), (iat_end - iat_start)          ; 12 IAT
    65 00001840 0000000000000000    <1>     dd 0,0                         ; 13 Delay Import
    66 00001848 0000000000000000    <1>     dd 0,0                         ; 14 COM
    67 00001850 0000000000000000    <1>     dd 0,0                         ; 15 Reserved
    68                              <1> 
    69                              <1>     ; Section .text
    70 00001858 2E74657874000000    <1>     db '.text',0,0,0
    71 00001860 890C0000            <1>     dd TEXT_VSIZE
    72 00001864 00200000            <1>     dd TEXT_VA
    73 00001868 000E0000            <1>     dd TEXT_RAW_SIZE
    74 0000186C 001A0000            <1>     dd TEXT_RAW_PTR
    75 00001870 0000000000000000    <1>     dd 0,0
    76 00001878 00000000            <1>     dw 0,0
    77 0000187C 20000060            <1>     dd 0x60000020                  ; CODE|EXECUTE|READ
    78                              <1> 
    79                              <1>     ; Section .idata
    80 00001880 2E69646174610000    <1>     db '.idata',0,0
    81 00001888 60090000            <1>     dd IDATA_VSIZE
    82 0000188C 00300000            <1>     dd IDATA_VA
    83 00001890 000A0000            <1>     dd IDATA_RAW_SIZE
    84 00001894 00280000            <1>     dd IDATA_RAW_PTR
    85 00001898 0000000000000000    <1>     dd 0,0
    86 000018A0 00000000            <1>     dw 0,0
    87 000018A4 400000C0            <1>     dd 0xC0000040                  ; INIT_DATA|READ|WRITE
    88                              <1> 
    89                              <1>     ; --- Section .data
    90 000018A8 2E64617461000000    <1>     db '.data',0,0,0
    91 000018B0 9B010000            <1>     dd DATA_VSIZE
    92 000018B4 00400000            <1>     dd DATA_VA
    93 000018B8 00020000            <1>     dd DATA_RAW_SIZE
    94 000018BC 00320000            <1>     dd DATA_RAW_PTR
    95 000018C0 0000000000000000    <1>     dd 0,0
    96 000018C8 00000000            <1>     dw 0,0
    97 000018CC 400000C0            <1>     dd 0xC0000040      ; READ | WRITE | INIT_DATA
    98                              <1>     
    99                              <1>     ; --- Section .bss
   100 000018D0 2E62737300000000    <1>     db '.bss',0,0,0,0
   101 000018D8 05030000            <1>     dd BSS_VSIZE
   102 000018DC 00500000            <1>     dd BSS_VA
   103 000018E0 0000000000000000    <1>     dd 0,0
   104 000018E8 0000000000000000    <1>     dd 0,0
   105 000018F0 00000000            <1>     dw 0,0
   106 000018F4 800000C0            <1>     dd 0xC0000080      ; READ | WRITE | UNINITIALIZED_DATA
   107                              <1> 
   108                              <1> headers_end:
   109                              <1> 
   110                              <1> ; Auf Dateialignment auffüllen
   111 000018F8 00<rep 108h>        <1> times (SIZEOF_HEADERS - ($ - $$)) db 0
    19                                  
    20                                  ; -----------------------------------------------------------------------------
    21                                  ; .text (Code)
    22                                  ; -----------------------------------------------------------------------------
    23                                  section .text
    24                                  text_start:
    25                                  
    26                                  %include 'code64.asm'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  code64.asm
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> bits 64
     9                              <1> 
    10                              <1> _start:
    11                              <1> ;   mov rbp, rsp
    12                              <1> ;    and rsp,-16
    13                              <1> 
    14 00001A00 4883EC28            <1>     sub rsp, 40
    15 00001A04 E830030000          <1>     call PASCALMAIN
    16                              <1> 
    17 00001A09 B93E000000          <1>     mov rcx, 62
    18                              <1>     CALL_IAT ExitProcess
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001A0E 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00001A12 48B890320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001A1B 00                  <2>
   174 00001A1C FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00001A1E 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    19 00001A22 C3                  <1>     ret
    20                              <1> 
    21                              <1>     ; hInstance holen
    22 00001A23 31C9                <1>     xor     ecx, ecx
    23                              <1>     CALL_IAT GetModuleHandleW         ; rcx = NULL
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001A25 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00001A29 48B8E0320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001A32 00                  <2>
   174 00001A33 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00001A35 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    24 00001A39 4989C6              <1>     mov     r14, rax                  ; HINSTANCE in callee-saved Reg
    25                              <1> 
    26                              <1>     ; ----- WNDCLASSEXW auf dem Stack füllen -----
    27                              <1>     ; Layout (Win64, 80 Bytes):
    28                              <1>     ;  0 cbSize         (4) 
    29                              <1>     ;  4 style          (4)  1
    30                              <1>     ;  8 lpfnWndProc    (8)  2
    31                              <1>     ; 16 cbClsExtra     (4)
    32                              <1>     ; 20 cbWndExtra     (4)  3
    33                              <1>     ; 24 hInstance      (8)  4
    34                              <1>     ; 32 hIcon          (8)  5
    35                              <1>     ; 40 hCursor        (8)  6
    36                              <1>     ; 48 hbrBackground  (8)  7
    37                              <1>     ; 56 lpszMenuName   (8)  8 
    38                              <1>     ; 64 lpszClassName  (8)  9
    39                              <1>     ; 72 hIconSm        (8) 10
    40                              <1>     AddShadow (8 * 10)                  ; size of WNDCLASSEXW
    82                              <2> %if %0 == 1
    83 00001A3C 4883EC50            <2>  sub rsp, %1
    84                              <2> %else
    85                              <2>  sub rsp, SW_SHADOW
    86                              <2> %endif
    41 00001A40 4889E7              <1>     mov     rdi, rsp                    ; rdi = &wc
    42                              <1> 
    43                              <1>     ; Zero init
    44 00001A43 FC                  <1>     cld                                 ; (sicherstellen, dass DF=0 ist)
    45 00001A44 31C0                <1>     xor     eax, eax                    ; rax = 0
    46 00001A46 B90A000000          <1>     mov     ecx, 10                     ; 10 qwords
    47 00001A4B F348AB              <1>     rep     stosq
    48                              <1> 
    49 00001A4E C70750000000        <1>     mov     dword [rdi + 0], 80                           ; cbSize
    50 00001A54 C7470403000000      <1>     mov     dword [rdi + 4], CS_HREDRAW | CS_VREDRAW      ; style
    51                              <1> 
    52                              <1>     ; lpfnWndProc = &WndProc (absolute VA)
    53 00001A5B 48B800000040010000- <1>     mov     rax, IMAGE_BASE
    53 00001A64 00                  <1>
    54 00001A65 48057F220000        <1>     add     rax, RVA_TEXT(WndProc)
    55 00001A6B 48894708            <1>     mov     [rdi + 8], rax
    56                              <1> 
    57                              <1>     ; hInstance
    58 00001A6F 4C897718            <1>     mov     [rdi + 24], r14
    59                              <1> 
    60                              <1>     ; hIcon = NULL
    61                              <1>     ;mov     qword [rdi + 32], 0
    62                              <1> 
    63                              <1>     ; hCursor = LoadCursorW(NULL, IDC_ARROW)
    64                              <1>     ; --- Aufruf: Systemcursor laden
    65                              <1>     ; (hInstance   = NULL,
    66                              <1>     ; lpCursorName = MAKEINTRESOURCEW(IDC_ARROW)) ---
    67 00001A73 31C9                <1>     xor     ecx, ecx
    68 00001A75 BA007F0000          <1>     mov     edx, IDC_ARROW
    69 00001A7A 4883EC20            <1>     sub     rsp, 32
    70                              <1>     ;call_LoadCursorW
    71 00001A7E 48B800000040010000- <1>     mov     rax, IMAGE_BASE
    71 00001A87 00                  <1>
    72 00001A88 480508340000        <1>     add     rax, RVA_IDATA(IAT_win32_LoadCursorW)
    73 00001A8E FF10                <1>     call    [rax]
    74 00001A90 4883C420            <1>     add     rsp, 32
    75 00001A94 48894728            <1>     mov     [rdi + 40], rax
    76                              <1> 
    77                              <1>     ; hbrBackground = (HBRUSH)(COLOR_WINDOW+1)
    78 00001A98 48C7473006000000    <1>     mov     qword [rdi + 48], COLOR_WINDOW + 1
    79                              <1> 
    80                              <1>     ; lpszMenuName = NULL
    81 00001AA0 48C7473800000000    <1>     mov     qword [rdi + 56], 0
    82                              <1> 
    83                              <1>     ; lpszClassName = &winclassW (UTF-16)
    84                              <1>     GETEXT  rax, winclassW
   384 00001AA8 48B800000040010000- <2>  mov %1, IMAGE_BASE
   384 00001AB1 00                  <2>
   385 00001AB2 4805B8400000        <2>  add %1, RVA_DATA(_cW_%2)
    85 00001AB8 48894740            <1>     mov     [rdi + 64], rax
    86                              <1> 
    87                              <1>     ; hIconSm = NULL
    88                              <1>     ;mov     qword [rdi + 72], 0
    89                              <1> 
    90                              <1>     ; RegisterClassExW(&wc)
    91 00001ABC 4889F9              <1>     mov     rcx, rdi
    92 00001ABF 4883EC20            <1>     sub     rsp, 32
    93                              <1>     ;CALL_IAT RegisterClassExW
    94 00001AC3 48B800000040010000- <1>     mov     rax, IMAGE_BASE
    94 00001ACC 00                  <1>
    95 00001ACD 480530340000        <1>     add     rax, RVA_IDATA(IAT_win32_RegisterClassExW)
    96 00001AD3 FF10                <1>     call    [rax]
    97 00001AD5 4883C420            <1>     add     rsp, 32
    98 00001AD9 85C0                <1>     test    eax, eax
    99 00001ADB 0F8445010000        <1>     jz      .reg_fail
   100                              <1> 
   101                              <1>     .class_ok:
   102                              <1>     ;ShowMessageW ClassOkW,capW
   103                              <1>     ; ------------------------------------------------------------------------
   104                              <1>     ; CreateWindowExW(
   105                              <1>     ;   0, class, title, WS_OVERLAPPEDWINDOW,
   106                              <1>     ;   CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,
   107                              <1>     ;   NULL, NULL, hInstance, NULL)
   108                              <1>     ; ------------------------------------------------------------------------
   109                              <1>     ;AddShadow 32 + 8*8                                 ; 32 Shadow + 8 Args
   110 00001AE1 31C9                <1>     xor     ecx, ecx                                    ;  1. dwExStyle = 0
   111                              <1>     GETEXT  rdx, winclassW                              ;  2. lpClassName
   384 00001AE3 48BA00000040010000- <2>  mov %1, IMAGE_BASE
   384 00001AEC 00                  <2>
   385 00001AED 4881C2B8400000      <2>  add %1, RVA_DATA(_cW_%2)
   112                              <1>     GETEXT  r8 , titleW                                 ;  3. lpWindowName
   384 00001AF4 49B800000040010000- <2>  mov %1, IMAGE_BASE
   384 00001AFD 00                  <2>
   385 00001AFE 4981C07E400000      <2>  add %1, RVA_DATA(_cW_%2)
   113 00001B05 41B90000CF00        <1>     mov     r9d, WS_OVERLAPPEDWINDOW                    ;  4. dwStyle
   114                              <1> 
   115                              <1>     ; 5.–12. Parameter auf den Stack (in der Reihenfolge!)
   116                              <1>     ;AddShadow 32 + 8*8
   117 00001B0B 4883EC60            <1>     sub     rsp, 32 + 8*8
   118 00001B0F C744242064000000    <1>     mov     dword [rsp+32], 100 ;CW_USEDEFAULT             ;  5. X
   119 00001B17 C744242864000000    <1>     mov     dword [rsp+40], 100 ; CW_USEDEFAULT             ;  6. Y
   120 00001B1F C744243049010000    <1>     mov     dword [rsp+48], 329 ;CW_USEDEFAULT             ;  7. nWidth
   121 00001B27 C7442438C8000000    <1>     mov     dword [rsp+56], 200 ;CW_USEDEFAULT             ;  8, nHeight
   122 00001B2F 48C744244000000000  <1>     mov     qword [rsp+64], 0                         ;  9. hWndParent
   123 00001B38 48C744244800000000  <1>     mov     qword [rsp+72], 0                         ; 10. hMenu
   124 00001B41 4C89742450          <1>     mov     [rsp+80], r14                             ; 11. hInstance
   125 00001B46 48C744245800000000  <1>     mov     qword [rsp+88], 0                         ; 12. lpParam
   126                              <1>     
   127 00001B4F 48B800000040010000- <1>     mov     rax, IMAGE_BASE
   127 00001B58 00                  <1>
   128 00001B59 480598330000        <1>     add     rax, RVA_IDATA(IAT_win32_CreateWindowExW)
   129 00001B5F FF10                <1>     call    [rax]
   130                              <1>     
   131 00001B61 4883C460            <1>     add     rsp, 32 + 8*8
   132                              <1>     
   133 00001B65 4885C0              <1>     test    rax, rax
   134 00001B68 0F84D8000000        <1>     jz      .cw_fail                  ; <--- here jump
   135                              <1>     
   136 00001B6E 4889C6              <1>     mov    rsi, rax
   137                              <1>     
   138                              <1>     ; Show / Update
   139 00001B71 4889F1              <1>     mov     rcx, rsi
   140 00001B74 BA05000000          <1>     mov     edx, 5                            ; SW_SHOW
   141 00001B79 4883EC20            <1>     sub     rsp, 32
   142 00001B7D 48B800000040010000- <1>     mov     rax, IMAGE_BASE
   142 00001B86 00                  <1>
   143 00001B87 480550340000        <1>     add     rax, RVA_IDATA(IAT_win32_ShowWindow)
   144 00001B8D FF10                <1>     call    [rax]
   145 00001B8F 4883C420            <1>     add     rsp, 32
   146                              <1> 
   147 00001B93 4889F1              <1>     mov     rcx, rsi
   148 00001B96 4883EC20            <1>     sub     rsp, 32
   149 00001B9A 48B800000040010000- <1>     mov     rax, IMAGE_BASE
   149 00001BA3 00                  <1>
   150 00001BA4 480568340000        <1>     add     rax, RVA_IDATA(IAT_win32_UpdateWindow)
   151 00001BAA FF10                <1>     call    [rax]
   152 00001BAC 4883C420            <1>     add     rsp, 32
   153                              <1> 
   154                              <1>     ; --- Message loop (MSG=48B) ---
   155 00001BB0 4883EC30            <1>     sub     rsp, 48
   156 00001BB4 4889E3              <1>     mov     rbx, rsp
   157                              <1>     .msg:
   158 00001BB7 4889D9              <1>         mov     rcx, rbx
   159 00001BBA 31D2                <1>         xor     edx, edx
   160 00001BBC 4531C0              <1>         xor     r8d, r8d
   161 00001BBF 4531C9              <1>         xor     r9d, r9d
   162 00001BC2 4883EC20            <1>         sub     rsp, 32
   163 00001BC6 48B800000040010000- <1>         mov     rax, IMAGE_BASE
   163 00001BCF 00                  <1>
   164 00001BD0 4805D8330000        <1>         add     rax, RVA_IDATA(IAT_win32_GetMessageW)
   165 00001BD6 FF10                <1>         call    [rax]
   166 00001BD8 4883C420            <1>         add     rsp, 32
   167 00001BDC 85C0                <1>         test    eax, eax
   168 00001BDE 743C                <1>         jz      .quit
   169                              <1> 
   170 00001BE0 4889D9              <1>         mov     rcx, rbx
   171 00001BE3 4883EC20            <1>         sub     rsp, 32
   172 00001BE7 48B800000040010000- <1>         mov     rax, IMAGE_BASE
   172 00001BF0 00                  <1>
   173 00001BF1 480560340000        <1>         add     rax, RVA_IDATA(IAT_win32_TranslateMessage)
   174 00001BF7 FF10                <1>         call    [rax]
   175 00001BF9 4883C420            <1>         add     rsp, 32
   176                              <1> 
   177 00001BFD 4889D9              <1>         mov     rcx, rbx
   178 00001C00 4883EC20            <1>         sub     rsp, 32
   179 00001C04 48B800000040010000- <1>         mov     rax, IMAGE_BASE
   179 00001C0D 00                  <1>
   180 00001C0E 4805A8330000        <1>         add     rax, RVA_IDATA(IAT_win32_DispatchMessageW)
   181 00001C14 FF10                <1>         call    [rax]
   182 00001C16 4883C420            <1>         add     rsp, 32
   183 00001C1A EB9B                <1>         jmp     .msg
   184                              <1>     .quit:
   185 00001C1C 4883C430            <1>     add     rsp, 48
   186                              <1> 
   187                              <1>     ; Aufräumen WNDCLASSEXW-Reserve
   188 00001C20 4883C450            <1>     add     rsp, 80
   189 00001C24 EB40                <1>     jmp     .ok
   190                              <1> 
   191                              <1>     .reg_fail:
   192                              <1>         ; GetLastError + anzeigen (du hast die Routine schon)
   193 00001C26 4883EC20            <1>         sub     rsp,32
   194 00001C2A 48B800000040010000- <1>         mov     rax, IMAGE_BASE
   194 00001C33 00                  <1>
   195 00001C34 4805D8320000        <1>         add     rax, RVA_IDATA(IAT_win32_GetLastError)
   196 00001C3A FF10                <1>         call    [rax]
   197 00001C3C 4883C420            <1>         add     rsp,32
   198                              <1>         ; eax -> deine Fehleranzeige
   199 00001C40 4883C450            <1>         add     rsp, 80
   200 00001C44 EB20                <1>         jmp     .done
   201                              <1>         
   202                              <1>     .cw_fail:
   203 00001C46 4883EC20            <1>         sub     rsp,32
   204 00001C4A 48B800000040010000- <1>         mov     rax, IMAGE_BASE
   204 00001C53 00                  <1>
   205 00001C54 4805D8320000        <1>         add     rax, RVA_IDATA(IAT_win32_GetLastError)
   206 00001C5A FF10                <1>         call    [rax]
   207 00001C5C 4883C420            <1>         add     rsp,32
   208                              <1>         ; eax -> deine Fehleranzeige
   209 00001C60 4883C450            <1>         add     rsp, 80
   210 00001C64 EB00                <1>         jmp     .done
   211                              <1>         
   212                              <1>     .ok:
   213                              <1>     .done:
   214                              <1>     
   215                              <1>     call_ExitProcess 2
   592                              <2> %if DOS_SHELL == 1
   593                              <2>  %error ERROR_Win32API
   594                              <2> %else
   595                              <2>  %if %0 == 1
   596 00001C66 B802000000          <2>  mov rax, %1
   597                              <2>  %else
   598                              <2>  mov rax, 0
   599                              <2>  %endif
   600                              <2>  CALL_IAT ExitProcess
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00001C6B 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 00001C6F 48B890320040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001C78 00                  <3>
   174 00001C79 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00001C7B 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
   601                              <2> %endif
    27                                  %include 'winproc.asm'
     1                              <1> bits 64
     2                              <1> 
     3                              <1> WndProc:
     4                              <1>     AddShadow
    82                              <2> %if %0 == 1
    83                              <2>  sub rsp, %1
    84                              <2> %else
    85 00001C7F 4883EC20            <2>  sub rsp, SW_SHADOW
    86                              <2> %endif
     5                              <1>     MESSAGE WM_CLOSE,wm_close
   847 00001C83 83FA10              <2>  cmp edx, %1
   848 00001C86 0F8490000000        <2>  je .%2
     6                              <1>     MESSAGE WM_ERASEBKGND,wm_erasebkgnd
   847 00001C8C 83FA14              <2>  cmp edx, %1
   848 00001C8F 7410                <2>  je .%2
     7                              <1>     DefWindowProcW
   747 00001C91 48B8A0330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_DefWindowProcW)
   747 00001C9A 00                  <2>
     8                              <1>     DelShadow
    93                              <2> %if %0 == 1
    94                              <2>  add rsp, %1
    95                              <2> %else
    96 00001C9B 4883C420            <2>  add rsp, SW_SHADOW
    97                              <2> %endif
     9 00001C9F FF20                <1>     jmp [rax]
    10                              <1> .wm_erasebkgnd:
    11                              <1>     AddShadow 48
    82                              <2> %if %0 == 1
    83 00001CA1 4883EC30            <2>  sub rsp, %1
    84                              <2> %else
    85                              <2>  sub rsp, SW_SHADOW
    86                              <2> %endif
    12 00001CA5 48894C2420          <1>     mov [rsp+32],rcx
    13 00001CAA 4C89442428          <1>     mov [rsp+40],r8
    14 00001CAF 488D542410          <1>     lea rdx,[rsp+16]
    15 00001CB4 488B4C2420          <1>     mov rcx,[rsp+32]
    16                              <1>     CALL_IAT GetClientRect
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001CB9 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00001CBD 48B8D0330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001CC6 00                  <2>
   174 00001CC7 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00001CC9 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    17 00001CCD 488B4C2420          <1>     mov rcx,[rsp+32]
    18 00001CD2 48C7C2F6FFFFFF      <1>     mov rdx,GCLP_HBRBACKGROUND
    19                              <1>     CALL_IAT GetClassLongPtrW
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001CD9 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00001CDD 48B8C8330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001CE6 00                  <2>
   174 00001CE7 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00001CE9 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    20 00001CED 488B4C2428          <1>     mov rcx,[rsp+40]
    21 00001CF2 488D542410          <1>     lea rdx,[rsp+16]
    22 00001CF7 4989C0              <1>     mov r8,rax
    23                              <1>     CALL_IAT FillRect
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001CFA 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00001CFE 48B8C0330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001D07 00                  <2>
   174 00001D08 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00001D0A 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    24                              <1>     Return 1
   496                              <2> %if %0 == 1
   497 00001D0E B801000000          <2>  mov eax, %1
   498                              <2> %else
   499                              <2>  ret
   500                              <2> %endif
    25                              <1>     DelShadow 48
    93                              <2> %if %0 == 1
    94 00001D13 4883C430            <2>  add rsp, %1
    95                              <2> %else
    96                              <2>  add rsp, SW_SHADOW
    97                              <2> %endif
    26                              <1>     DelShadow
    93                              <2> %if %0 == 1
    94                              <2>  add rsp, %1
    95                              <2> %else
    96 00001D17 4883C420            <2>  add rsp, SW_SHADOW
    97                              <2> %endif
    27 00001D1B C3                  <1>     ret
    28                              <1> .wm_close:
    29                              <1>     Zero ecx
   182 00001D1C 31C9                <2>  xor %1, %1
    30                              <1>     CALL_IAT PostQuitMessage
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001D1E 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00001D22 48B858340040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001D2B 00                  <2>
   174 00001D2C FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00001D2E 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    31                              <1>     DelShadow
    93                              <2> %if %0 == 1
    94                              <2>  add rsp, %1
    95                              <2> %else
    96 00001D32 4883C420            <2>  add rsp, SW_SHADOW
    97                              <2> %endif
    32                              <1>     Zero eax
   182 00001D36 31C0                <2>  xor %1, %1
    33 00001D38 C3                  <1>     ret
    28                                  %include 'text64.asm'
     1                              <1> PASCALMAIN:
     2                              <1> ; -------------------------------------------------------------------
     3                              <1> ; 64 Bytes reservieren:
     4                              <1> ;  - 32 B Shadow Space (Pflicht als Caller vor jedem call)
     5                              <1> ;  - 32 B "lokal" (hier ungenutzt, dient auch dem Alignment)
     6                              <1> ; Nach push rbp ist rsp 16-Byte aligned; 64 hlt das Alignment.
     7                              <1> ; -------------------------------------------------------------------
     8                              <1>     FUNC_ENTER
   546                              <2> %if %0 == 1
   547                              <2>  AddShadow %1
   548                              <2> %else
   549                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00001D39 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   550                              <2> %endif
   551 00001D3D 55                  <2>  push rbp
   552 00001D3E 4889E5              <2>  mov rbp, rsp
     9                              <1> 
    10                              <1>     INIT_CONSOLE
  1438                              <2> %if DOS_SHELL == 1
  1439                              <2>  call dos_init_console
  1440                              <2>  SCREEN_CLEAR
  1441                              <2> %else
  1442 00001D41 E83B040000          <2>  call init_app
  1443 00001D46 E85D040000          <2>  call init_console
  1444                              <2> %endif
    11                              <1>         
    12                              <1>     ; text + prompt ausgeben
    13                              <1>     WRITE_CON_A cap2A
   981                              <2> %if DOS_SHELL == 1
   982                              <2>  %if %0 == 2
   983                              <2>  PUTS_COLOR %1, %2
   984                              <2>  %else
   985                              <2>  PUTS_COLOR %1, 0x07
   986                              <2>  %endif
   987                              <2> %else
   988                              <2> 
   989 00001D4B 31C0                <2>  xor eax, eax
   990 00001D4D 48B900400040010000- <2>  mov rcx, PTR64(_cA_%1)
   990 00001D56 00                  <2>
   991 00001D57 E894070000          <2>  call GET_STR_LEN
   992 00001D5C 4989C6              <2>  mov r14, rax
   993                              <2>  GET_CON_O_HANDLE r12
  1081                              <3> %if DOS_SHELL == 1
  1082                              <3>  %error ERROR_Win32API
  1083                              <3> %else
  1084 00001D5F B9F5FFFFFF          <3>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 00001D64 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00001D68 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001D71 00                  <4>
   174 00001D72 FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 00001D74 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1086 00001D78 4989C4              <3>  mov %1, rax
  1087                              <3> %endif
   994 00001D7B 4C89E1              <2>  mov rcx, r12
   995 00001D7E 48BA00400040010000- <2>  mov rdx, PTR64(_cA_%1)
   995 00001D87 00                  <2>
   996 00001D88 4D89F0              <2>  mov r8 , r14
   997 00001D8B 4531C9              <2>  xor r9d, r9d
   998 00001D8E 48C744242000000000  <2>  mov qword [rsp+32], 0
   999                              <2>  CALL_IAT WriteConsoleA
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00001D97 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 00001D9B 48B878330040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001DA4 00                  <3>
   174 00001DA5 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00001DA7 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1000                              <2> %endif
    14                              <1>     WRITE_CON_A prompt
   981                              <2> %if DOS_SHELL == 1
   982                              <2>  %if %0 == 2
   983                              <2>  PUTS_COLOR %1, %2
   984                              <2>  %else
   985                              <2>  PUTS_COLOR %1, 0x07
   986                              <2>  %endif
   987                              <2> %else
   988                              <2> 
   989 00001DAB 31C0                <2>  xor eax, eax
   990 00001DAD 48B9D2400040010000- <2>  mov rcx, PTR64(_cA_%1)
   990 00001DB6 00                  <2>
   991 00001DB7 E834070000          <2>  call GET_STR_LEN
   992 00001DBC 4989C6              <2>  mov r14, rax
   993                              <2>  GET_CON_O_HANDLE r12
  1081                              <3> %if DOS_SHELL == 1
  1082                              <3>  %error ERROR_Win32API
  1083                              <3> %else
  1084 00001DBF B9F5FFFFFF          <3>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 00001DC4 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00001DC8 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001DD1 00                  <4>
   174 00001DD2 FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 00001DD4 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1086 00001DD8 4989C4              <3>  mov %1, rax
  1087                              <3> %endif
   994 00001DDB 4C89E1              <2>  mov rcx, r12
   995 00001DDE 48BAD2400040010000- <2>  mov rdx, PTR64(_cA_%1)
   995 00001DE7 00                  <2>
   996 00001DE8 4D89F0              <2>  mov r8 , r14
   997 00001DEB 4531C9              <2>  xor r9d, r9d
   998 00001DEE 48C744242000000000  <2>  mov qword [rsp+32], 0
   999                              <2>  CALL_IAT WriteConsoleA
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00001DF7 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 00001DFB 48B878330040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001E04 00                  <3>
   174 00001E05 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00001E07 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1000                              <2> %endif
    15                              <1>     READL_CON_A dst
  1008                              <2> %if DOS_SHELL == 1
  1009                              <2>  %if %0 == 1
  1010                              <2>  mov dx, PTR16(_cA_%1)
  1011                              <2>  call DOSReadLn
  1012                              <2>  %else
  1013                              <2>  mov dx, PTR16(_cA_dos_buffer)
  1014                              <2>  call DOSReadLn
  1015                              <2>  %endif
  1016                              <2> %else
  1017                              <2> 
  1018                              <2>  GET_CON_I_HANDLE r13
  1094                              <3> %if DOS_SHELL == 1
  1095                              <3>  %error ERROR_Win32API
  1096                              <3> %else
  1097 00001E0B B9F6FFFFFF          <3>  mov ecx, STD_INPUT_HANDLE
  1098                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 00001E10 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00001E14 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001E1D 00                  <4>
   174 00001E1E FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 00001E20 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1099 00001E24 4989C5              <3>  mov %1, rax
  1100                              <3> %endif
  1019                              <2> 
  1020 00001E27 4C89E9              <2>  mov rcx, r13
  1021 00001E2A 48BA-               <2>  mov rdx, PTR64(_cA_%1)
  1021 00001E2C (1810004001000000)  <2>
  1022 00001E34 41B87F000000        <2>  mov r8d, 127
  1023 00001E3A 49B9-               <2>  mov r9 , PTR64(written)
  1023 00001E3C (FD10004001000000)  <2>
  1024 00001E44 4831C0              <2>  xor rax, rax
  1025 00001E47 4889442420          <2>  mov [rsp+32], rax
  1026                              <2>  CALL_IAT ReadConsoleA
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00001E4C 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 00001E50 48B808330040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001E59 00                  <3>
   174 00001E5A FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00001E5C 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1027                              <2> %endif
    16                              <1>     
    17                              <1>     SET_COLOR_TO ATTR_BG_BLACK, ATTR_FG_LIGHT_YELLOW
  1149                              <2> %if %0 == 2
  1150                              <2>  STRCPY_ANSI buffer_B, consoleColor_1, empty
  1049 00001E60 48B9-               <3>  mov rcx, IMAGE_BASE + RVA_DATA(_cA_%1)
  1049 00001E62 (180F004001000000)  <3>
  1050 00001E6A 48BAE2400040010000- <3>  mov rdx, IMAGE_BASE + RVA_DATA(_cA_%2)
  1050 00001E73 00                  <3>
  1051 00001E74 49B8-               <3>  mov r8 , IMAGE_BASE + RVA_DATA(_cA_%3)
  1051 00001E76 (A010004001000000)  <3>
  1052 00001E7E E842060000          <3>  call concat_ansi
  1151                              <2>  STRCAT_ANSI buffer_B, console_color_%1, buffer_semi, console_color_%2, consoleColor_2
  1055                              <3>  %xdefine __DSTSYM (_cA_%1 + 4)
  1056                              <3> 
  1057                              <3>  %rotate 1
  1058                              <3>  %rep %0-1
  1059                              <3> 
  1060                              <3>  mov rdi, IMAGE_BASE
  1061                              <3>  add rdi, RVA_DATA(__DSTSYM)
  1062                              <3>  xor eax, eax
  1063                              <3>  mov rcx, -1
  1064                              <3>  repne scasb
  1065                              <3>  lea rcx, [rdi - 1]
  1066                              <3> 
  1067                              <3> 
  1068                              <3>  mov rdx, PTR64(_cA_%1)
  1069                              <3>  mov r8 , PTR64(_cA_empty)
  1070                              <3>  call concat_ansi
  1071                              <3> 
  1072                              <3>  %rotate 1
  1073                              <3>  %endrep
  1059                              <4> 
  1060 00001E83 48BF00000040010000- <4>  mov rdi, IMAGE_BASE
  1060 00001E8C 00                  <4>
  1061 00001E8D 4881C7(1C0F0000)    <4>  add rdi, RVA_DATA(__DSTSYM)
  1062 00001E94 31C0                <4>  xor eax, eax
  1063 00001E96 48C7C1FFFFFFFF      <4>  mov rcx, -1
  1064 00001E9D F2AE                <4>  repne scasb
  1065 00001E9F 488D4FFF            <4>  lea rcx, [rdi - 1]
  1066                              <4> 
  1067                              <4> 
  1068 00001EA3 48BA26410040010000- <4>  mov rdx, PTR64(_cA_%1)
  1068 00001EAC 00                  <4>
  1069 00001EAD 49B8-               <4>  mov r8 , PTR64(_cA_empty)
  1069 00001EAF (A010004001000000)  <4>
  1070 00001EB7 E809060000          <4>  call concat_ansi
  1071                              <4> 
  1072                              <4>  %rotate 1
  1059                              <4> 
  1060 00001EBC 48BF00000040010000- <4>  mov rdi, IMAGE_BASE
  1060 00001EC5 00                  <4>
  1061 00001EC6 4881C7(1C0F0000)    <4>  add rdi, RVA_DATA(__DSTSYM)
  1062 00001ECD 31C0                <4>  xor eax, eax
  1063 00001ECF 48C7C1FFFFFFFF      <4>  mov rcx, -1
  1064 00001ED6 F2AE                <4>  repne scasb
  1065 00001ED8 488D4FFF            <4>  lea rcx, [rdi - 1]
  1066                              <4> 
  1067                              <4> 
  1068 00001EDC 48BAF4400040010000- <4>  mov rdx, PTR64(_cA_%1)
  1068 00001EE5 00                  <4>
  1069 00001EE6 49B8-               <4>  mov r8 , PTR64(_cA_empty)
  1069 00001EE8 (A010004001000000)  <4>
  1070 00001EF0 E8D0050000          <4>  call concat_ansi
  1071                              <4> 
  1072                              <4>  %rotate 1
  1059                              <4> 
  1060 00001EF5 48BF00000040010000- <4>  mov rdi, IMAGE_BASE
  1060 00001EFE 00                  <4>
  1061 00001EFF 4881C7(1C0F0000)    <4>  add rdi, RVA_DATA(__DSTSYM)
  1062 00001F06 31C0                <4>  xor eax, eax
  1063 00001F08 48C7C1FFFFFFFF      <4>  mov rcx, -1
  1064 00001F0F F2AE                <4>  repne scasb
  1065 00001F11 488D4FFF            <4>  lea rcx, [rdi - 1]
  1066                              <4> 
  1067                              <4> 
  1068 00001F15 48BA17410040010000- <4>  mov rdx, PTR64(_cA_%1)
  1068 00001F1E 00                  <4>
  1069 00001F1F 49B8-               <4>  mov r8 , PTR64(_cA_empty)
  1069 00001F21 (A010004001000000)  <4>
  1070 00001F29 E897050000          <4>  call concat_ansi
  1071                              <4> 
  1072                              <4>  %rotate 1
  1059                              <4> 
  1060 00001F2E 48BF00000040010000- <4>  mov rdi, IMAGE_BASE
  1060 00001F37 00                  <4>
  1061 00001F38 4881C7(1C0F0000)    <4>  add rdi, RVA_DATA(__DSTSYM)
  1062 00001F3F 31C0                <4>  xor eax, eax
  1063 00001F41 48C7C1FFFFFFFF      <4>  mov rcx, -1
  1064 00001F48 F2AE                <4>  repne scasb
  1065 00001F4A 488D4FFF            <4>  lea rcx, [rdi - 1]
  1066                              <4> 
  1067                              <4> 
  1068 00001F4E 48BAE7400040010000- <4>  mov rdx, PTR64(_cA_%1)
  1068 00001F57 00                  <4>
  1069 00001F58 49B8-               <4>  mov r8 , PTR64(_cA_empty)
  1069 00001F5A (A010004001000000)  <4>
  1070 00001F62 E85E050000          <4>  call concat_ansi
  1071                              <4> 
  1072                              <4>  %rotate 1
  1154                              <2>  WRITE_CON_A buffer_B
   981                              <3> %if DOS_SHELL == 1
   982                              <3>  %if %0 == 2
   983                              <3>  PUTS_COLOR %1, %2
   984                              <3>  %else
   985                              <3>  PUTS_COLOR %1, 0x07
   986                              <3>  %endif
   987                              <3> %else
   988                              <3> 
   989 00001F67 31C0                <3>  xor eax, eax
   990 00001F69 48B9-               <3>  mov rcx, PTR64(_cA_%1)
   990 00001F6B (180F004001000000)  <3>
   991 00001F73 E878050000          <3>  call GET_STR_LEN
   992 00001F78 4989C6              <3>  mov r14, rax
   993                              <3>  GET_CON_O_HANDLE r12
  1081                              <4> %if DOS_SHELL == 1
  1082                              <4>  %error ERROR_Win32API
  1083                              <4> %else
  1084 00001F7B B9F5FFFFFF          <4>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <4>  CALL_IAT GetStdHandle
   172                              <5>  AddShadow
    82                              <6> %if %0 == 1
    83                              <6>  sub rsp, %1
    84                              <6> %else
    85 00001F80 4883EC20            <6>  sub rsp, SW_SHADOW
    86                              <6> %endif
   173 00001F84 48B8F0320040010000- <5>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001F8D 00                  <5>
   174 00001F8E FF10                <5>  call [rax]
   175                              <5>  DelShadow
    93                              <6> %if %0 == 1
    94                              <6>  add rsp, %1
    95                              <6> %else
    96 00001F90 4883C420            <6>  add rsp, SW_SHADOW
    97                              <6> %endif
  1086 00001F94 4989C4              <4>  mov %1, rax
  1087                              <4> %endif
   994 00001F97 4C89E1              <3>  mov rcx, r12
   995 00001F9A 48BA-               <3>  mov rdx, PTR64(_cA_%1)
   995 00001F9C (180F004001000000)  <3>
   996 00001FA4 4D89F0              <3>  mov r8 , r14
   997 00001FA7 4531C9              <3>  xor r9d, r9d
   998 00001FAA 48C744242000000000  <3>  mov qword [rsp+32], 0
   999                              <3>  CALL_IAT WriteConsoleA
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 00001FB3 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00001FB7 48B878330040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001FC0 00                  <4>
   174 00001FC1 FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 00001FC3 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1000                              <3> %endif
  1155                              <2> %endif
    18                              <1>     SCREEN_CLEAR
  1104                              <2> %if DOS_SHELL == 1
  1105                              <2>  call dos_screen_clear
  1106                              <2> %else
  1107                              <2>  GET_CON_O_HANDLE r12
  1081                              <3> %if DOS_SHELL == 1
  1082                              <3>  %error ERROR_Win32API
  1083                              <3> %else
  1084 00001FC7 B9F5FFFFFF          <3>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 00001FCC 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00001FD0 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00001FD9 00                  <4>
   174 00001FDA FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 00001FDC 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1086 00001FE0 4989C4              <3>  mov %1, rax
  1087                              <3> %endif
  1108                              <2>  STRCPY_ANSI buffer_B, consoleColor_3, empty
  1049 00001FE3 48B9-               <3>  mov rcx, IMAGE_BASE + RVA_DATA(_cA_%1)
  1049 00001FE5 (180F004001000000)  <3>
  1050 00001FED 48BAE9400040010000- <3>  mov rdx, IMAGE_BASE + RVA_DATA(_cA_%2)
  1050 00001FF6 00                  <3>
  1051 00001FF7 49B8-               <3>  mov r8 , IMAGE_BASE + RVA_DATA(_cA_%3)
  1051 00001FF9 (A010004001000000)  <3>
  1052 00002001 E8BF040000          <3>  call concat_ansi
  1109                              <2>  WRITE_CON_A buffer_B
   981                              <3> %if DOS_SHELL == 1
   982                              <3>  %if %0 == 2
   983                              <3>  PUTS_COLOR %1, %2
   984                              <3>  %else
   985                              <3>  PUTS_COLOR %1, 0x07
   986                              <3>  %endif
   987                              <3> %else
   988                              <3> 
   989 00002006 31C0                <3>  xor eax, eax
   990 00002008 48B9-               <3>  mov rcx, PTR64(_cA_%1)
   990 0000200A (180F004001000000)  <3>
   991 00002012 E8D9040000          <3>  call GET_STR_LEN
   992 00002017 4989C6              <3>  mov r14, rax
   993                              <3>  GET_CON_O_HANDLE r12
  1081                              <4> %if DOS_SHELL == 1
  1082                              <4>  %error ERROR_Win32API
  1083                              <4> %else
  1084 0000201A B9F5FFFFFF          <4>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <4>  CALL_IAT GetStdHandle
   172                              <5>  AddShadow
    82                              <6> %if %0 == 1
    83                              <6>  sub rsp, %1
    84                              <6> %else
    85 0000201F 4883EC20            <6>  sub rsp, SW_SHADOW
    86                              <6> %endif
   173 00002023 48B8F0320040010000- <5>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000202C 00                  <5>
   174 0000202D FF10                <5>  call [rax]
   175                              <5>  DelShadow
    93                              <6> %if %0 == 1
    94                              <6>  add rsp, %1
    95                              <6> %else
    96 0000202F 4883C420            <6>  add rsp, SW_SHADOW
    97                              <6> %endif
  1086 00002033 4989C4              <4>  mov %1, rax
  1087                              <4> %endif
   994 00002036 4C89E1              <3>  mov rcx, r12
   995 00002039 48BA-               <3>  mov rdx, PTR64(_cA_%1)
   995 0000203B (180F004001000000)  <3>
   996 00002043 4D89F0              <3>  mov r8 , r14
   997 00002046 4531C9              <3>  xor r9d, r9d
   998 00002049 48C744242000000000  <3>  mov qword [rsp+32], 0
   999                              <3>  CALL_IAT WriteConsoleA
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 00002052 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00002056 48B878330040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000205F 00                  <4>
   174 00002060 FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 00002062 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1000                              <3> %endif
  1110                              <2> %endif
    19                              <1> 
    20                              <1>     WRITE_CON_A  dst
   981                              <2> %if DOS_SHELL == 1
   982                              <2>  %if %0 == 2
   983                              <2>  PUTS_COLOR %1, %2
   984                              <2>  %else
   985                              <2>  PUTS_COLOR %1, 0x07
   986                              <2>  %endif
   987                              <2> %else
   988                              <2> 
   989 00002066 31C0                <2>  xor eax, eax
   990 00002068 48B9-               <2>  mov rcx, PTR64(_cA_%1)
   990 0000206A (1810004001000000)  <2>
   991 00002072 E879040000          <2>  call GET_STR_LEN
   992 00002077 4989C6              <2>  mov r14, rax
   993                              <2>  GET_CON_O_HANDLE r12
  1081                              <3> %if DOS_SHELL == 1
  1082                              <3>  %error ERROR_Win32API
  1083                              <3> %else
  1084 0000207A B9F5FFFFFF          <3>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 0000207F 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 00002083 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000208C 00                  <4>
   174 0000208D FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 0000208F 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1086 00002093 4989C4              <3>  mov %1, rax
  1087                              <3> %endif
   994 00002096 4C89E1              <2>  mov rcx, r12
   995 00002099 48BA-               <2>  mov rdx, PTR64(_cA_%1)
   995 0000209B (1810004001000000)  <2>
   996 000020A3 4D89F0              <2>  mov r8 , r14
   997 000020A6 4531C9              <2>  xor r9d, r9d
   998 000020A9 48C744242000000000  <2>  mov qword [rsp+32], 0
   999                              <2>  CALL_IAT WriteConsoleA
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 000020B2 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 000020B6 48B878330040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000020BF 00                  <3>
   174 000020C0 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 000020C2 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1000                              <2> %endif
    21                              <1>     WRITE_CON_A  prompt
   981                              <2> %if DOS_SHELL == 1
   982                              <2>  %if %0 == 2
   983                              <2>  PUTS_COLOR %1, %2
   984                              <2>  %else
   985                              <2>  PUTS_COLOR %1, 0x07
   986                              <2>  %endif
   987                              <2> %else
   988                              <2> 
   989 000020C6 31C0                <2>  xor eax, eax
   990 000020C8 48B9D2400040010000- <2>  mov rcx, PTR64(_cA_%1)
   990 000020D1 00                  <2>
   991 000020D2 E819040000          <2>  call GET_STR_LEN
   992 000020D7 4989C6              <2>  mov r14, rax
   993                              <2>  GET_CON_O_HANDLE r12
  1081                              <3> %if DOS_SHELL == 1
  1082                              <3>  %error ERROR_Win32API
  1083                              <3> %else
  1084 000020DA B9F5FFFFFF          <3>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 000020DF 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 000020E3 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000020EC 00                  <4>
   174 000020ED FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 000020EF 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1086 000020F3 4989C4              <3>  mov %1, rax
  1087                              <3> %endif
   994 000020F6 4C89E1              <2>  mov rcx, r12
   995 000020F9 48BAD2400040010000- <2>  mov rdx, PTR64(_cA_%1)
   995 00002102 00                  <2>
   996 00002103 4D89F0              <2>  mov r8 , r14
   997 00002106 4531C9              <2>  xor r9d, r9d
   998 00002109 48C744242000000000  <2>  mov qword [rsp+32], 0
   999                              <2>  CALL_IAT WriteConsoleA
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00002112 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 00002116 48B878330040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000211F 00                  <3>
   174 00002120 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00002122 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1000                              <2> %endif
    22                              <1>     
    23                              <1>     READL_CON_A  dst
  1008                              <2> %if DOS_SHELL == 1
  1009                              <2>  %if %0 == 1
  1010                              <2>  mov dx, PTR16(_cA_%1)
  1011                              <2>  call DOSReadLn
  1012                              <2>  %else
  1013                              <2>  mov dx, PTR16(_cA_dos_buffer)
  1014                              <2>  call DOSReadLn
  1015                              <2>  %endif
  1016                              <2> %else
  1017                              <2> 
  1018                              <2>  GET_CON_I_HANDLE r13
  1094                              <3> %if DOS_SHELL == 1
  1095                              <3>  %error ERROR_Win32API
  1096                              <3> %else
  1097 00002126 B9F6FFFFFF          <3>  mov ecx, STD_INPUT_HANDLE
  1098                              <3>  CALL_IAT GetStdHandle
   172                              <4>  AddShadow
    82                              <5> %if %0 == 1
    83                              <5>  sub rsp, %1
    84                              <5> %else
    85 0000212B 4883EC20            <5>  sub rsp, SW_SHADOW
    86                              <5> %endif
   173 0000212F 48B8F0320040010000- <4>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002138 00                  <4>
   174 00002139 FF10                <4>  call [rax]
   175                              <4>  DelShadow
    93                              <5> %if %0 == 1
    94                              <5>  add rsp, %1
    95                              <5> %else
    96 0000213B 4883C420            <5>  add rsp, SW_SHADOW
    97                              <5> %endif
  1099 0000213F 4989C5              <3>  mov %1, rax
  1100                              <3> %endif
  1019                              <2> 
  1020 00002142 4C89E9              <2>  mov rcx, r13
  1021 00002145 48BA-               <2>  mov rdx, PTR64(_cA_%1)
  1021 00002147 (1810004001000000)  <2>
  1022 0000214F 41B87F000000        <2>  mov r8d, 127
  1023 00002155 49B9-               <2>  mov r9 , PTR64(written)
  1023 00002157 (FD10004001000000)  <2>
  1024 0000215F 4831C0              <2>  xor rax, rax
  1025 00002162 4889442420          <2>  mov [rsp+32], rax
  1026                              <2>  CALL_IAT ReadConsoleA
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00002167 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 0000216B 48B808330040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002174 00                  <3>
   174 00002175 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00002177 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1027                              <2> %endif
    24                              <1>     
    25                              <1>     .exit:
    26                              <1>     FUNC_LEAVE
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
   562                              <2> %else
   563                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 0000217B 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   564                              <2> %endif
   565 0000217F 5D                  <2>  pop rbp
   566 00002180 C3                  <2>  ret
    29                                  %include 'stdlib.inc'
     1                              <1> ;---------------------------------------------------
     2                              <1> ; \file  stdlib.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ;---------------------------------------------------
     8                              <1> 
     9                              <1> ; -------------------------------------------------------------------
    10                              <1> ; \brief initialize the application ...
    11                              <1> ; -------------------------------------------------------------------
    12                              <1> ; --- Prolog ---
    13                              <1> init_app:
    14                              <1>     FUNC_ENTER
   546                              <2> %if %0 == 1
   547                              <2>  AddShadow %1
   548                              <2> %else
   549                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00002181 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   550                              <2> %endif
   551 00002185 55                  <2>  push rbp
   552 00002186 4889E5              <2>  mov rbp, rsp
    15                              <1>     
    16 00002189 B9FCFFFFFF          <1>     mov      ecx, DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE_V2
    17                              <1>     CALL_IAT SetProcessDpiAwarenessContext
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 0000218E 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002192 48B838340040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000219B 00                  <2>
   174 0000219C FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 0000219E 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    18                              <1>     
    19                              <1>     FUNC_LEAVE
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
   562                              <2> %else
   563                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000021A2 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   564                              <2> %endif
   565 000021A6 5D                  <2>  pop rbp
   566 000021A7 C3                  <2>  ret
    20                              <1> 
    21                              <1> ; -------------------------------------------------------------------
    22                              <1> ; \brief init_console - initialize a text console under the Windows
    23                              <1> ;        gui desktop.
    24                              <1> ; \param nothing
    25                              <1> ; -------------------------------------------------------------------
    26                              <1> ; --- Prolog ---
    27                              <1> init_console:
    28                              <1>     FUNC_ENTER
   546                              <2> %if %0 == 1
   547                              <2>  AddShadow %1
   548                              <2> %else
   549                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000021A8 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   550                              <2> %endif
   551 000021AC 55                  <2>  push rbp
   552 000021AD 4889E5              <2>  mov rbp, rsp
    29                              <1> 
    30                              <1>     ; --- Konsole öffnen ---
    31                              <1>     CALL_IAT AllocConsole
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000021B0 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 000021B4 48B888320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000021BD 00                  <2>
   174 000021BE FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000021C0 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    32                              <1>     GET_CON_O_HANDLE r12
  1081                              <2> %if DOS_SHELL == 1
  1082                              <2>  %error ERROR_Win32API
  1083                              <2> %else
  1084 000021C4 B9F5FFFFFF          <2>  mov ecx, STD_OUTPUT_HANDLE
  1085                              <2>  CALL_IAT GetStdHandle
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 000021C9 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 000021CD 48B8F0320040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000021D6 00                  <3>
   174 000021D7 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 000021D9 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1086 000021DD 4989C4              <2>  mov %1, rax
  1087                              <2> %endif
    33                              <1> 
    34 000021E0 4C89E1              <1>     mov      rcx, r12
    35 000021E3 488D15(9C020000)    <1>     lea      rdx, [rel mode_out]
    36                              <1>     CALL_IAT GetConsoleMode              ; mode_out
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000021EA 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 000021EE 48B8B0320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000021F7 00                  <2>
   174 000021F8 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000021FA 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    37                              <1>     
    38 000021FE 8B05(9C020000)      <1>     mov     eax, [rel mode_out]          ; Wert laden (NICHT die Adresse!)
    39 00002204 83C804              <1>     or      eax, ENABLE_VIRTUAL_TERMINAL_PROCESSING
    40 00002207 83C808              <1>     or      eax, DISABLE_NEWLINE_AUTO_RETURN     ; optional
    41 0000220A 89C2                <1>     mov     edx, eax                     ; SetConsoleMode(hOut, newMode)
    42 0000220C 4C89E1              <1>     mov     rcx, r12
    43                              <1>     CALL_IAT SetConsoleMode
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 0000220F 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002213 48B840330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000221C 00                  <2>
   174 0000221D FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 0000221F 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    44                              <1> 
    45                              <1>     ; --- INPUT: VT-Input optional aktivieren ---
    46                              <1>     ; hIn besorgen (falls nicht schon vorhanden)
    47                              <1>     GET_CON_I_HANDLE r13                 ; r13 = hIn   (oder mov ecx, STD_INPUT_HANDLE / GetStdHandle)
  1094                              <2> %if DOS_SHELL == 1
  1095                              <2>  %error ERROR_Win32API
  1096                              <2> %else
  1097 00002223 B9F6FFFFFF          <2>  mov ecx, STD_INPUT_HANDLE
  1098                              <2>  CALL_IAT GetStdHandle
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00002228 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 0000222C 48B8F0320040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002235 00                  <3>
   174 00002236 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00002238 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
  1099 0000223C 4989C5              <2>  mov %1, rax
  1100                              <2> %endif
    48                              <1> 
    49 0000223F 4C89E9              <1>     mov     rcx, r13
    50 00002242 488D15(98020000)    <1>     lea     rdx, [rel mode_in]
    51                              <1>     CALL_IAT GetConsoleMode
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00002249 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 0000224D 48B8B0320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002256 00                  <2>
   174 00002257 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00002259 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    52                              <1>     
    53                              <1>     ; RCX=hOut, RDX=packed COORD
    54 0000225D 4C89E1              <1>     mov      rcx, r12
    55 00002260 BA50001900          <1>     mov      edx, (25 << 16) | 80
    56                              <1>     CALL_IAT SetConsoleScreenBufferSize
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00002265 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002269 48B850330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002272 00                  <2>
   174 00002273 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00002275 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    57                              <1>     
    58                              <1>     ; RCX=hOut, RDX=TRUE, R8=&Rect
    59 00002279 4C89E1              <1>     mov      rcx, r12
    60 0000227C BA01000000          <1>     mov      edx, 1
    61 00002281 49B800000040010000- <1>     mov      r8,  IMAGE_BASE
    61 0000228A 00                  <1>
    62 0000228B 4981C05E410000      <1>     add      r8,  RVA_DATA(Rect80x25)
    63                              <1>     CALL_IAT SetConsoleWindowInfo
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00002292 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002296 48B860330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000229F 00                  <2>
   174 000022A0 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000022A2 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    64                              <1>     
    65                              <1>     ; old mode holen
    66 000022A6 488B0D(E1020000)    <1>     mov  rcx, [hIn]
    67 000022AD 488D15(F5020000)    <1>     lea  rdx, [rel tmpConsoleMode]
    68                              <1>     CALL_IAT GetConsoleMode
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000022B4 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 000022B8 48B8B0320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000022C1 00                  <2>
   174 000022C2 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000022C4 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    69 000022C8 8B05(F5020000)      <1>     mov  eax, [rel tmpConsoleMode]
    70                              <1> 
    71 000022CE 0D8D000000          <1>     or   eax, ENABLE_PROCESSED_INPUT             |               ENABLE_EXTENDED_FLAGS              |               ENABLE_VIRTUAL_TERMINAL_PROCESSING |               DISABLE_NEWLINE_AUTO_RETURN
    75 000022D3 83E0B9              <1>     and  eax, ~(ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT | ENABLE_QUICK_EDIT_MODE)
    76                              <1> 
    77 000022D6 89C2                <1>     mov  edx, eax
    78 000022D8 488B0D(E1020000)    <1>     mov  rcx, [hIn]
    79                              <1>     CALL_IAT SetConsoleMode
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000022DF 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 000022E3 48B840330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000022EC 00                  <2>
   174 000022ED FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000022EF 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    80                              <1> 
    81                              <1>     CALL_IAT GetConsoleWindow
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000022F3 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 000022F7 48B8C0320040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002300 00                  <2>
   174 00002301 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00002303 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    82 00002307 4889C3              <1>     mov      rbx, rax                   ; rbx = hwnd
    83 0000230A 4885C0              <1>     test     rax, rax
    84 0000230D 745A                <1>     jz       .done                      ; no console available
    85                              <1>     ; HMENU m = GetSystemMenu(h, FALSE);
    86 0000230F 4889D9              <1>     mov      rcx, rbx                   ; hWnd
    87 00002312 31D2                <1>     xor      edx, edx                   ; FALSE
    88                              <1>     CALL_IAT GetSystemMenu
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00002314 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002318 48B8F0330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002321 00                  <2>
   174 00002322 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00002324 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    89 00002328 4885C0              <1>     test     rax, rax
    90 0000232B 743C                <1>     jz       .done
    91 0000232D 4889C7              <1>     mov      rdi, rax                   ; rdi = HMENU
    92                              <1>     ; EnableMenuItem(m, SC_CLOSE, MF_BYCOMMAND | MF_GRAYED);
    93 00002330 4889F9              <1>     mov      rcx, rdi                   ; HMENU
    94 00002333 BA60F00000          <1>     mov      edx, SC_CLOSE              ; uIDEnableItem
    95 00002338 41B801000000        <1>     mov      r8d, MF_BYCOMMAND | MF_GRAYED
    96                              <1>     CALL_IAT EnableMenuItem
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 0000233E 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002342 48B8B8330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000234B 00                  <2>
   174 0000234C FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 0000234E 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
    97                              <1>     ; Neuzeichnen der Titelleiste/Buttons
    98 00002352 4889D9              <1>     mov      rcx, rbx
    99                              <1>     CALL_IAT DrawMenuBar
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 00002355 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 00002359 48B8B0330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002362 00                  <2>
   174 00002363 FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 00002365 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   100                              <1>     .after_menu:
   101                              <1>     .done:
   102                              <1>     
   103                              <1>     ; default color for the console:
   104 00002369 66B82800            <1>     mov ax, ATTR_BG_BLACK
   105 0000236D 668905FB0F0000      <1>     mov [_cA_console_bg], ax
   106                              <1>     ;
   107 00002374 66B85D00            <1>     mov ax, ATTR_FG_LIGHT_YELLOW
   108 00002378 668905F20F0000      <1>     mov [_cA_console_fg], ax
   109                              <1>     
   110                              <1> ; --- Epilog ---
   111                              <1>     FUNC_LEAVE
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
   562                              <2> %else
   563                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 0000237F 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   564                              <2> %endif
   565 00002383 5D                  <2>  pop rbp
   566 00002384 C3                  <2>  ret
   112                              <1> 
   113                              <1> ; -------------------------------------------------------------------
   114                              <1> ; UTF-8 -> UTF-16
   115                              <1> ; -------------------------------------------------------------------
   116                              <1> ascii_to_utf8:
   117                              <1>     ;FUNC_ENTER
   118 00002385 53                  <1>     push    rbx
   119                              <1>     
   120                              <1>     ; Eingaben sichern
   121 00002386 4989CA              <1>     mov     r10, rcx        ; save src (UTF-8)
   122 00002389 4989D3              <1>     mov     r11, rdx        ; save dst (LPWSTR)
   123                              <1>     
   124                              <1>     ; MultiByteToWideChar(CodePage=65001, Flags=0, src, -1, dst, cch)
   125 0000238C B9E9FD0000          <1>     mov     ecx, 65001      ; CodePage = CP_UTF8
   126 00002391 31D2                <1>     xor     edx, edx        ; dwFlags = 0           (Achtung: edx nullt rdx!)
   127 00002393 4D89D0              <1>     mov     r8,  r10        ; lpMultiByteStr = saved src
   128 00002396 41B9FFFFFFFF        <1>     mov     r9d, -1         ; cbMultiByte = -1 (NUL-terminiert)
   129                              <1>     
   130 0000239C 4883EC28            <1>     sub     rsp, 40               ; shadow space
   131 000023A0 4C895C2418          <1>     mov     [rsp+24], r11         ; lpWideCharStr
   132 000023A5 C744242000010000    <1>     mov     dword [rsp+32], 256   ; cchWideChar
   133                              <1>     
   134                              <1>     CALL_IAT MultiByteToWideChar
   172                              <2>  AddShadow
    82                              <3> %if %0 == 1
    83                              <3>  sub rsp, %1
    84                              <3> %else
    85 000023AD 4883EC20            <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   173 000023B1 48B868330040010000- <2>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 000023BA 00                  <2>
   174 000023BB FF10                <2>  call [rax]
   175                              <2>  DelShadow
    93                              <3> %if %0 == 1
    94                              <3>  add rsp, %1
    95                              <3> %else
    96 000023BD 4883C420            <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   135                              <1>     
   136 000023C1 4883C428            <1>     add     rsp, 40
   137 000023C5 5B                  <1>     pop     rbx
   138 000023C6 C3                  <1>     ret
   139                              <1>     ;FUNC_LEAVE
   140                              <1>     
   141                              <1> ; -------------------------------------------------------------------
   142                              <1> ; \brief routine to handle win32api GetLastError ...
   143                              <1> ; -------------------------------------------------------------------
   144                              <1> HandleLastError:
   145                              <1>     ; --- Prolog ---
   146                              <1>     FUNC_ENTER 64
   546                              <2> %if %0 == 1
   547                              <2>  AddShadow %1
    82                              <3> %if %0 == 1
    83 000023C7 4883EC40            <3>  sub rsp, %1
    84                              <3> %else
    85                              <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   548                              <2> %else
   549                              <2>  AddShadow
   550                              <2> %endif
   551 000023CB 55                  <2>  push rbp
   552 000023CC 4889E5              <2>  mov rbp, rsp
   147                              <1>     
   148                              <1>     ; FormatMessageW(FM_FLAGS, NULL, err, LANGID_DEFAULT, (LPWSTR)&pMsg, 0, NULL)
   149 000023CF B900130000          <1>     mov     ecx, FM_FLAGS                       ; rcx = dwFlags
   150 000023D4 31D2                <1>     xor     edx, edx                            ; rdx = lpSource = NULL
   151 000023D6 4189C0              <1>     mov     r8d, eax                            ; 3th dwMessageId
   152 000023D9 41B900040000        <1>     mov     r9d, LANGID_DEFAULT                 ; 4th dwLanguageId
   153                              <1>     
   154                              <1>     AddShadow (32 + (3 * 8) + 8)                ; 32 shadow + 3 stack-args (5th,6th,7th) + 8 padding
    82                              <2> %if %0 == 1
    83 000023DF 4883EC40            <2>  sub rsp, %1
    84                              <2> %else
    85                              <2>  sub rsp, SW_SHADOW
    86                              <2> %endif
   155 000023E3 48B800000040010000- <1>     mov     rax, IMAGE_BASE
   155 000023EC 00                  <1>
   156 000023ED 480566410000        <1>     add     rax, RVA_DATA(pMsg)                 ; rax = &pmsg
   157 000023F3 4889442420          <1>     mov     [rsp+32], rax                       ; 5th: lpBuffer (as LPWSTR*) because of ALLOCATE_BUFFER
   158 000023F8 C744242800000000    <1>     mov     dword [rsp+40], 0                   ; 6th: nSize = 0 (Min-Größe)
   159 00002400 48C744243000000000  <1>     mov     qword [rsp+48], 0                   ; 7th: Arguments = NULL
   160                              <1> 
   161                              <1>     ;AddShadow
   162                              <1>     call_FormatMessageW
   608                              <2>  CALL_IAT FormatMessageW
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00002409 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 0000240D 48B898320040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002416 00                  <3>
   174 00002417 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00002419 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
   163                              <1>     DelShadow (32 + (3 * 8) + 8)
    93                              <2> %if %0 == 1
    94 0000241D 4883C440            <2>  add rsp, %1
    95                              <2> %else
    96                              <2>  add rsp, SW_SHADOW
    97                              <2> %endif
   164 00002421 85C0                <1>     test    eax, eax
   165 00002423 7468                <1>     jz      .no_text                                    ; 0 = Fehler (kein Text verfügbar)
   166                              <1> 
   167                              <1>     ; MessageBoxW(NULL, pMsg, titleW, MB_ICONERROR)
   168 00002425 31C9                <1>     xor     ecx, ecx
   169 00002427 48BA00000040010000- <1>     mov     rdx, IMAGE_BASE
   169 00002430 00                  <1>
   170 00002431 4881C266410000      <1>     add     rdx, RVA_DATA(pMsg)                 ; lpText = pMsg (LPWSTR)
   171                              <1>     GETEXT  r8 , ErrTitleW
   384 00002438 49B800000040010000- <2>  mov %1, IMAGE_BASE
   384 00002441 00                  <2>
   385 00002442 4981C040400000      <2>  add %1, RVA_DATA(_cW_%2)
   172 00002449 41B910000000        <1>     mov     r9d, MB_ICONERROR
   173                              <1>     call_MessageBoxW
   689                              <2>  CALL_IAT MessageBoxW
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 0000244F 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 00002453 48B818340040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 0000245C 00                  <3>
   174 0000245D FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 0000245F 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
   174                              <1> 
   175                              <1>     ; LocalFree(pMsg)
   176 00002463 48B900000040010000- <1>     mov     rcx, IMAGE_BASE
   176 0000246C 00                  <1>
   177 0000246D 4881C166410000      <1>     add     rcx, RVA_DATA(pMsg)
   178 00002474 488B09              <1>     mov     rcx, [rcx]
   179                              <1>     call_LocalFree
   678                              <2> %if DOS_SHELL == 1
   679                              <2>  %error ERROR_Win32API
   680                              <2> %else
   681                              <2>  CALL_IAT MessageBoxW
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00002477 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 0000247B 48B818340040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002484 00                  <3>
   174 00002485 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00002487 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
   682                              <2> %endif
   180                              <1> 
   181 0000248B EB05                <1>     jmp     .done
   182                              <1>     
   183                              <1> .no_text:
   184 0000248D E86D000000          <1>     call HandleLastErrorHexCode
   185                              <1> .done:
   186                              <1>     FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 00002492 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002496 5D                  <2>  pop rbp
   566 00002497 C3                  <2>  ret
   187                              <1> 
   188                              <1> ; -------------------------------------------------------------------
   189                              <1> ; rcx = BYTE buffer[20]
   190                              <1> ; edx = DWORD number
   191                              <1> ; return:
   192                              <1> ; rax = BYTE * start
   193                              <1> ; -------------------------------------------------------------------
   194                              <1> u32_to_dec:
   195 00002498 89D0                <1> 	mov     eax, edx        ; number
   196 0000249A 4C8D4114            <1> 	lea     r8, [rcx + 20]  ; end of buffer
   197 0000249E 49FFC8              <1> 	dec     r8
   198 000024A1 41C60000            <1> 	mov     byte [r8], 0    ; null terminate
   199                              <1>     .loop:
   200 000024A5 B90A000000          <1>     mov     rcx, 10
   201 000024AA BA00000000          <1>     mov     rdx, 0
   202 000024AF 48F7F1              <1>     div     rcx
   203 000024B2 80C230              <1>     add     dl, '0'         ; convert remainder to ascii
   204 000024B5 49FFC8              <1>     dec     r8
   205 000024B8 418810              <1>     mov     byte [r8], dl
   206 000024BB 4883F800            <1>     cmp     rax, 0
   207 000024BF 77E4                <1>     ja      .loop
   208 000024C1 4C89C0              <1>     mov     rax, r8         ; pointer to start of number
   209 000024C4 C3                  <1>     ret
   210                              <1>     
   211                              <1> ; -------------------------------------------------------------------
   212                              <1> ; \brief  concatenate two ANSI string's to a single one string dest-
   213                              <1> ;         ination. The dst buffer must be big enough !
   214                              <1> ;
   215                              <1> ; \desc   int concat_ansi(char *dst, const char *s1, const char *s2)
   216                              <1> ;
   217                              <1> ; \param  RCX -> string buffer = dst
   218                              <1> ;
   219                              <1> ; \param  RDX -> string = src1
   220                              <1> ; \param  R8  -> string = src2
   221                              <1> ;
   222                              <1> ; \return RAX -> bool   = 1 if 0x00 found, else 0
   223                              <1> ; -------------------------------------------------------------------
   224                              <1> concat_ansi:
   225                              <1>     ; -----------------------------------------
   226                              <1>     ; iterate over first string
   227                              <1>     ; -----------------------------------------
   228                              <1>     .loop_s1:
   229 000024C5 8A02                <1>     mov     al, [rdx]   ; get character on current src1 position
   230 000024C7 84C0                <1>     test    al, al      ; 0x00 found ?
   231 000024C9 740A                <1>     jz      .loop_s2    ; yes, then exit .loop
   232                              <1>     
   233 000024CB 8801                <1>     mov     [rcx], al   ; move al character to dst buffer
   234 000024CD 48FFC2              <1>     inc     rdx         ; increment position of src1 buffer
   235 000024D0 48FFC1              <1>     inc     rcx         ; ... of dst buffer
   236 000024D3 EBF0                <1>     jmp     .loop_s1    ; next character
   237                              <1>     
   238                              <1>     ; -----------------------------------------
   239                              <1>     ; iterate over second string
   240                              <1>     ; -----------------------------------------
   241                              <1>     .loop_s2:
   242 000024D5 418A00              <1>     mov     al, [r8]    ; get character on current src2 position
   243 000024D8 84C0                <1>     test    al, al      ; 0x00 found ?
   244 000024DA 740A                <1>     jz      .finish     ; yes, then exit .loop
   245                              <1>     
   246 000024DC 8801                <1>     mov     [rcx], al   ; move al character to dst buffer
   247 000024DE 49FFC0              <1>     inc     r8          ; increment position of src2 buffer
   248 000024E1 48FFC1              <1>     inc     rcx         ; ... of dst buffer
   249 000024E4 EBEF                <1>     jmp     .loop_s2    ; next char
   250                              <1>     
   251                              <1>     .finish:
   252 000024E6 31C0                <1>     xor     eax, eax    ; AL = 0
   253 000024E8 8801                <1>     mov     [rcx], al   ; null-terminator
   254 000024EA B801000000          <1>     mov     eax, 1      ; return true, found end
   255 000024EF C3                  <1>     ret
   256                              <1>     
   257                              <1> GET_STR_LEN:
   258 000024F0 31C0                <1>     xor     eax, eax            ; RAX = 0 (counter)
   259                              <1>     .loop:
   260 000024F2 8A1401              <1>     mov     dl, byte [rcx+rax]  ; get character on current src1 position
   261 000024F5 84D2                <1>     test    dl, dl              ; 0x00 found ?
   262 000024F7 7405                <1>     jz      .loop_end           ; yes, then exit .loop
   263 000024F9 48FFC0              <1>     inc     rax                 ; ... of dst buffer
   264 000024FC EBF4                <1>     jmp     .loop               ; next character
   265                              <1>     .loop_end:
   266 000024FE C3                  <1>     ret
   267                              <1> 
   268                              <1> HandleLastErrorHexCode:
   269                              <1>     ; --- Prolog ---
   270                              <1>     FUNC_ENTER 64
   546                              <2> %if %0 == 1
   547                              <2>  AddShadow %1
    82                              <3> %if %0 == 1
    83 000024FF 4883EC40            <3>  sub rsp, %1
    84                              <3> %else
    85                              <3>  sub rsp, SW_SHADOW
    86                              <3> %endif
   548                              <2> %else
   549                              <2>  AddShadow
   550                              <2> %endif
   551 00002503 55                  <2>  push rbp
   552 00002504 4889E5              <2>  mov rbp, rsp
   271                              <1>     
   272                              <1>     ; -----------------------------------------------------------
   273                              <1>     ; write: work around for: mov [rel last_error], eax
   274                              <1>     ;
   275                              <1>     ; 1. load abs Virtual Address into register
   276                              <1>     ; 2. access through this register
   277                              <1>     ; -----------------------------------------------------------
   278 00002507 48BA-               <1>     mov   rdx, IMAGE_BASE + RVA_DATA(last_error)
   278 00002509 (F910004001000000)  <1>
   279 00002511 8902                <1>     mov   dword [rdx], eax
   280                              <1>     
   281                              <1> ;    mov   rcx, IMAGE_BASE + RVA_DATA(_cW_wbuf)
   282                              <1> ;    mov   rdx, IMAGE_BASE + RVA_DATA(_cW_fmtW)
   283                              <1>     
   284                              <1>     ; wsprintfW(wbuf, fmtW, err, err)
   285                              <1>     ; (variadisch: AL = 0, Shadow Space 32B)
   286 00002513 4189C8              <1>     mov     r8d, ecx                     ; 1. varg
   287 00002516 4189D1              <1>     mov     r9d, edx                     ; 2. varg
   288 00002519 31C0                <1>     xor     eax, eax                     ; AL=0 (keine XMM-Args)
   289                              <1>     
   290                              <1>     call_wsprintfW
   696                              <2>  CALL_IAT wsprintfW
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 0000251B 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 0000251F 48B870340040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002528 00                  <3>
   174 00002529 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 0000252B 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
   291                              <1>         
   292                              <1>     ; MessageBoxW(NULL, wbuf, titleW, MB_ICONERROR)
   293 0000252F 31C9                <1>     xor     ecx, ecx
   294                              <1> ;    mov     rdx, IMAGE_BASE + RVA_DATA(_cW_wbuf)
   295                              <1> ;    mov     r8,  IMAGE_BASE + RVA_DATA(_cW_ErrTitleW)
   296 00002531 41B910000000        <1>     mov     r9d, 0x10                    ; MB_ICONERROR
   297                              <1>     
   298                              <1>     call_MessageBoxW
   689                              <2>  CALL_IAT MessageBoxW
   172                              <3>  AddShadow
    82                              <4> %if %0 == 1
    83                              <4>  sub rsp, %1
    84                              <4> %else
    85 00002537 4883EC20            <4>  sub rsp, SW_SHADOW
    86                              <4> %endif
   173 0000253B 48B818340040010000- <3>  mov rax, IMAGE_BASE + RVA_IDATA(IAT_win32_%1)
   173 00002544 00                  <3>
   174 00002545 FF10                <3>  call [rax]
   175                              <3>  DelShadow
    93                              <4> %if %0 == 1
    94                              <4>  add rsp, %1
    95                              <4> %else
    96 00002547 4883C420            <4>  add rsp, SW_SHADOW
    97                              <4> %endif
   299                              <1> 
   300                              <1>     FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 0000254B 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 0000254F 5D                  <2>  pop rbp
   566 00002550 C3                  <2>  ret
   301                              <1> 
   302                              <1> ; -------------------------------------------------------------------
   303                              <1> ; int utf8_to_cp1252_char(const uint8_t* src, uint8_t* dst)
   304                              <1> ; RCX = src (UTF-8), RDX = dst (CP1252)
   305                              <1> ; Rückgabe:
   306                              <1> ;   RAX = Anzahl gelesener UTF-8-Bytes (1..2), 0 bei NUL
   307                              <1> ;   AL  = geschriebenes CP1252-Byte
   308                              <1> ;   CF  = 1, wenn unmappbar -> '?' geschrieben
   309                              <1> ; Hinweis: mapped werden ASCII und: äöüÄÖÜß
   310                              <1> ; -------------------------------------------------------------------
   311                              <1> utf8_to_cp1252_char:
   312                              <1>     ;FUNC_ENTER 64
   313 00002551 53                  <1>     push    rbx
   314                              <1> 
   315 00002552 8A19                <1>     mov     bl, [rcx]
   316 00002554 84DB                <1>     test    bl, bl
   317 00002556 0F84ED000000        <1>     jz      .nul               ; Stringende
   318                              <1> 
   319                              <1>     ; ASCII (00..7F) 1:1
   320 0000255C 80FB7F              <1>     cmp     bl, 0x7F
   321 0000255F 7638                <1>     jbe     .ascii
   322                              <1> 
   323                              <1>     ; --- 2-Byte UTF-8, die mit C3 beginnen (äöüÄÖÜß) ---
   324 00002561 80FBC3              <1>     cmp     bl, 0xC3
   325 00002564 0F85BE000000        <1>     jne     .unmap
   326 0000256A 8A7901              <1>     mov     bh, [rcx+1]        ; zweites Byte
   327                              <1>     ; Tabelle:
   328                              <1>     ; C3 84 -> Ä (C4)
   329                              <1>     ; C3 96 -> Ö (D6)
   330                              <1>     ; C3 9C -> Ü (DC)
   331                              <1>     ; C3 A4 -> ä (E4)
   332                              <1>     ; C3 B6 -> ö (F6)
   333                              <1>     ; C3 BC -> ü (FC)
   334                              <1>     ; C3 9F -> ß (DF)
   335                              <1> 
   336                              <1>     ; upper-case
   337 0000256D 80FF84              <1>     cmp     bh, 0x84
   338 00002570 7438                <1>     je      .emit_C4
   339 00002572 80FF96              <1>     cmp     bh, 0x96
   340 00002575 7445                <1>     je      .emit_D6
   341 00002577 80FF9C              <1>     cmp     bh, 0x9C
   342 0000257A 7452                <1>     je      .emit_DC
   343                              <1>     ; lower-case
   344 0000257C 80FFA4              <1>     cmp     bh, 0xA4
   345 0000257F 745F                <1>     je      .emit_E4
   346 00002581 80FFB6              <1>     cmp     bh, 0xB6
   347 00002584 746C                <1>     je      .emit_F6
   348 00002586 80FFBC              <1>     cmp     bh, 0xBC
   349 00002589 7479                <1>     je      .emit_FC
   350 0000258B 80FF9F              <1>     cmp     bh, 0x9F
   351 0000258E 0F8482000000        <1>     je      .emit_DF
   352                              <1> 
   353 00002594 E98F000000          <1>     jmp     .unmap
   354                              <1> 
   355                              <1>     .ascii:
   356 00002599 881A                <1>     mov     [rdx], bl
   357 0000259B 88D8                <1>     mov     al, bl
   358 0000259D B801000000          <1>     mov     rax, 1
   359 000025A2 F8                  <1>     clc
   360 000025A3 5B                  <1>     pop     rbx
   361                              <1>     FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 000025A4 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 000025A8 5D                  <2>  pop rbp
   566 000025A9 C3                  <2>  ret
   362                              <1> 
   363 000025AA C602C4              <1>     .emit_C4:   mov byte [rdx], 0xC4  ; Ä
   364 000025AD B0C4                <1>                 mov al, 0xC4
   365 000025AF B802000000          <1>                 mov rax, 2
   366 000025B4 F8                  <1>                 clc
   367 000025B5 5B                  <1>                 pop rbx
   368                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 000025B6 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 000025BA 5D                  <2>  pop rbp
   566 000025BB C3                  <2>  ret
   369 000025BC C602D6              <1>     .emit_D6:   mov byte [rdx], 0xD6  ; Ö
   370 000025BF B0D6                <1>                 mov al, 0xD6
   371 000025C1 B802000000          <1>                 mov rax, 2
   372 000025C6 F8                  <1>                 clc
   373 000025C7 5B                  <1>                 pop rbx
   374                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 000025C8 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 000025CC 5D                  <2>  pop rbp
   566 000025CD C3                  <2>  ret
   375 000025CE C602DC              <1>     .emit_DC:   mov byte [rdx], 0xDC  ; Ü
   376 000025D1 B0DC                <1>                 mov al, 0xDC
   377 000025D3 B802000000          <1>                 mov rax, 2
   378 000025D8 F8                  <1>                 clc
   379 000025D9 5B                  <1>                 pop rbx
   380                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 000025DA 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 000025DE 5D                  <2>  pop rbp
   566 000025DF C3                  <2>  ret
   381 000025E0 C602E4              <1>     .emit_E4:   mov byte [rdx], 0xE4  ; ä
   382 000025E3 B0E4                <1>                 mov al, 0xE4
   383 000025E5 B802000000          <1>                 mov rax, 2
   384 000025EA F8                  <1>                 clc
   385 000025EB 5B                  <1>                 pop rbx
   386                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 000025EC 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 000025F0 5D                  <2>  pop rbp
   566 000025F1 C3                  <2>  ret
   387 000025F2 C602F6              <1>     .emit_F6:   mov byte [rdx], 0xF6  ; ö
   388 000025F5 B0F6                <1>                 mov al, 0xF6
   389 000025F7 B802000000          <1>                 mov rax, 2
   390 000025FC F8                  <1>                 clc
   391 000025FD 5B                  <1>                 pop rbx
   392                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 000025FE 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002602 5D                  <2>  pop rbp
   566 00002603 C3                  <2>  ret
   393 00002604 C602FC              <1>     .emit_FC:   mov byte [rdx], 0xFC  ; ü
   394 00002607 B0FC                <1>                 mov al, 0xFC
   395 00002609 B802000000          <1>                 mov rax, 2
   396 0000260E F8                  <1>                 clc
   397 0000260F 5B                  <1>                 pop rbx
   398                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 00002610 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002614 5D                  <2>  pop rbp
   566 00002615 C3                  <2>  ret
   399 00002616 C602DF              <1>     .emit_DF:   mov byte [rdx], 0xDF  ; ß
   400 00002619 B0DF                <1>                 mov al, 0xDF
   401 0000261B B802000000          <1>                 mov rax, 2
   402 00002620 F8                  <1>                 clc
   403 00002621 5B                  <1>                 pop rbx
   404                              <1>                 FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 00002622 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002626 5D                  <2>  pop rbp
   566 00002627 C3                  <2>  ret
   405                              <1>     .unmap:
   406                              <1>     ; Unbekannt -> '?'
   407 00002628 C6023F              <1>     mov     byte [rdx], '?'
   408 0000262B B03F                <1>     mov     al, '?'
   409 0000262D F9                  <1>     stc
   410                              <1>     ; grob: falls Startbyte >= C2 und < E0, konsumieren wir 2 Bytes,
   411                              <1>     ; sonst 1 (damit der Aufrufer weiterkommt).
   412 0000262E B801000000          <1>     mov     rax, 1
   413 00002633 80FBC2              <1>     cmp     bl, 0xC2
   414 00002636 720A                <1>     jb      .ret_unmap
   415 00002638 80FBE0              <1>     cmp     bl, 0xE0
   416 0000263B 7305                <1>     jae     .ret_unmap
   417 0000263D B802000000          <1>     mov     rax, 2
   418                              <1>     .ret_unmap:
   419 00002642 5B                  <1>     pop     rbx
   420                              <1>     FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 00002643 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002647 5D                  <2>  pop rbp
   566 00002648 C3                  <2>  ret
   421                              <1> 
   422                              <1>     .nul:
   423 00002649 31C0                <1>     xor     eax, eax            ; RAX=0, AL=0
   424 0000264B F8                  <1>     clc
   425                              <1>     .exit:
   426 0000264C 5B                  <1>     pop     rbx
   427                              <1>     FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 0000264D 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002651 5D                  <2>  pop rbp
   566 00002652 C3                  <2>  ret
   428                              <1> ; -------------------------------------------------------------------
   429                              <1> ; size_t utf8_to_cp1252(const uint8_t* src, uint8_t* dst)
   430                              <1> ; RCX=src, RDX=dst -> RAX = geschriebene Bytes, dst ist NUL-terminiert
   431                              <1> ; -------------------------------------------------------------------
   432                              <1> utf8_to_cp1252:
   433                              <1>     ;FUNC_ENTER 64
   434 00002653 56                  <1>     push    rsi
   435 00002654 57                  <1>     push    rdi
   436 00002655 4889CE              <1>     mov     rsi, rcx         ; s = src
   437 00002658 4889D7              <1>     mov     rdi, rdx         ; d = dst
   438 0000265B 4831C0              <1>     xor     rax, rax         ; count = 0
   439                              <1>     
   440                              <1>     .next:
   441 0000265E 0FB606              <1>     movzx   eax, byte [rsi]  ; RCX bleibt unverändert
   442 00002661 EB1A                <1>     jmp .done
   443 00002663 85C0                <1>     test    eax, eax
   444 00002665 7416                <1>     jz      .done
   445                              <1> 
   446                              <1>     ; pro Zeichen mappen
   447 00002667 4889F1              <1>     mov     rcx, rsi
   448 0000266A 4889FA              <1>     mov     rdx, rdi
   449 0000266D E8DFFEFFFF          <1>     call    utf8_to_cp1252_char
   450                              <1>     
   451                              <1>     ; RAX = konsumierte UTF-8-Bytes
   452 00002672 4801C6              <1>     add     rsi, rax
   453 00002675 48FFC7              <1>     inc     rdi
   454 00002678 48FFC0              <1>     inc     rax              ; count++
   455 0000267B EBE1                <1>     jmp     .next
   456                              <1>     .done:
   457                              <1>     ;push    rcx
   458                              <1>     ;ShowMessageW titleW,capW
   459                              <1>     ;pop     rcx
   460 0000267D C60700              <1>     mov     byte [rdi], 0
   461 00002680 5F                  <1>     pop     rdi
   462 00002681 5E                  <1>     pop     rsi
   463 00002682 C3                  <1>     ret
   464                              <1>     FUNC_LEAVE 64
   560                              <2> %if %0 == 1
   561                              <2>  DelShadow %1
    93                              <3> %if %0 == 1
    94 00002683 4883C440            <3>  add rsp, %1
    95                              <3> %else
    96                              <3>  add rsp, SW_SHADOW
    97                              <3> %endif
   562                              <2> %else
   563                              <2>  DelShadow
   564                              <2> %endif
   565 00002687 5D                  <2>  pop rbp
   566 00002688 C3                  <2>  ret
    30                                  
    31                                  text_end:
    32                                  
    33                                  %include 'imports.inc'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  imports.inc
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a tiny MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> ; .idata (Imports)
     9                              <1> ; -----------------------------------------------------------------------------
    10 00002689 00<rep 177h>        <1>     times (IDATA_RAW_PTR - ($ - $$)) db 0
    11                              <1> idata_start:
    12                              <1> 
    13                              <1> ; -----------------------------------------------------------------------------
    14                              <1> ; Import Directory (KERNEL32 + USER32) + Terminator
    15                              <1> ; -----------------------------------------------------------------------------
    16                              <1> MAKE_IMPORT import_dir, kernel32, user32, msvcrt
   147                              <2>  %define __DIR %1
   148                              <2>  %1:
   149                              <2>  %assign __n %0-1
   150                              <2>  %rep __n
   151                              <2>  dd RVA_IDATA(INT_win32_%2)
   152                              <2>  dd 0,0
   153                              <2>  dd RVA_IDATA(dll_win32_%2)
   154                              <2>  dd RVA_IDATA(iat_win32_%2)
   155                              <2>  %rotate 1
   156                              <2>  %endrep
   151 00002800 50300000            <3>  dd RVA_IDATA(INT_win32_%2)
   152 00002804 0000000000000000    <3>  dd 0,0
   153 0000280C 3D390000            <3>  dd RVA_IDATA(dll_win32_%2)
   154 00002810 80320000            <3>  dd RVA_IDATA(iat_win32_%2)
   155                              <3>  %rotate 1
   151 00002814 68310000            <3>  dd RVA_IDATA(INT_win32_%2)
   152 00002818 0000000000000000    <3>  dd 0,0
   153 00002820 4A390000            <3>  dd RVA_IDATA(dll_win32_%2)
   154 00002824 98330000            <3>  dd RVA_IDATA(iat_win32_%2)
   155                              <3>  %rotate 1
   151 00002828 50320000            <3>  dd RVA_IDATA(INT_win32_%2)
   152 0000282C 0000000000000000    <3>  dd 0,0
   153 00002834 55390000            <3>  dd RVA_IDATA(dll_win32_%2)
   154 00002838 80340000            <3>  dd RVA_IDATA(iat_win32_%2)
   155                              <3>  %rotate 1
   157 0000283C 000000000000000000- <2>  dd 0,0,0,0,0
   157 00002845 000000000000000000- <2>
   157 0000284E 0000                <2>
   158                              <2>  __DIR %+ _end:
   159                              <2>  %undef __DIR
    17                              <1> 
    18                              <1> ; -----------------------------------------------------------------------------
    19                              <1> ; INTs (OriginalFirstThunk)
    20                              <1> ; -----------------------------------------------------------------------------
    21                              <1> MAKE_INT INT_win32_kernel32, KERNEL32_FUNCS
   104                              <2> %1:
   105                              <2> %assign __n %0-1
   106                              <2> %rep __n
   107                              <2>  dq RVA_IDATA(HN_win32_%2)
   108                              <2>  %rotate 1
   109                              <2> %endrep
   107 00002850 B034000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002858 BB34000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002860 CA34000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002868 D834000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002870 E934000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002878 0635000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002880 2435000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002888 3535000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002890 5235000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002898 6535000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028A0 7D35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028A8 9B35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028B0 AA35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028B8 BD35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028C0 CE35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028C8 DD35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028D0 EC35000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028D8 F835000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028E0 0736000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028E8 1B36000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028F0 2A36000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000028F8 3536000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002900 4536000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002908 5436000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002910 6F36000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002918 8036000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002920 9536000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002928 B236000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002930 CC36000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002938 E336000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002940 F936000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002948 0F37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002950 1F37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002958 2F37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   110 00002960 0000000000000000    <2>  dq 0
    22                              <1> MAKE_INT INT_win32_user32, USER32_FUNCS
   104                              <2> %1:
   105                              <2> %assign __n %0-1
   106                              <2> %rep __n
   107                              <2>  dq RVA_IDATA(HN_win32_%2)
   108                              <2>  %rotate 1
   109                              <2> %endrep
   107 00002968 3B37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002970 4D37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002978 5E37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002980 7137000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002988 7F37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002990 9037000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002998 9B37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029A0 AE37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029A8 BE37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029B0 CC37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029B8 DE37000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029C0 F137000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029C8 0138000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029D0 1538000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029D8 2538000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029E0 3338000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029E8 4138000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029F0 4F38000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 000029F8 6338000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A00 7038000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A08 8338000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A10 A338000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A18 B738000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A20 C638000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A28 D338000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A30 E538000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A38 F838000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A40 0739000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   110 00002A48 0000000000000000    <2>  dq 0
    23                              <1> MAKE_INT INT_win32_msvcrt, MSVCRT_FUNCS
   104                              <2> %1:
   105                              <2> %assign __n %0-1
   106                              <2> %rep __n
   107                              <2>  dq RVA_IDATA(HN_win32_%2)
   108                              <2>  %rotate 1
   109                              <2> %endrep
   107 00002A50 1339000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A58 1B39000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A60 2339000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A68 2D39000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   107 00002A70 3639000000000000    <3>  dq RVA_IDATA(HN_win32_%2)
   108                              <3>  %rotate 1
   110 00002A78 0000000000000000    <2>  dq 0
    24                              <1> 
    25                              <1> ; -----------------------------------------------------------------------------
    26                              <1> ; IATs (FirstThunk)
    27                              <1> ; -----------------------------------------------------------------------------
    28                              <1> iat_start:
    29                              <1> MAKE_IAT kernel32, KERNEL32_FUNCS
   117                              <2> iat_win32_%1:
   118                              <2> %assign __n %0-1
   119                              <2> %rep __n
   120                              <2> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <2>  %rotate 1
   122                              <2> %endrep
   120 00002A80 B034000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002A88 BB34000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002A90 CA34000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002A98 D834000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AA0 E934000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AA8 0635000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AB0 2435000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AB8 3535000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AC0 5235000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AC8 6535000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AD0 7D35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AD8 9B35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AE0 AA35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AE8 BD35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AF0 CE35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002AF8 DD35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B00 EC35000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B08 F835000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B10 0736000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B18 1B36000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B20 2A36000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B28 3536000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B30 4536000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B38 5436000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B40 6F36000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B48 8036000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B50 9536000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B58 B236000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B60 CC36000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B68 E336000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B70 F936000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B78 0F37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B80 1F37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002B88 2F37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   123 00002B90 0000000000000000    <2>  dq 0
    30                              <1> MAKE_IAT user32, USER32_FUNCS
   117                              <2> iat_win32_%1:
   118                              <2> %assign __n %0-1
   119                              <2> %rep __n
   120                              <2> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <2>  %rotate 1
   122                              <2> %endrep
   120 00002B98 3B37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BA0 4D37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BA8 5E37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BB0 7137000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BB8 7F37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BC0 9037000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BC8 9B37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BD0 AE37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BD8 BE37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BE0 CC37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BE8 DE37000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BF0 F137000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002BF8 0138000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C00 1538000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C08 2538000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C10 3338000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C18 4138000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C20 4F38000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C28 6338000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C30 7038000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C38 8338000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C40 A338000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C48 B738000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C50 C638000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C58 D338000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C60 E538000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C68 F838000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C70 0739000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   123 00002C78 0000000000000000    <2>  dq 0
    31                              <1> MAKE_IAT msvcrt, MSVCRT_FUNCS
   117                              <2> iat_win32_%1:
   118                              <2> %assign __n %0-1
   119                              <2> %rep __n
   120                              <2> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <2>  %rotate 1
   122                              <2> %endrep
   120 00002C80 1339000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C88 1B39000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C90 2339000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002C98 2D39000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   120 00002CA0 3639000000000000    <3> IAT_win32_%2: dq RVA_IDATA(HN_win32_%2)
   121                              <3>  %rotate 1
   123 00002CA8 0000000000000000    <2>  dq 0
    32                              <1> iat_end:
    33                              <1> 
    34                              <1> ; -----------------------------------------------------------------------------
    35                              <1> ; hintnames (ASCII)
    36                              <1> ; -----------------------------------------------------------------------------
    37                              <1> HNSTR KERNEL32_FUNCS
   130                              <2> %assign __n %0
   131                              <2> %rep __n
   132                              <2> HN_win32_%1: dw 0
   133                              <2>  db %str(%1), 0
   134                              <2> %rotate 1
   135                              <2> %endrep
   132 00002CB0 0000                <3> HN_win32_%1: dw 0
   133 00002CB2 6C7374726C656E4100  <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 00002CBB 0000                <3> HN_win32_%1: dw 0
   133 00002CBD 416C6C6F63436F6E73- <3>  db %str(%1), 0
   133 00002CC6 6F6C6500            <3>
   134                              <3> %rotate 1
   132 00002CCA 0000                <3> HN_win32_%1: dw 0
   133 00002CCC 4578697450726F6365- <3>  db %str(%1), 0
   133 00002CD5 737300              <3>
   134                              <3> %rotate 1
   132 00002CD8 0000                <3> HN_win32_%1: dw 0
   133 00002CDA 466F726D61744D6573- <3>  db %str(%1), 0
   133 00002CE3 736167655700        <3>
   134                              <3> %rotate 1
   132 00002CE9 0000                <3> HN_win32_%1: dw 0
   133 00002CEB 46696C6C436F6E736F- <3>  db %str(%1), 0
   133 00002CF4 6C654F757470757441- <3>
   133 00002CFD 747472696275746500  <3>
   134                              <3> %rotate 1
   132 00002D06 0000                <3> HN_win32_%1: dw 0
   133 00002D08 46696C6C436F6E736F- <3>  db %str(%1), 0
   133 00002D11 6C654F757470757443- <3>
   133 00002D1A 686172616374657257- <3>
   133 00002D23 00                  <3>
   134                              <3> %rotate 1
   132 00002D24 0000                <3> HN_win32_%1: dw 0
   133 00002D26 476574436F6E736F6C- <3>  db %str(%1), 0
   133 00002D2F 654D6F646500        <3>
   134                              <3> %rotate 1
   132 00002D35 0000                <3> HN_win32_%1: dw 0
   133 00002D37 476574436F6E736F6C- <3>  db %str(%1), 0
   133 00002D40 6553637265656E4275- <3>
   133 00002D49 66666572496E666F00  <3>
   134                              <3> %rotate 1
   132 00002D52 0000                <3> HN_win32_%1: dw 0
   133 00002D54 476574436F6E736F6C- <3>  db %str(%1), 0
   133 00002D5D 6557696E646F7700    <3>
   134                              <3> %rotate 1
   132 00002D65 0000                <3> HN_win32_%1: dw 0
   133 00002D67 47657443757272656E- <3>  db %str(%1), 0
   133 00002D70 74436F6E736F6C6546- <3>
   133 00002D79 6F6E7400            <3>
   134                              <3> %rotate 1
   132 00002D7D 0000                <3> HN_win32_%1: dw 0
   133 00002D7F 4765744C6172676573- <3>  db %str(%1), 0
   133 00002D88 74436F6E736F6C6557- <3>
   133 00002D91 696E646F7753697A65- <3>
   133 00002D9A 00                  <3>
   134                              <3> %rotate 1
   132 00002D9B 0000                <3> HN_win32_%1: dw 0
   133 00002D9D 4765744C6173744572- <3>  db %str(%1), 0
   133 00002DA6 726F7200            <3>
   134                              <3> %rotate 1
   132 00002DAA 0000                <3> HN_win32_%1: dw 0
   133 00002DAC 4765744D6F64756C65- <3>  db %str(%1), 0
   133 00002DB5 48616E646C655700    <3>
   134                              <3> %rotate 1
   132 00002DBD 0000                <3> HN_win32_%1: dw 0
   133 00002DBF 47657450726F634164- <3>  db %str(%1), 0
   133 00002DC8 647265737300        <3>
   134                              <3> %rotate 1
   132 00002DCE 0000                <3> HN_win32_%1: dw 0
   133 00002DD0 47657453746448616E- <3>  db %str(%1), 0
   133 00002DD9 646C6500            <3>
   134                              <3> %rotate 1
   132 00002DDD 0000                <3> HN_win32_%1: dw 0
   133 00002DDF 4C6F61644C69627261- <3>  db %str(%1), 0
   133 00002DE8 72794100            <3>
   134                              <3> %rotate 1
   132 00002DEC 0000                <3> HN_win32_%1: dw 0
   133 00002DEE 4C6F63616C46726565- <3>  db %str(%1), 0
   133 00002DF7 00                  <3>
   134                              <3> %rotate 1
   132 00002DF8 0000                <3> HN_win32_%1: dw 0
   133 00002DFA 52656164436F6E736F- <3>  db %str(%1), 0
   133 00002E03 6C654100            <3>
   134                              <3> %rotate 1
   132 00002E07 0000                <3> HN_win32_%1: dw 0
   133 00002E09 52656164436F6E736F- <3>  db %str(%1), 0
   133 00002E12 6C65496E7075745700  <3>
   134                              <3> %rotate 1
   132 00002E1B 0000                <3> HN_win32_%1: dw 0
   133 00002E1D 52656164436F6E736F- <3>  db %str(%1), 0
   133 00002E26 6C655700            <3>
   134                              <3> %rotate 1
   132 00002E2A 0000                <3> HN_win32_%1: dw 0
   133 00002E2C 5265616446696C6500  <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 00002E35 0000                <3> HN_win32_%1: dw 0
   133 00002E37 52746C4D6F76654D65- <3>  db %str(%1), 0
   133 00002E40 6D6F727900          <3>
   134                              <3> %rotate 1
   132 00002E45 0000                <3> HN_win32_%1: dw 0
   133 00002E47 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002E50 65435000            <3>
   134                              <3> %rotate 1
   132 00002E54 0000                <3> HN_win32_%1: dw 0
   133 00002E56 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002E5F 65437572736F72506F- <3>
   133 00002E68 736974696F6E00      <3>
   134                              <3> %rotate 1
   132 00002E6F 0000                <3> HN_win32_%1: dw 0
   133 00002E71 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002E7A 654D6F646500        <3>
   134                              <3> %rotate 1
   132 00002E80 0000                <3> HN_win32_%1: dw 0
   133 00002E82 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002E8B 654F75747075744350- <3>
   133 00002E94 00                  <3>
   134                              <3> %rotate 1
   132 00002E95 0000                <3> HN_win32_%1: dw 0
   133 00002E97 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002EA0 6553637265656E4275- <3>
   133 00002EA9 6666657253697A6500  <3>
   134                              <3> %rotate 1
   132 00002EB2 0000                <3> HN_win32_%1: dw 0
   133 00002EB4 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002EBD 655465787441747472- <3>
   133 00002EC6 696275746500        <3>
   134                              <3> %rotate 1
   132 00002ECC 0000                <3> HN_win32_%1: dw 0
   133 00002ECE 536574436F6E736F6C- <3>  db %str(%1), 0
   133 00002ED7 6557696E646F77496E- <3>
   133 00002EE0 666F00              <3>
   134                              <3> %rotate 1
   132 00002EE3 0000                <3> HN_win32_%1: dw 0
   133 00002EE5 4D756C746942797465- <3>  db %str(%1), 0
   133 00002EEE 546F57696465436861- <3>
   133 00002EF7 7200                <3>
   134                              <3> %rotate 1
   132 00002EF9 0000                <3> HN_win32_%1: dw 0
   133 00002EFB 57616974466F725369- <3>  db %str(%1), 0
   133 00002F04 6E676C654F626A6563- <3>
   133 00002F0D 7400                <3>
   134                              <3> %rotate 1
   132 00002F0F 0000                <3> HN_win32_%1: dw 0
   133 00002F11 5772697465436F6E73- <3>  db %str(%1), 0
   133 00002F1A 6F6C654100          <3>
   134                              <3> %rotate 1
   132 00002F1F 0000                <3> HN_win32_%1: dw 0
   133 00002F21 5772697465436F6E73- <3>  db %str(%1), 0
   133 00002F2A 6F6C655700          <3>
   134                              <3> %rotate 1
   132 00002F2F 0000                <3> HN_win32_%1: dw 0
   133 00002F31 577269746546696C65- <3>  db %str(%1), 0
   133 00002F3A 00                  <3>
   134                              <3> %rotate 1
    38                              <1> HNSTR USER32_FUNCS
   130                              <2> %assign __n %0
   131                              <2> %rep __n
   132                              <2> HN_win32_%1: dw 0
   133                              <2>  db %str(%1), 0
   134                              <2> %rotate 1
   135                              <2> %endrep
   132 00002F3B 0000                <3> HN_win32_%1: dw 0
   133 00002F3D 43726561746557696E- <3>  db %str(%1), 0
   133 00002F46 646F7745785700      <3>
   134                              <3> %rotate 1
   132 00002F4D 0000                <3> HN_win32_%1: dw 0
   133 00002F4F 44656657696E646F77- <3>  db %str(%1), 0
   133 00002F58 50726F635700        <3>
   134                              <3> %rotate 1
   132 00002F5E 0000                <3> HN_win32_%1: dw 0
   133 00002F60 44697370617463684D- <3>  db %str(%1), 0
   133 00002F69 6573736167655700    <3>
   134                              <3> %rotate 1
   132 00002F71 0000                <3> HN_win32_%1: dw 0
   133 00002F73 447261774D656E7542- <3>  db %str(%1), 0
   133 00002F7C 617200              <3>
   134                              <3> %rotate 1
   132 00002F7F 0000                <3> HN_win32_%1: dw 0
   133 00002F81 456E61626C654D656E- <3>  db %str(%1), 0
   133 00002F8A 754974656D00        <3>
   134                              <3> %rotate 1
   132 00002F90 0000                <3> HN_win32_%1: dw 0
   133 00002F92 46696C6C5265637400  <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 00002F9B 0000                <3> HN_win32_%1: dw 0
   133 00002F9D 476574436C6173734C- <3>  db %str(%1), 0
   133 00002FA6 6F6E675074725700    <3>
   134                              <3> %rotate 1
   132 00002FAE 0000                <3> HN_win32_%1: dw 0
   133 00002FB0 476574436C69656E74- <3>  db %str(%1), 0
   133 00002FB9 5265637400          <3>
   134                              <3> %rotate 1
   132 00002FBE 0000                <3> HN_win32_%1: dw 0
   133 00002FC0 4765744D6573736167- <3>  db %str(%1), 0
   133 00002FC9 655700              <3>
   134                              <3> %rotate 1
   132 00002FCC 0000                <3> HN_win32_%1: dw 0
   133 00002FCE 4765744D6F6E69746F- <3>  db %str(%1), 0
   133 00002FD7 72496E666F5700      <3>
   134                              <3> %rotate 1
   132 00002FDE 0000                <3> HN_win32_%1: dw 0
   133 00002FE0 476574537973436F6C- <3>  db %str(%1), 0
   133 00002FE9 6F72427275736800    <3>
   134                              <3> %rotate 1
   132 00002FF1 0000                <3> HN_win32_%1: dw 0
   133 00002FF3 47657453797374656D- <3>  db %str(%1), 0
   133 00002FFC 4D656E7500          <3>
   134                              <3> %rotate 1
   132 00003001 0000                <3> HN_win32_%1: dw 0
   133 00003003 47657457696E646F77- <3>  db %str(%1), 0
   133 0000300C 4C6F6E675074724100  <3>
   134                              <3> %rotate 1
   132 00003015 0000                <3> HN_win32_%1: dw 0
   133 00003017 47657457696E646F77- <3>  db %str(%1), 0
   133 00003020 5265637400          <3>
   134                              <3> %rotate 1
   132 00003025 0000                <3> HN_win32_%1: dw 0
   133 00003027 4C6F6164437572736F- <3>  db %str(%1), 0
   133 00003030 725700              <3>
   134                              <3> %rotate 1
   132 00003033 0000                <3> HN_win32_%1: dw 0
   133 00003035 4D657373616765426F- <3>  db %str(%1), 0
   133 0000303E 784100              <3>
   134                              <3> %rotate 1
   132 00003041 0000                <3> HN_win32_%1: dw 0
   133 00003043 4D657373616765426F- <3>  db %str(%1), 0
   133 0000304C 785700              <3>
   134                              <3> %rotate 1
   132 0000304F 0000                <3> HN_win32_%1: dw 0
   133 00003051 4D6F6E69746F724672- <3>  db %str(%1), 0
   133 0000305A 6F6D57696E646F7700  <3>
   134                              <3> %rotate 1
   132 00003063 0000                <3> HN_win32_%1: dw 0
   133 00003065 4D6F766557696E646F- <3>  db %str(%1), 0
   133 0000306E 7700                <3>
   134                              <3> %rotate 1
   132 00003070 0000                <3> HN_win32_%1: dw 0
   133 00003072 526567697374657243- <3>  db %str(%1), 0
   133 0000307B 6C61737345785700    <3>
   134                              <3> %rotate 1
   132 00003083 0000                <3> HN_win32_%1: dw 0
   133 00003085 53657450726F636573- <3>  db %str(%1), 0
   133 0000308E 734470694177617265- <3>
   133 00003097 6E657373436F6E7465- <3>
   133 000030A0 787400              <3>
   134                              <3> %rotate 1
   132 000030A3 0000                <3> HN_win32_%1: dw 0
   133 000030A5 53657457696E646F77- <3>  db %str(%1), 0
   133 000030AE 4C6F6E675074724100  <3>
   134                              <3> %rotate 1
   132 000030B7 0000                <3> HN_win32_%1: dw 0
   133 000030B9 53657457696E646F77- <3>  db %str(%1), 0
   133 000030C2 506F7300            <3>
   134                              <3> %rotate 1
   132 000030C6 0000                <3> HN_win32_%1: dw 0
   133 000030C8 53686F7757696E646F- <3>  db %str(%1), 0
   133 000030D1 7700                <3>
   134                              <3> %rotate 1
   132 000030D3 0000                <3> HN_win32_%1: dw 0
   133 000030D5 506F7374517569744D- <3>  db %str(%1), 0
   133 000030DE 65737361676500      <3>
   134                              <3> %rotate 1
   132 000030E5 0000                <3> HN_win32_%1: dw 0
   133 000030E7 5472616E736C617465- <3>  db %str(%1), 0
   133 000030F0 4D65737361676500    <3>
   134                              <3> %rotate 1
   132 000030F8 0000                <3> HN_win32_%1: dw 0
   133 000030FA 55706461746557696E- <3>  db %str(%1), 0
   133 00003103 646F7700            <3>
   134                              <3> %rotate 1
   132 00003107 0000                <3> HN_win32_%1: dw 0
   133 00003109 77737072696E746657- <3>  db %str(%1), 0
   133 00003112 00                  <3>
   134                              <3> %rotate 1
    39                              <1> HNSTR MSVCRT_FUNCS
   130                              <2> %assign __n %0
   131                              <2> %rep __n
   132                              <2> HN_win32_%1: dw 0
   133                              <2>  db %str(%1), 0
   134                              <2> %rotate 1
   135                              <2> %endrep
   132 00003113 0000                <3> HN_win32_%1: dw 0
   133 00003115 666765747300        <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 0000311B 0000                <3> HN_win32_%1: dw 0
   133 0000311D 7363616E6600        <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 00003123 0000                <3> HN_win32_%1: dw 0
   133 00003125 737072696E746600    <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 0000312D 0000                <3> HN_win32_%1: dw 0
   133 0000312F 7072696E746600      <3>  db %str(%1), 0
   134                              <3> %rotate 1
   132 00003136 0000                <3> HN_win32_%1: dw 0
   133 00003138 7075747300          <3>  db %str(%1), 0
   134                              <3> %rotate 1
    40                              <1> 
    41                              <1> ; -----------------------------------------------------------------------------
    42                              <1> ; DLL names
    43                              <1> ; -----------------------------------------------------------------------------
    44 0000313D 6B65726E656C33322E- <1> dll_win32_kernel32: db 'kernel32.dll',0
    44 00003146 646C6C00            <1>
    45 0000314A 7573657233322E646C- <1> dll_win32_user32:   db 'user32.dll',0
    45 00003153 6C00                <1>
    46 00003155 6D73766372742E646C- <1> dll_win32_msvcrt:   db 'msvcrt.dll',0
    46 0000315E 6C00                <1>
    47                              <1> 
    48                              <1> idata_end:
    49                              <1> ; -----------------------------------------------------------------------------
    34                                  %include 'data64.asm'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  data64.asm
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8 00003160 00<rep A0h>         <1> times (DATA_RAW_PTR-($-$$)) db 0
     9                              <1> data_start:
    10                              <1> 
    11                              <1> %include 'data.inc'
    12                              <1> 
    13                              <1> ASTR cap2A          , "ein Text", 13,10,0
   375 00003200 65696E20546578740D- <2> _cA_%1: db %2, 0
   375 00003209 0A0000              <2>
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    14                              <1> 
    15                              <1> WSTR fmtW           , "Win32-Fehler: 0x%08X (%u)", 0      ; Format-String (UTF-16)
   202                              <2>  %push WSTR
   203                              <2> 
   204                              <2> 
   205                              <2>  %define _WSTR_LBL _cW_%1
   206                              <2>  %define _WSTR_END _cW_%1_end
   207                              <2>  %define _WSTR_LENB _cW_%1_length_bytes
   208                              <2>  %define _WSTR_LENW _cW_%1_length_words
   209                              <2> 
   210                              <2> _WSTR_LBL:
   211                              <2> 
   212                              <2>  %assign %$nargs %0-1
   213                              <2>  %rotate 1
   214                              <2> 
   215                              <2>  %rep %$nargs
   216                              <2>  %ifstr %1
   217                              <2>  %strlen %$n %1
   218                              <2>  %assign %$i 0
   219                              <2>  %rep %$n
   220                              <2>  %substr %$c %1 %$i+1,1
   221                              <2>  dw %$c
   222                              <2>  %assign %$i %$i+1
   223                              <2>  %endrep
   224                              <2>  %elifnum %1
   225                              <2>  dw %1
   226                              <2>  %else
   227                              <2>  dw %1
   228                              <2>  %endif
   229                              <2>  %rotate 1
   230                              <2>  %endrep
   216                              <3>  %ifstr %1
   217                              <3>  %strlen %$n %1
   218                              <3>  %assign %$i 0
   219                              <3>  %rep %$n
   220                              <3>  %substr %$c %1 %$i+1,1
   221                              <3>  dw %$c
   222                              <3>  %assign %$i %$i+1
   223                              <3>  %endrep
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000320C 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000320E 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003210 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003212 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003214 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003216 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003218 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000321A 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000321C 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000321E 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003220 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003222 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003224 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003226 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003228 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000322A 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000322C 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000322E 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003230 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003232 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003234 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003236 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003238 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000323A 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000323C 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   224                              <3>  %elifnum %1
   225                              <3>  dw %1
   226                              <3>  %else
   227                              <3>  dw %1
   228                              <3>  %endif
   229                              <3>  %rotate 1
   231                              <2> 
   232 0000323E 0000                <2>  dw 0
   233                              <2> 
   234                              <2> _WSTR_END:
   235                              <2> _WSTR_LENB equ (_WSTR_END - _WSTR_LBL - 2)
   236                              <2> _WSTR_LENW equ (_WSTR_LENB/2)
   237                              <2> 
   238                              <2> 
   239                              <2>  %undef _WSTR_LBL
   240                              <2>  %undef _WSTR_END
   241                              <2>  %undef _WSTR_LENB
   242                              <2>  %undef _WSTR_LENW
   243                              <2>  %pop
    16                              <1> WSTR ErrTitleW      , "Fehler"
   202                              <2>  %push WSTR
   203                              <2> 
   204                              <2> 
   205                              <2>  %define _WSTR_LBL _cW_%1
   206                              <2>  %define _WSTR_END _cW_%1_end
   207                              <2>  %define _WSTR_LENB _cW_%1_length_bytes
   208                              <2>  %define _WSTR_LENW _cW_%1_length_words
   209                              <2> 
   210                              <2> _WSTR_LBL:
   211                              <2> 
   212                              <2>  %assign %$nargs %0-1
   213                              <2>  %rotate 1
   214                              <2> 
   215                              <2>  %rep %$nargs
   216                              <2>  %ifstr %1
   217                              <2>  %strlen %$n %1
   218                              <2>  %assign %$i 0
   219                              <2>  %rep %$n
   220                              <2>  %substr %$c %1 %$i+1,1
   221                              <2>  dw %$c
   222                              <2>  %assign %$i %$i+1
   223                              <2>  %endrep
   224                              <2>  %elifnum %1
   225                              <2>  dw %1
   226                              <2>  %else
   227                              <2>  dw %1
   228                              <2>  %endif
   229                              <2>  %rotate 1
   230                              <2>  %endrep
   216                              <3>  %ifstr %1
   217                              <3>  %strlen %$n %1
   218                              <3>  %assign %$i 0
   219                              <3>  %rep %$n
   220                              <3>  %substr %$c %1 %$i+1,1
   221                              <3>  dw %$c
   222                              <3>  %assign %$i %$i+1
   223                              <3>  %endrep
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003240 4600                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003242 6500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003244 6800                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003246 6C00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003248 6500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000324A 7200                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   224                              <3>  %elifnum %1
   225                              <3>  dw %1
   226                              <3>  %else
   227                              <3>  dw %1
   228                              <3>  %endif
   229                              <3>  %rotate 1
   231                              <2> 
   232 0000324C 0000                <2>  dw 0
   233                              <2> 
   234                              <2> _WSTR_END:
   235                              <2> _WSTR_LENB equ (_WSTR_END - _WSTR_LBL - 2)
   236                              <2> _WSTR_LENW equ (_WSTR_LENB/2)
   237                              <2> 
   238                              <2> 
   239                              <2>  %undef _WSTR_LBL
   240                              <2>  %undef _WSTR_END
   241                              <2>  %undef _WSTR_LENB
   242                              <2>  %undef _WSTR_LENW
   243                              <2>  %pop
    17                              <1> 
    18                              <1> WSTR errmsgW        , 'RegisterClassExW failed'
   202                              <2>  %push WSTR
   203                              <2> 
   204                              <2> 
   205                              <2>  %define _WSTR_LBL _cW_%1
   206                              <2>  %define _WSTR_END _cW_%1_end
   207                              <2>  %define _WSTR_LENB _cW_%1_length_bytes
   208                              <2>  %define _WSTR_LENW _cW_%1_length_words
   209                              <2> 
   210                              <2> _WSTR_LBL:
   211                              <2> 
   212                              <2>  %assign %$nargs %0-1
   213                              <2>  %rotate 1
   214                              <2> 
   215                              <2>  %rep %$nargs
   216                              <2>  %ifstr %1
   217                              <2>  %strlen %$n %1
   218                              <2>  %assign %$i 0
   219                              <2>  %rep %$n
   220                              <2>  %substr %$c %1 %$i+1,1
   221                              <2>  dw %$c
   222                              <2>  %assign %$i %$i+1
   223                              <2>  %endrep
   224                              <2>  %elifnum %1
   225                              <2>  dw %1
   226                              <2>  %else
   227                              <2>  dw %1
   228                              <2>  %endif
   229                              <2>  %rotate 1
   230                              <2>  %endrep
   216                              <3>  %ifstr %1
   217                              <3>  %strlen %$n %1
   218                              <3>  %assign %$i 0
   219                              <3>  %rep %$n
   220                              <3>  %substr %$c %1 %$i+1,1
   221                              <3>  dw %$c
   222                              <3>  %assign %$i %$i+1
   223                              <3>  %endrep
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000324E 5200                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003250 6500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003252 6700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003254 6900                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003256 7300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003258 7400                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000325A 6500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000325C 7200                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000325E 4300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003260 6C00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003262 6100                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003264 7300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003266 7300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003268 4500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000326A 7800                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000326C 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000326E 2000                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003270 6600                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003272 6100                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003274 6900                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003276 6C00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003278 6500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000327A 6400                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   224                              <3>  %elifnum %1
   225                              <3>  dw %1
   226                              <3>  %else
   227                              <3>  dw %1
   228                              <3>  %endif
   229                              <3>  %rotate 1
   231                              <2> 
   232 0000327C 0000                <2>  dw 0
   233                              <2> 
   234                              <2> _WSTR_END:
   235                              <2> _WSTR_LENB equ (_WSTR_END - _WSTR_LBL - 2)
   236                              <2> _WSTR_LENW equ (_WSTR_LENB/2)
   237                              <2> 
   238                              <2> 
   239                              <2>  %undef _WSTR_LBL
   240                              <2>  %undef _WSTR_END
   241                              <2>  %undef _WSTR_LENB
   242                              <2>  %undef _WSTR_LENW
   243                              <2>  %pop
    19                              <1> WSTR titleW         , 'NASM PE64 GUI without Linker'
   202                              <2>  %push WSTR
   203                              <2> 
   204                              <2> 
   205                              <2>  %define _WSTR_LBL _cW_%1
   206                              <2>  %define _WSTR_END _cW_%1_end
   207                              <2>  %define _WSTR_LENB _cW_%1_length_bytes
   208                              <2>  %define _WSTR_LENW _cW_%1_length_words
   209                              <2> 
   210                              <2> _WSTR_LBL:
   211                              <2> 
   212                              <2>  %assign %$nargs %0-1
   213                              <2>  %rotate 1
   214                              <2> 
   215                              <2>  %rep %$nargs
   216                              <2>  %ifstr %1
   217                              <2>  %strlen %$n %1
   218                              <2>  %assign %$i 0
   219                              <2>  %rep %$n
   220                              <2>  %substr %$c %1 %$i+1,1
   221                              <2>  dw %$c
   222                              <2>  %assign %$i %$i+1
   223                              <2>  %endrep
   224                              <2>  %elifnum %1
   225                              <2>  dw %1
   226                              <2>  %else
   227                              <2>  dw %1
   228                              <2>  %endif
   229                              <2>  %rotate 1
   230                              <2>  %endrep
   216                              <3>  %ifstr %1
   217                              <3>  %strlen %$n %1
   218                              <3>  %assign %$i 0
   219                              <3>  %rep %$n
   220                              <3>  %substr %$c %1 %$i+1,1
   221                              <3>  dw %$c
   222                              <3>  %assign %$i %$i+1
   223                              <3>  %endrep
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000327E 4E00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003280 4100                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003282 5300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003284 4D00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003286 2000                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003288 5000                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000328A 4500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000328C 3600                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000328E 3400                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003290 2000                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003292 4700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003294 5500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003296 4900                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 00003298 2000                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000329A 7700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000329C 6900                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 0000329E 7400                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032A0 6800                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032A2 6F00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032A4 7500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032A6 7400                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032A8 2000                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032AA 4C00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032AC 6900                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032AE 6E00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032B0 6B00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032B2 6500                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032B4 7200                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   224                              <3>  %elifnum %1
   225                              <3>  dw %1
   226                              <3>  %else
   227                              <3>  dw %1
   228                              <3>  %endif
   229                              <3>  %rotate 1
   231                              <2> 
   232 000032B6 0000                <2>  dw 0
   233                              <2> 
   234                              <2> _WSTR_END:
   235                              <2> _WSTR_LENB equ (_WSTR_END - _WSTR_LBL - 2)
   236                              <2> _WSTR_LENW equ (_WSTR_LENB/2)
   237                              <2> 
   238                              <2> 
   239                              <2>  %undef _WSTR_LBL
   240                              <2>  %undef _WSTR_END
   241                              <2>  %undef _WSTR_LENB
   242                              <2>  %undef _WSTR_LENW
   243                              <2>  %pop
    20                              <1> WSTR winclassW      , 'NasmWndClass'
   202                              <2>  %push WSTR
   203                              <2> 
   204                              <2> 
   205                              <2>  %define _WSTR_LBL _cW_%1
   206                              <2>  %define _WSTR_END _cW_%1_end
   207                              <2>  %define _WSTR_LENB _cW_%1_length_bytes
   208                              <2>  %define _WSTR_LENW _cW_%1_length_words
   209                              <2> 
   210                              <2> _WSTR_LBL:
   211                              <2> 
   212                              <2>  %assign %$nargs %0-1
   213                              <2>  %rotate 1
   214                              <2> 
   215                              <2>  %rep %$nargs
   216                              <2>  %ifstr %1
   217                              <2>  %strlen %$n %1
   218                              <2>  %assign %$i 0
   219                              <2>  %rep %$n
   220                              <2>  %substr %$c %1 %$i+1,1
   221                              <2>  dw %$c
   222                              <2>  %assign %$i %$i+1
   223                              <2>  %endrep
   224                              <2>  %elifnum %1
   225                              <2>  dw %1
   226                              <2>  %else
   227                              <2>  dw %1
   228                              <2>  %endif
   229                              <2>  %rotate 1
   230                              <2>  %endrep
   216                              <3>  %ifstr %1
   217                              <3>  %strlen %$n %1
   218                              <3>  %assign %$i 0
   219                              <3>  %rep %$n
   220                              <3>  %substr %$c %1 %$i+1,1
   221                              <3>  dw %$c
   222                              <3>  %assign %$i %$i+1
   223                              <3>  %endrep
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032B8 4E00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032BA 6100                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032BC 7300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032BE 6D00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032C0 5700                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032C2 6E00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032C4 6400                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032C6 4300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032C8 6C00                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032CA 6100                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032CC 7300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   220                              <4>  %substr %$c %1 %$i+1,1
   221 000032CE 7300                <4>  dw %$c
   222                              <4>  %assign %$i %$i+1
   224                              <3>  %elifnum %1
   225                              <3>  dw %1
   226                              <3>  %else
   227                              <3>  dw %1
   228                              <3>  %endif
   229                              <3>  %rotate 1
   231                              <2> 
   232 000032D0 0000                <2>  dw 0
   233                              <2> 
   234                              <2> _WSTR_END:
   235                              <2> _WSTR_LENB equ (_WSTR_END - _WSTR_LBL - 2)
   236                              <2> _WSTR_LENW equ (_WSTR_LENB/2)
   237                              <2> 
   238                              <2> 
   239                              <2>  %undef _WSTR_LBL
   240                              <2>  %undef _WSTR_END
   241                              <2>  %undef _WSTR_LENB
   242                              <2>  %undef _WSTR_LENW
   243                              <2>  %pop
    21                              <1> 
    22                              <1> ASTR prompt         , "Eingabe: ",0
   375 000032D2 45696E676162653A20- <2> _cA_%1: db %2, 0
   375 000032DB 0000                <2>
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    23                              <1> ; -----------------------------------------------------------------------------
    24                              <1> ; Setze: Reset, Cursor Home, Farbe (helles Cyan auf blau), löschen, wieder Home
    25                              <1> ;  - ESC[0m       -> Attribute reset
    26                              <1> ;  - ESC[48;5;4m  -> Hintergrund Blau (xterm 256)
    27                              <1> ;  - ESC[38;5;14m -> Vordergrund Hell-Cyan
    28                              <1> ;  - ESC[2J       -> Bildschirm löschen (mit Spaces + aktuellen Attributen)
    29                              <1> ;  - ESC[H        -> Cursor 1;1
    30                              <1> ; -----------------------------------------------------------------------------
    31                              <1> ASTR consoleColor_0,  27,'[0m'
   375 000032DD 1B5B306D00          <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    32                              <1> ASTR consoleColor_1,  27,'[1;'
   375 000032E2 1B5B313B00          <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    33                              <1> ASTR consoleColor_2,  "m"
   375 000032E7 6D00                <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    34                              <1> ASTR consoleColor_3,  27,'[H',27,'[2J',27,'[H'
   375 000032E9 1B5B481B5B324A1B5B- <2> _cA_%1: db %2, 0
   375 000032F2 4800                <2>
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    35                              <1> ASTR buffer_semi, ";"
   375 000032F4 3B00                <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    36                              <1> ; -----------------------------------------------------------------------------
    37                              <1> ; DOS ANSI foreground color's   0..15
    38                              <1> ; -----------------------------------------------------------------------------
    39                              <1> ASTR console_color_30 , "30"
   375 000032F6 333000              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    40                              <1> ASTR console_color_31 , "31"
   375 000032F9 333100              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    41                              <1> ASTR console_color_32 , "32"
   375 000032FC 333200              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    42                              <1> ASTR console_color_33 , "33"
   375 000032FF 333300              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    43                              <1> ASTR console_color_34 , "34"
   375 00003302 333400              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    44                              <1> ASTR console_color_35 , "35"
   375 00003305 333500              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    45                              <1> ASTR console_color_36 , "36"
   375 00003308 333600              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    46                              <1> ASTR console_color_37 , "37"
   375 0000330B 333700              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    47                              <1> ; -----------------------------------------------------------------------------
    48                              <1> ASTR console_color_90 , "90"
   375 0000330E 393000              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    49                              <1> ASTR console_color_91 , "91"
   375 00003311 393100              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    50                              <1> ASTR console_color_92 , "92"
   375 00003314 393200              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    51                              <1> ASTR console_color_93 , "93"
   375 00003317 393300              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    52                              <1> ASTR console_color_94 , "94"
   375 0000331A 393400              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    53                              <1> ASTR console_color_95 , "95"
   375 0000331D 393500              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    54                              <1> ASTR console_color_96 , "96"
   375 00003320 393600              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    55                              <1> ASTR console_color_97 , "97"
   375 00003323 393700              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    56                              <1> 
    57                              <1> ; -----------------------------------------------------------------------------
    58                              <1> ; DOS ANSI background color's   0..15
    59                              <1> ; -----------------------------------------------------------------------------
    60                              <1> ASTR console_color_40 , "40"
   375 00003326 343000              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    61                              <1> ASTR console_color_41 , "41"
   375 00003329 343100              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    62                              <1> ASTR console_color_42 , "42"
   375 0000332C 343200              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    63                              <1> ASTR console_color_43 , "43"
   375 0000332F 343300              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    64                              <1> ASTR console_color_44 , "44"
   375 00003332 343400              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    65                              <1> ASTR console_color_45 , "45"
   375 00003335 343500              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    66                              <1> ASTR console_color_46 , "46"
   375 00003338 343600              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    67                              <1> ASTR console_color_47 , "47"
   375 0000333B 343700              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    68                              <1> 
    69                              <1> ASTR console_color_100, "100"
   375 0000333E 31303000            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    70                              <1> ASTR console_color_101, "101"
   375 00003342 31303100            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    71                              <1> ASTR console_color_102, "102"
   375 00003346 31303200            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    72                              <1> ASTR console_color_103, "103"
   375 0000334A 31303300            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    73                              <1> ASTR console_color_104, "104"
   375 0000334E 31303400            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    74                              <1> ASTR console_color_105, "105"
   375 00003352 31303500            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    75                              <1> ASTR console_color_106, "106"
   375 00003356 31303600            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    76                              <1> ASTR console_color_107, "107"
   375 0000335A 31303700            <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    77                              <1> 
    78 0000335E 000000004F001800    <1> Rect80x25:          dw 0, 0, 79, 24         ; SMALL_RECT {Left,Top,Right,Bottom} = {0,0,79,24}
    79 00003366 0000000000000000    <1> pMsg:               dq 0                    ; LPWSTR, wird von FormatMessageW allokiert
    80 0000336E 6F                  <1> spaceW:             db 'o'                  ; wide char ' '
    81                              <1> 
    82                              <1> ; -----------------------------------------------------------------------------
    83                              <1> ; default console values ...
    84                              <1> ; -----------------------------------------------------------------------------
    85 0000336F 2800                <1> _cA_console_bg:     db ATTR_BG_BLACK, 0
    86 00003371 5D00                <1> _cA_console_fg:     db ATTR_FG_LIGHT_YELLOW, 0
    87                              <1> 
    88 00003373 257300              <1> _fmt: db "%s", 0
    89                              <1> 
    90                              <1> ASTR buffer , ATTR_BG_BLACK, ATTR_FG_LIGHT_YELLOW
   375 00003376 285D00              <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    91                              <1> ASTR buffer2, " oI_01", 0
   375 00003379 206F495F30310000    <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    92                              <1> 
    93                              <1> ASTR buffer_2, "moin", 0
   375 00003381 6D6F696E0000        <2> _cA_%1: db %2, 0
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    94                              <1> ASTR buffer_1, "Hello %s", 0
   375 00003387 48656C6C6F20257300- <2> _cA_%1: db %2, 0
   375 00003390 00                  <2>
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    95                              <1> ASTR buffer_3, " smile"  , 13, 10, 0
   375 00003391 20736D696C650D0A00- <2> _cA_%1: db %2, 0
   375 0000339A 00                  <2>
   376                              <2> _cA_%1_end:
   377                              <2> _cA_%1_length equ (_cA_%1_end - _cA_%1 - 1)
    96                              <1> 
    97                              <1> data_end:
    98 0000339B 00<rep 65h>         <1> times (ALIGN_UP($-$$,FILEALIGN)-($-$$)) db 0
    35                                  
    36                                  section .bss
    37                                  %include 'bss64.asm'
     1                              <1> ; -----------------------------------------------------------------------------
     2                              <1> ; \file  bss64.asm
     3                              <1> ; \note  (c) 2025 by Jens Kallup - paule32
     4                              <1> ;        all rights reserved.
     5                              <1> ;
     6                              <1> ; \desc  Create a dBASE MS-Windows 11 64-bit Pro EXE.
     7                              <1> ; -----------------------------------------------------------------------------
     8                              <1> 
     9                              <1> bss_start:
    10                              <1> 
    11                              <1> ; -----------------------------------------------------------------------------
    12                              <1> ; Strukturen (kompakt modelliert)
    13                              <1> ; -----------------------------------------------------------------------------
    14                              <1> struc COORD
    15 00000000 ????                <1>     .X                  resw 1
    16 00000002 ????                <1>     .Y                  resw 1
    17                              <1> endstruc
    18                              <1> 
    19                              <1> struc SMALL_RECT
    20 00000000 ????                <1>     .Left               resw 1
    21 00000002 ????                <1>     .Top                resw 1
    22 00000004 ????                <1>     .Right              resw 1
    23 00000006 ????                <1>     .Bot                resw 1
    24                              <1> endstruc
    25                              <1> 
    26                              <1> ; -----------------------------------------------------------------------------
    27                              <1> ; CONSOLE_SCREEN_BUFFER_INFO (Layout wie in WinSDK; 22 Bytes + Padding)
    28                              <1> ; -----------------------------------------------------------------------------
    29                              <1> struc CSBI
    30 00000000 ????????            <1>     .dwSize             resw 2      ; COORD
    31 00000004 ????????            <1>     .dwCursorPos        resw 2      ; COORD
    32 00000008 ????                <1>     .wAttributes        resw 1
    33 0000000A ????????????????    <1>     .srWindow           resw 4      ; SMALL_RECT
    34 00000012 ????????            <1>     .dwMaxWindowSize    resw 2      ; COORD
    35 00000016 ????                <1>     ._pad               resw 1      ; pad to 24 bytes (alignment)
    36                              <1> endstruc
    37                              <1> ; -----------------------------------------------------------------------------
    38 00000000 <res 18h>           <1> csbi:               resb CSBI_size
    39                              <1> 
    40 00000018 <res 80h>           <1> _cA_buffer_dst:     resb 128
    41                              <1> 
    42 00000098 <res 80h>           <1> _cA_buffer_A:       resb 128
    43 00000118 <res 80h>           <1> _cA_buffer_B:       resb 128
    44                              <1> 
    45                              <1> ;_cA_src_length:     resb 256
    46                              <1> ;_cA_dst_length:     resb 512
    47                              <1> 
    48 00000198 <res 80h>           <1> _cA_src:            resb 128
    49 00000218 <res 80h>           <1> _cA_dst:            resb 128
    50                              <1> 
    51 00000298 ????????            <1> mode_in:            resd 1
    52 0000029C ????????            <1> mode_out:           resd 1
    53                              <1> ; -----------------------------------------------------------------------------
    54 000002A0 ??                  <1> _cA_empty:          resb 1
    55                              <1> 
    56 000002A1 <res 40h>           <1> _cA_buf:            resb 64
    57                              <1> 
    58 000002E1 ????????????????    <1> hIn:                resq 1
    59 000002E9 ????????????????    <1> hOut:               resq 1
    60 000002F1 ????????            <1> read:               resd 1
    61 000002F5 ????????            <1> tmpConsoleMode:     resd 1
    62 000002F9 ????????            <1> last_error:         resd 1
    63                              <1> 
    64 000002FD ????????????????    <1> written:            resq 1
    65                              <1> bss_end:
    66                              <1> 
    38                                  
    39                                  ; -----------------------------------------------------------------------------
    40                                  section .text
    41                                  file_end:
